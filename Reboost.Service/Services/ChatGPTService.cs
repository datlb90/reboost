using Microsoft.Extensions.Configuration;
using Reboost.DataAccess;
using Reboost.DataAccess.Entities;
using Reboost.DataAccess.Models;
using Reboost.Shared;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Reboost.Shared.Extensions;
using Stripe;
using System.Net.Http;
using OpenAI_API.Completions;
using OpenAI_API;
using OpenAI_API.Chat;
using OpenAI_API.Models;
using Newtonsoft.Json;
using System.Text.RegularExpressions;
using PayPal.Api;

namespace Reboost.Service.Services
{
    public interface IChatGPTService
    {
        Task GetDifficultyLevelForAllQuestions();
        Task<NewTOEFLEssayFeedbackModel> GetTOEFLIndependentEssayFeedback(string question, string essay, string feedbackLanguage);
        Task<NewTOEFLEssayFeedbackModel> GetTOEFLIntegratedEssayFeedback(string question, string essay, string feedbackLanguage);
        Task<NewIELTSEssayFeedbackModel> GetIELTSEssayFeedback(string question, string essay, string feedbackLanguage);
    }

    public class ChatGPTService : BaseService, IChatGPTService
    {
        private string OPENAI_API_KEY = "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"; // "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";
        IConfiguration configuration;
        public ChatGPTService(IUnitOfWork unitOfWork,
            IConfiguration _configuration) : base(unitOfWork)
        {
           
            configuration = _configuration;
        }

        public static string StripHTML(string input)
        {
            return Regex.Replace(input, "<.*?>", String.Empty);
        }

        public async Task GetDifficultyLevelForAllQuestions()
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string task1Criteria = "You will be given a IELTS academic writing task 1 topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\n•\tEasy: Topics are common, widely recognized, and relatable to the general public. Specialized knowledge is not required, and test takers can generate ideas just by critical thinking about the topic. \n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential. Data or processes may include some unfamiliar elements but are generally accessible.\n•\tHard: Topics may be quite specialized or technical. Often includes data, or processes that are not commonly encountered in everyday contexts.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string task2Criteria = "You will be given a IELTS academic writing task 2 topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\n•\tEasy: Topics are common, widely recognized, and relatable to the general public. Specialized knowledge is not required, and test takers can readily generate ideas and examples from their personal experiences or common knowledge.\n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential. More critical thinking is needed to develop coherent arguments and counterarguments.\n•\tHard: Topics are specialized or abstract, demanding in-depth knowledge or a deep understanding. These subjects often involve complex concepts, technical details, or nuanced perspectives that go beyond general knowledge.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string independentCriteria = "You will be given a TOEFL independent writing topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\nFamiliarity:\n•\tEasy: Topics are very common and frequently encountered in everyday life. These subjects require minimal specialized knowledge and are broadly relatable.\n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential.\n•\tHard: Topics are specialized or abstract, demanding in-depth knowledge or a deep understanding. These subjects often involve complex concepts, technical details, or nuanced perspectives that go beyond general knowledge.\n\nSimplicity:\n•\tEasy: Questions are straightforward, typically asking for a personal preference or opinion. Easier to organize thoughts and structure the essay into introduction, body paragraphs, and conclusion.\n•\tMedium: Questions may involve a bit more complexity, such as comparing two viewpoints or analyzing a trend. Requires more developed skills in structuring arguments and supporting them with reasons and examples.\n•\tHard: Questions are more complex and might involve abstract thinking or sophisticated arguments. High level of planning, organization, and critical thinking is needed to construct a coherent and persuasive essay.\n\nLanguage Demand:\n•\tEasy: Basic vocabulary and simple grammatical structures are often sufficient. The focus is on clear and coherent expression of personal opinions and experiences.\n•\tMedium: Requires a mix of basic and advanced vocabulary and varied sentence structures. The ability to articulate and support slightly complex ideas is important.\n•\tHard: High proficiency in language use is required, with a wide range of vocabulary and complex sentence structures. The ability to express and justify complex ideas and arguments clearly and effectively is crucial.\n\nResource Availability:\n•\tEasy: There are abundant study materials, sample essays, and practice prompts available. It's relatively easy to find model essays and guidelines for these common topics.\n•\tMedium: A fair amount of practice materials and examples are available but might require more analytical skills. Candidates may need to seek specific examples or more detailed study guides.\n•\tHard: There are fewer ready-made resources and sample essays at this level. Extensive reading and research might be needed to effectively tackle these topics.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string integratedCriteria = "You will be given a TOEFL integrated writing topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\nFamiliarity:\n•\tEasy: Topics are very common and frequently encountered in everyday life. These subjects require minimal specialized knowledge and are broadly relatable. Information presented in both the reading and the listening is straightforward and clear.\n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential. Information may have more depth compared to the easy level, requiring attentive reading, and listening.\n•\tHard: Topics are specialized or abstract, demanding in-depth knowledge or a deep understanding. Both the reading and listening passages contain dense and intricate information.\n\nSimplicity:\n•\tEasy: The relationship between the reading and listening materials is relatively clear and direct. Easier to identify the main points and how they either contrast with or support each other.\n•\tMedium: The connections between the reading and listening materials might be less direct, with more subtle points of comparison or contrast. Requires more critical thinking to identify and articulate the key relationships.\n•\tHard: Relationships between the reading and listening materials are complex, often involving nuanced arguments or detailed analysis. High level of skill in organizing, integrating, and presenting information coherently and concisely is needed.\n\nLanguage Demand:\n•\tEasy: Requires basic vocabulary and simple sentence structures for summarizing and comparing information. Focus is more on accuracy in conveying information than on using complex language.\n•\tMedium: Requires a balance of basic and more advanced vocabulary, along with varied sentence structures. Ability to express relationships between more complex ideas and details is important.\n•\tHard: High proficiency in language use is required, with a wide range of vocabulary and complex sentence structures. The ability to synthesize and analyze intricate details and viewpoints is crucial.\n\nResource Availability:\n•\tEasy: Plenty of practice materials and sample responses are available, including texts and lectures on familiar topics. Easy to find resources that demonstrate how to integrate and summarize key points.\n•\tMedium: A fair amount of practice materials are available but may require more analytical skills to dissect. Might need to seek specific examples or more detailed guides on notetaking and synthesis.\n•\tHard: Fewer ready-made resources and model responses are available at this higher level of complexity. Requires extensive research and practice with advanced materials to develop proficiency.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string criteria = task2Criteria;

            var questions = await _unitOfWork.Questions.GetAllActiveQuestions();

            foreach(Questions question in questions)
            {
                QuestionParts questionContent = await _unitOfWork.QuestionParts.GetQuestionContentById(question.Id);
                if(questionContent != null)
                {
                    string content = ""; // StripHTML(questionContent.Content);
                    Tasks questionTask = await _unitOfWork.Questions.GetTaksById(question.TaskId);
                    string task = questionTask.Name;

                    if (task == "Independent Writing")
                    {
                        criteria = independentCriteria;
                        content = "Classify the difficulty level of the following TOEFL independent writing topic: " + StripHTML(questionContent.Content) + "";
                    }
                    else if (task == "Integrated Writing")
                    {
                        criteria = integratedCriteria;
                        string reading = "";
                        QuestionParts readingPart = await _unitOfWork.QuestionParts.GetReadingByQuestionId(question.Id);
                        if (readingPart != null)
                            reading = StripHTML(readingPart.Content);

                        string transcript = "";
                        QuestionParts transcriptPart = await _unitOfWork.QuestionParts.GetTranscriptByQuestionId(question.Id);
                        if (transcriptPart != null)
                            transcript = StripHTML(transcriptPart.Content);

                        content = "Classify the difficulty level of the following TOEFL integrated writing topic: \nQuesiton: " + StripHTML(questionContent.Content) + "\nReading: " + reading + "\nListening Transcript: " + transcript + "";

                    }
                    else if (task == "Academic Writing Task 1")
                    {
                        criteria = task1Criteria;
                        content = "Classify the difficulty level of the following IELTS academic writing task 1 topic: " + StripHTML(questionContent.Content) + "";
                    }
                    else
                    {
                        criteria = task2Criteria;
                        content = "Classify the difficulty level of the following IELTS academic writing task 2 topic: " + StripHTML(questionContent.Content) + "";
                    }
                    string difficulty = "Medium";
                    ChatMessage prerequisite = new ChatMessage(ChatMessageRole.User, criteria);
                    ChatMessage request = new ChatMessage(ChatMessageRole.User, content);
                    List<ChatMessage> messages = new List<ChatMessage>();
                    messages.Add(prerequisite);
                    messages.Add(request);

                    var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                    {
                        Model = Model.GPT4_Turbo,
                        Temperature = 0.1,
                        MaxTokens = 2000,
                        ResponseFormat = ChatRequest.ResponseFormats.Text,
                        Messages = messages

                    });;

                    difficulty = result.Choices[0].Message.TextContent;
                    question.Difficulty = difficulty;
                    question.LastActivityDate = DateTime.UtcNow;
                    await _unitOfWork.Questions.Update(question);
                }
                
            }
           
        }

        public async Task<NewTOEFLEssayFeedbackModel> GetTOEFLIndependentEssayFeedback(string question, string essay, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string independentRubric = "Given the following rubric descriptors for the TOEFL Independent Writing delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Language Use\n1.1. Criteria Description\nThe Language Use criterion for the TOEFL Independent Writing task evaluates your ability to use English accurately and effectively in an academic context. This criterion focuses on your grammatical accuracy, range of vocabulary, and overall fluency and clarity in expressing ideas.\n\n1.2. Band Descriptors\n-Band 0: The essay does not address the topic, is written in a foreign language, is copied, is off-topic, or is blank.\n\n- Band 1: Vocabulary: Shows very limited control of vocabulary. Incorrect word choice and errors in word form are frequent, severely impeding communication; Grammar: Displays fundamental errors in grammatical structures. Errors are so prevalent that they largely prevent understanding of the text; Clarity and Fluency: Writing is generally incoherent, with little to no evidence of ability to organize or express ideas clearly.\n\n- Band 2: Vocabulary: Displays limited vocabulary range, word choice is often basic and sometimes inappropriate, leading to confusion and ambiguity; Grammar: Frequent grammatical errors significantly hinder clarity. Simple grammatical structures may be used correctly, but more complex structures are often misused; Clarity and Fluency: Writing may be difficult to understand due to pervasive errors in vocabulary and grammar. Attempts at complex ideas are poorly executed, leading to unclear or incoherent expression.\n\n- Band 3: Vocabulary: Demonstrates an adequate range of vocabulary for the task, however, misuse of words and noticeable gaps in vocabulary may be evident; Grammar: Shows a mix of accurate and inaccurate use of grammatical structures. Errors are frequent enough to make some sentences unclear; Clarity and Fluency: Writing is generally clear, but problems with fluency and word choice may obscure meaning in some instances.\n\n- Band 4: Vocabulary: Uses a range of vocabulary effectively, though may display some lack of precision. Idiomatic expressions are generally used correctly; Grammar: Exhibits control over grammatical structures, though some errors may occur. These errors rarely reduce clarity; Clarity and Fluency: Overall, the writing is coherent and can be understood without effort, but it may lack the polish and smoothness of a higher-scoring essay.\n\n- Band 5: Vocabulary: Demonstrates a strong command of vocabulary and idiomatic expressions. Rare minor errors do not detract from the overall communication; Grammar: Shows effective use of varied grammatical structures. Any grammatical errors are minor and infrequent, not interfering with comprehension; Clarity and Fluency: The writing is clear and fluid. Complex ideas are expressed elegantly and are easily understood by the reader.\n\n2. Organization\n2.1. Criteria Description\nThe Organization criterion for the TOEFL Independent Writing task assesses how well you can structure and present your ideas in a clear, logical manner. This involves the overall structure of your essay, including the introduction, body paragraphs, and conclusion, as well as the coherence and transition between ideas within and across paragraphs.\n\n2.2. Band Descriptors\n- Band 0: The essay does not address the topic, is written in a foreign language, is copied, is off-topic, or is blank.\n\n- Band 1: Overall Structure: The essay lacks a coherent structure, with no clear distinction between introduction, body, and conclusion. The organization is so poor that it significantly impedes understanding; Coherence and Cohesion: There is little to no use of transitional phrases or sentences, leading to a very disjointed and incoherent flow of ideas. Paragraphs, if present, are poorly formed and lack cohesion; Unity: The essay fails to maintain focus, with most of the content irrelevant to the thesis or main topic.\n\n- Band 2: Overall Structure: The essay’s structure is unclear or inconsistent, making it difficult to identify the introduction, body, and conclusion. The organization is poor, making it hard to follow the progression of ideas; Coherence and Cohesion: Transitions between ideas are minimal or ineffective, leading to a disjointed or confusing arrangement of ideas. Paragraphs may not be well-defined, with ideas blending into one another without clear separation; Unity: Many paragraphs may lack a clear main idea or stray significantly from the thesis. The essay may contain much irrelevant information.\n\n- Band 3: Overall Structure: The essay has an identifiable structure, but the organization may be flawed or simplistic. The introduction, body paragraphs, and conclusion are present but may not be fully developed or clear; Coherence and Cohesion: Attempts to use transitions are evident, but they may be misused or repetitive, leading to some confusion or disjointedness in the flow of ideas; Unity: Some paragraphs may lack clear focus or deviate from supporting the thesis. The essay may include irrelevant information that detracts from the overall argument.\n\n- Band 4: Overall Structure: The essay is generally well-organized with a clear introduction, body, and conclusion. The structure may be less innovative or slightly unclear at times, but it does not significantly hinder comprehension; Coherence and Cohesion: Uses transitional phrases and sentences effectively, though some transitions may be mechanical or less varied. There may be minor issues with flow or clarity, but they do not significantly disrupt the reading experience; Unity: Paragraphs are generally focused, but one or two may contain some extraneous information or not be as well-developed.\n\n- Band 5: Overall Structure: The essay has a clear, logical structure that is easy to follow. The introduction effectively sets up the topic and thesis statement, body paragraphs are well-developed and focused on separate ideas that support the thesis, and the conclusion effectively summarizes the essay or restates its main points; Coherence and Cohesion: Uses effective transitional phrases and sentences to link ideas within paragraphs and between them, ensuring smooth flow of ideas. Paragraphs are clearly delineated, and each serves a distinct purpose in the argument or narrative; Unity: Each paragraph has a clear main idea that supports the thesis, with no irrelevant or off-topic information.\n\n3. Development and Support\n3.1. Criteria Description\nThe Development and Support criterion for the TOEFL Independent Writing task evaluates how well you can develop your ideas and support them with details and examples. This criterion assesses the effectiveness of your argumentation or explanation, the relevance and persuasiveness of your supporting details, and how well you integrate these elements to make a coherent argument or narrative.\n\n3.2. Band Descriptors\n- Band 0: The essay does not address the topic, is written in a foreign language, is copied, is off-topic, or is blank.\n\n- Band 1: Idea Development: Ideas are poorly developed or barely addressed. There is a significant lack of supporting detail, making arguments or narratives difficult to understand or follow; Supporting Details: Lacks relevant or coherent supporting examples and details. Any attempt to support ideas is vague, incorrect, or irrelevant; Complexity and Depth: Demonstrates a lack of thought and understanding of the topic. There is no complexity, with ideas presented in a disjointed or incoherent manner.\n\n- Band 2: Idea Development: Ideas are underdeveloped and lack detailed support. Arguments or explanations are incomplete or superficial, making them unconvincing; Supporting Details: Provides few details or examples, which are often irrelevant or overly simplistic. Struggles to connect supporting details effectively to main ideas; Complexity and Depth: Shows minimal complexity or depth of thought. The essay tends to be simplistic and one-dimensional, with no consideration of counterarguments or alternative perspectives.\n\n- Band 3: Idea Development: Ideas are somewhat developed but may not be fully elaborated. Support for arguments or explanations is present but not always convincing or thoroughly explained; Supporting Details: Uses examples and reasons to support ideas, but these may be too general, simplistic, or partially relevant. The connection between support and the main ideas may not always be clear; Complexity and Depth: Demonstrates basic thought and a straightforward approach to the topic. Lacks significant complexity, with little to no acknowledgement of counterarguments or alternative perspectives.\n\n- Band 4: Idea Development: Ideas are generally well-developed and supported. Arguments or explanations are clear and make sense but may lack the depth or insight of the highest-scoring essays; Supporting Details: Provides clear and relevant examples and reasons to support main ideas. The integration of these details is mostly effective, though some may be more generic or less fully explored; Complexity and Depth: Shows a good level of thought and complexity. Counterarguments or alternative perspectives may be mentioned but are not explored in depth.\n\n- Band 5: Idea Development: Ideas are fully developed and thoroughly supported. Arguments or narratives are detailed, insightful, and demonstrate a deep understanding of the topic; Supporting Details: Uses specific, relevant examples and reasons to support ideas. These details are integrated seamlessly into the argument or explanation, enhancing the persuasive or explanatory power of the essay; Complexity and Depth: Demonstrates sophisticated thought and complexity in argumentation or narrative. Counterarguments or alternative perspectives may be acknowledged and addressed, adding depth to the essay.\n</rubric>\n";
            string prompt = "For the following TOEFL Independent Writing topic delimited by <topic> and </topic> tags:\n\n<topic>\n"+ question + "\n</topic>\n\nProvide feedback on Language Use (code: langUse), Organization (code: organization), Development and Support (code: devSupport) criteria for the following essay delimited by <essay> and </essay> tags:\n\n<essay>\n " + essay + "\n</essay>\n\nReturn JSON of a list of objects with criteria code as object name. Each object has 2 properties which are comment and score. The comment property contains the essay feedback for the criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the criteria based on the band descriptors. \n\nAdd an overallFeedback object to the JSON list that also has the comment and score properties. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement.\n\nAlso, add a list of objects called errors to the JSON. Each object in this list has 3 properties which are: issue, type, and fix. The issue property captures a word or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of that error. The fix property contains the fix for that error. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version. The feedback must be written in Vietnamese, except for the list of errors.\n";
            if (feedbackLanguage != "vn")
                prompt = "For the following TOEFL Independent Writing topic delimited by <topic> and </topic> tags:\\n\\n<topic>\\n\"+ question + \"\\n</topic>\\n\\nProvide feedback on Language Use (code: langUse), Organization (code: organization), Development and Support (code: devSupport) criteria for the following essay delimited by <essay> and </essay> tags:\\n\\n<essay>\\n \" + essay + \"\\n</essay>\\n\\nReturn JSON of a list of objects with criteria code as object name. Each object has 2 properties which are comment and score. The comment property contains the essay feedback for the criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the criteria based on the band descriptors. \\n\\nAdd an overallFeedback object to the JSON list that also has the comment and score properties. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement.\\n\\nAlso, add a list of objects called errors to the JSON. Each object in this list has 3 properties which are: issue, type, and fix. The issue property captures a word or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of that error. The fix property contains the fix for that error. The errors list contains at most 5 objects.\\n\\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version.\n";

            var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
            {
                Model = Model.GPT4_Turbo,
                Temperature = 0.1,
                MaxTokens = 2000,
                ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, independentRubric),
                    new ChatMessage(ChatMessageRole.User, prompt)
                }
            });
            Console.WriteLine(result);
            Console.WriteLine(result.Choices[0].Message.TextContent);
            //return result.Choices[0].Message.TextContent;
            NewTOEFLEssayFeedbackModel feedback = JsonConvert.DeserializeObject<NewTOEFLEssayFeedbackModel>(result.Choices[0].Message.TextContent);
            return feedback;
        }
        public async Task<NewTOEFLEssayFeedbackModel> GetTOEFLIntegratedEssayFeedback(string question, string essay, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string integratedRubric = "Given the following rubric descriptors for the TOEFL Integrated Writing delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Language Use\n1.1. Criteria Description\nThe Language Use criterion for the TOEFL Integrated Writing task assesses your ability to effectively use English to summarize and synthesize information from reading and listening materials. This involves evaluating your grammar, vocabulary, and overall ability to express ideas clearly and cohesively in writing.\n\n1.2. Band Descriptors\n-Band 0: The response is off-topic, written in a language other than English, merely copies large portions of the text without synthesizing, or is left blank.\n\n- Band 1: Vocabulary: Shows very limited vocabulary. Frequent errors in word choice and form severely impede communication. Lacks academic language and appropriate idiomatic expressions; Grammar: Shows very little or no control over grammatical structures. Errors are pervasive and greatly hinder comprehension; Cohesion and Coherence: Lacks coherent and cohesive writing. Ideas are disjointed, and the summary is extremely difficult to follow due to the poor use of language and lack of logical connection between ideas.\n\n- Band 2: Vocabulary: Exhibits limited vocabulary range, with frequent inappropriate word choices and errors that often hinder comprehension. Struggles to use academic language effectively; Grammar: Limited control over grammatical structures, with pervasive errors that frequently obscure meaning. Reliance on overly simple sentence structures; Cohesion and Coherence: Demonstrates limited ability to connect ideas cohesively. Poor use of cohesive devices and unclear expression of ideas make the summary difficult to follow.\n\n- Band 3: Vocabulary: Demonstrates an adequate range of vocabulary for summarizing content, but misuse of vocabulary and noticeable gaps in lexical resources may occasionally hinder comprehension. Limited use of academic language and idiomatic expressions; Grammar: Displays fair grammatical control. Simple and some complex sentence structures are used, but with frequent errors that may sometimes impede understanding; Cohesion and Coherence: Uses some cohesive devices, but their misuse or overuse may lead to some lack of clarity. Ideas are expressed with some coherence, though the summary may be harder to follow in places.\n\n- Band 4: Vocabulary: Uses a range of vocabulary effectively but may have minor errors or less precision in word choice that do not significantly hinder communication. Good use of academic language and some idiomatic expressions; Grammar: Shows good grammatical control. Uses a variety of sentence structures with some errors, but these errors do not significantly obscure meaning; Cohesion and Coherence: The response is cohesive and demonstrates effective use of cohesive devices. Ideas are generally expressed clearly, though there may be occasional lapses in coherence that do not majorly affect readability.\n\n- Band 5: Vocabulary: Demonstrates a strong command of vocabulary and the ability to use precise and appropriate language to convey ideas effectively. Utilizes a wide range of academic vocabulary and idiomatic expressions correctly; Grammar: Exhibits excellent grammatical control. Varieties of sentence structures are used effectively and flexibly. Grammatical mistakes are rare and do not impede understanding; Cohesion and Coherence: The response is highly cohesive and demonstrates skillful use of cohesive devices (e.g., conjunctions, reference words, transitions). Ideas are expressed clearly and coherently, making the summary easy to follow.\n\n2. Organization\n2.1. Criteria Description\nThe Organization criterion for the TOEFL Integrated Writing task evaluates how effectively you organize and present information from the reading and listening materials in your written response. This criterion focuses on the overall structure of your response, the clarity of your summarization, and how well you link ideas from both sources.\n\n2.2. Band Descriptors\n- Band 0: The response does not address the task, is off-topic, written in a language other than English, merely copies large portions of the text without organization, or is left blank.\n\n- Band 1: Overall Structure: Lacks coherent structure, with no clear distinction between the summary of the reading and listening materials. The organization is poor, significantly impeding the reader’s understanding; Clarity of Summarization: Provides a very poor summary of the points, with significant inaccuracies and omissions. The reader is left to guess the main points and their sources; Linking Ideas: Demonstrates very little or no effective linking of ideas. The response is extremely difficult to follow, with ideas presented in a random or incoherent manner.\n\n- Band 2: Overall Structure: The response’s structure is unclear or inconsistent, making it difficult to distinguish the main points and their sources. The organization does not effectively convey the relationship between the reading and listening materials; Clarity of Summarization: Struggles to summarize the main points accurately or clearly. Information may be presented in a confused manner, making it hard for the reader to understand the relationship between the sources; Linking Ideas: Limited or ineffective use of transitional phrases. The response may lack logical connections between ideas, leading to a disjointed presentation.\n\n- Band 3: Overall Structure: The response has an identifiable structure, but the organization may be simplistic or flawed in some areas. It attempts to organize the main points from the reading and listening, but the relationship between them may not always be clear; Clarity of Summarization: Attempts to summarize the main points, but may include inaccuracies, be incomplete, or somewhat unclear, requiring the reader to infer some relationships between points; Linking Ideas: Uses some transitional phrases and attempts to link ideas, but these may be misused or insufficient, leading to a somewhat disjointed or confusing presentation.\n\n- Band 4: Overall Structure: The response is well-organized with a clear structure that mostly effectively compares or contrasts the reading and listening points. The introduction, body, and possible conclusion are present and facilitate understanding; Clarity of Summarization: Summarizes the main points from the sources accurately, though there may be minor omissions or inaccuracies that do not significantly affect clarity; Linking Ideas: Generally uses transitions and organizational phrases effectively, though some connections between ideas may be less smooth or obvious.\n\n- Band 5: Overall Structure: The response has a clear, logical structure that effectively organizes information from both the reading and listening materials. An introduction sets up the topic, followed by body paragraphs that cohesively compare or contrast the points from the reading and listening, and a conclusion may summarize the key points; Clarity of Summarization: Summarizes information accurately and clearly, making it easy for the reader to identify the main points and how they relate to each other; Linking Ideas: Uses effective transitional phrases and sentences to link ideas within and between paragraphs, ensuring a smooth flow of information. Demonstrates a clear relationship between the reading and listening points.\n\n3. Content\n3.1. Criteria Description\nThe Content criterion for the TOEFL Integrated Writing task assesses your ability to convey information accurately and effectively from the reading and listening materials in your written response. This involves evaluating how well you summarize the key points and details from both sources and how effectively you integrate these points to present a coherent analysis or comparison.\n\n3.2. Band Descriptors\n- Band 0: The response does not address the task, is off-topic, written in a language other than English, merely copies large portions of the text without synthesizing, or is left blank.\n\n- Band 1: Accuracy: Contains numerous inaccuracies or misrepresentations of the reading and listening materials. Key points are either missing or inaccurately portrayed, significantly misleading the reader; Integration: Shows very poor or no integration of information from the reading and listening materials. Fails to establish a coherent relationship between the sources, making the response difficult to follow; Completeness: The response fails to adequately address the task, missing most of the required information and providing an incomplete or incorrect understanding of the topic.\n\n- Band 2: Accuracy: Struggles to accurately convey key points and details from the sources. Includes inaccuracies or omissions that significantly affect the reader's understanding of the topic; Integration: Demonstrates limited ability to integrate information from the reading and listening materials. Connections between the two sources are weak or unclear, leading to a fragmented or incomplete comparison or contrast; Completeness: The response partially addresses the task but omits significant information, leading to an incomplete or skewed understanding of the topic.\n\n- Band 3: Accuracy: Conveys some key points and details from the reading and listening materials but may include inaccuracies or omit important information. These issues may occasionally confuse or mislead the reader; Integration: Attempts to integrate information from both sources but may not always make clear or accurate connections. The relationship between the reading and listening materials is somewhat evident but not fully developed; Completeness: The response addresses the task but may leave out key aspects or details necessary for a full understanding of the topic.\n\n- Band 4: Accuracy: Accurately conveys most of the key points and important details from both sources. There may be minor inaccuracies or omissions, but these do not significantly impact the overall comprehension of the material; Integration: Effectively integrates information from both sources, making clear connections between the reading and listening materials. The comparison or contrast is clear but may lack some of the depth or insight of the highest-scoring essays; Completeness: The response covers most of the necessary information required by the task. Minor omissions do not significantly detract from the overall understanding of the topic.\n\n- Band 5: Accuracy: The response accurately conveys all the critical points and important details from both the reading and listening materials. Any minor inaccuracies do not change the overall understanding of the information; Integration: Demonstrates exceptional ability to synthesize and integrate information from the reading and listening materials. The relationship between the two sources is clear and well-explained, providing a thorough comparison or contrast as required; Completeness: The response is comprehensive, covering all necessary aspects of the task. It provides a full understanding of the topic without omitting significant information.\n</rubric>\n";
            string prompt = "For the following TOEFL Integrated Writing topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\nProvide feedback on Language Use (code: langUse), Organization (code: organization), and Content (code: content) criteria for the following essay delimited by <essay> and </essay> tags:\n\n<essay>\n " + essay + "\n</essay>\n\nReturn JSON of a list of objects with criteria code as object name. Each object has 2 properties which are comment and score. The comment property contains the essay feedback for the criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the criteria based on the band descriptors. \n\nAdd an overallFeedback object to the JSON list that also has the comment and score properties. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement.\n\nAlso, add a list of objects called errors to the JSON. Each object in this list has 3 properties which are: issue, type, and fix. The issue property captures a word or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of that error. The fix property contains the fix for that error. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version. The feedback must be written in Vietnamese, except for the list of errors.\n";
            if (feedbackLanguage != "vn")
                prompt = "For the following TOEFL Integrated Writing topic delimited by <topic> and </topic> tags:\\n\\n<topic>\\n\" + question + \"\\n</topic>\\n\\nProvide feedback on Language Use (code: langUse), Organization (code: organization), and Content (code: content) criteria for the following essay delimited by <essay> and </essay> tags:\\n\\n<essay>\\n \" + essay + \"\\n</essay>\\n\\nReturn JSON of a list of objects with criteria code as object name. Each object has 2 properties which are comment and score. The comment property contains the essay feedback for the criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the criteria based on the band descriptors. \\n\\nAdd an overallFeedback object to the JSON list that also has the comment and score properties. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement.\\n\\nAlso, add a list of objects called errors to the JSON. Each object in this list has 3 properties which are: issue, type, and fix. The issue property captures a word or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of that error. The fix property contains the fix for that error. The errors list contains at most 5 objects.\\n\\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version.\n";

            var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
            {
                Model = Model.GPT4_Turbo,
                Temperature = 0.1,
                MaxTokens = 2000,
                ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, integratedRubric),
                    new ChatMessage(ChatMessageRole.User, prompt)
                }
            });
            Console.WriteLine(result);
            Console.WriteLine(result.Choices[0].Message.TextContent);
            //return result.Choices[0].Message.TextContent;
            NewTOEFLEssayFeedbackModel feedback = JsonConvert.DeserializeObject<NewTOEFLEssayFeedbackModel>(result.Choices[0].Message.TextContent);
            return feedback;
        }

        public async Task<NewIELTSEssayFeedbackModel> GetFeedbackForTask1(string question, string essay, string filePath, string feedbackLanguage)
        {
            ChatMessage.ImageInput chart = ChatMessage.ImageInput.FromFile(filePath);

            return null;
        }

        public async Task<NewIELTSEssayFeedbackModel> GetIELTSEssayFeedback(string question, string essay, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            
            string prompt = "For the following  IELTS question:\n \n\"“" + question + "”\n\nProvide feedback on the following criteria: Task Achievement (code: taskAchievement); Coherence & Cohesion (code: coherence); Lexical Resource (code: lexicalResource); Grammatical Range & Accuracy (code: grammar); and Overall Feedback (code: overallFeedback), for the following essay: \n\n“" + essay + "”\n\nReturn JSON of a list of objects with criteria code as object name and comment and score as the object’s properties. Comment is the feedback given for the criteria. Score is the score given for the criteria rated on a scale from 0 to 9 with increments of 1.0.\nAlso, add an errors list to the JSON highlighting at most 10 errors including grammar, spelling, punctuation, or word choice. This is a list of objects that have 3 properties which are: issue, type, and fix. The issue property captures an issue in the essay. The type property is the type of the issue. The fix property provides a fix for the issue.\nTry not to exceed 4000 characters and do not include an explanation of the criteria or a revised version. The feedback must be written in Vietnamese.\n";
            if (feedbackLanguage != "vn")
                 prompt = "For the following  IELTS question:\n \n\"“" + question + "”\n\nProvide feedback on the following criteria: Task Achievement (code: taskAchievement); Coherence & Cohesion (code: coherence); Lexical Resource (code: lexicalResource); Grammatical Range & Accuracy (code: grammar); and Overall Feedback (code: overallFeedback), for the following essay: \n\n“" + essay + "”\n\nReturn JSON of a list of objects with criteria code as object name and comment and score as the object’s properties. Comment is the feedback given for the criteria. Score is the score given for the criteria rated on a scale from 0 to 9 with increments of 1.0.\nAlso, add an errors list to the JSON highlighting at most 10 errors including grammar, spelling, punctuation, or word choice. This is a list of objects that have 3 properties which are: issue, type, and fix. The issue property captures an issue in the essay. The type property is the type of the issue. The fix property provides a fix for the issue.\nTry not to exceed 4000 characters and do not include an explanation of the criteria or a revised version.\n";
            var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
            {
                Model = Model.GPT4_Turbo,
                Temperature = 0.1,
                MaxTokens = 1000,
                ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.User, prompt)
                }
            });

            NewIELTSEssayFeedbackModel feedback = JsonConvert.DeserializeObject<NewIELTSEssayFeedbackModel>(result.Choices[0].Message.TextContent);
            return feedback;
        }
    }
}

