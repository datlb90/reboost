using Microsoft.Extensions.Configuration;
using Reboost.DataAccess;
using Reboost.DataAccess.Entities;
using Reboost.DataAccess.Models;
using Reboost.Shared;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Reboost.Shared.Extensions;
using Stripe;
using System.Net.Http;
using OpenAI_API.Completions;
using OpenAI_API;
using OpenAI_API.Chat;
using OpenAI_API.Models;
using Newtonsoft.Json;
using System.Text.RegularExpressions;
using PayPal.Api;

namespace Reboost.Service.Services
{
    public interface IChatGPTService
    {
        Task GetDifficultyLevelForAllQuestions();
        Task<TOEFLIndependentFeedbackModel> GetTOEFLIndependentEssayFeedback(string question, string essay, string feedbackLanguage);
        Task<TOEFLIntegratedFeedbackModel> GetTOEFLIntegratedEssayFeedback(string question, string essay, string feedbackLanguage);
        Task<IELTSTask1FeedbackModel> GetIELTSTask1EssayFeedback(string question, string essay, string filePath, string feedbackLanguage);
        Task<IELTSTask2FeedbackModel> GetIELTSTask2EssayFeedback(string question, string essay, string feedbackLanguage);
    }

    public class ChatGPTService : BaseService, IChatGPTService
    {
        private string OPENAI_API_KEY = "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"; // "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";
        IConfiguration configuration;
        public ChatGPTService(IUnitOfWork unitOfWork,
            IConfiguration _configuration) : base(unitOfWork)
        {
           
            configuration = _configuration;
        }

        public static string StripHTML(string input)
        {
            return Regex.Replace(input, "<.*?>", String.Empty);
        }

        public async Task GetDifficultyLevelForAllQuestions()
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string task1Criteria = "You will be given a IELTS academic writing task 1 topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\n•\tEasy: Topics are common, widely recognized, and relatable to the general public. Specialized knowledge is not required, and test takers can generate ideas just by critical thinking about the topic. \n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential. Data or processes may include some unfamiliar elements but are generally accessible.\n•\tHard: Topics may be quite specialized or technical. Often includes data, or processes that are not commonly encountered in everyday contexts.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string task2Criteria = "You will be given a IELTS academic writing task 2 topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\n•\tEasy: Topics are common, widely recognized, and relatable to the general public. Specialized knowledge is not required, and test takers can readily generate ideas and examples from their personal experiences or common knowledge.\n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential. More critical thinking is needed to develop coherent arguments and counterarguments.\n•\tHard: Topics are specialized or abstract, demanding in-depth knowledge or a deep understanding. These subjects often involve complex concepts, technical details, or nuanced perspectives that go beyond general knowledge.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string independentCriteria = "You will be given a TOEFL independent writing topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\nFamiliarity:\n•\tEasy: Topics are very common and frequently encountered in everyday life. These subjects require minimal specialized knowledge and are broadly relatable.\n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential.\n•\tHard: Topics are specialized or abstract, demanding in-depth knowledge or a deep understanding. These subjects often involve complex concepts, technical details, or nuanced perspectives that go beyond general knowledge.\n\nSimplicity:\n•\tEasy: Questions are straightforward, typically asking for a personal preference or opinion. Easier to organize thoughts and structure the essay into introduction, body paragraphs, and conclusion.\n•\tMedium: Questions may involve a bit more complexity, such as comparing two viewpoints or analyzing a trend. Requires more developed skills in structuring arguments and supporting them with reasons and examples.\n•\tHard: Questions are more complex and might involve abstract thinking or sophisticated arguments. High level of planning, organization, and critical thinking is needed to construct a coherent and persuasive essay.\n\nLanguage Demand:\n•\tEasy: Basic vocabulary and simple grammatical structures are often sufficient. The focus is on clear and coherent expression of personal opinions and experiences.\n•\tMedium: Requires a mix of basic and advanced vocabulary and varied sentence structures. The ability to articulate and support slightly complex ideas is important.\n•\tHard: High proficiency in language use is required, with a wide range of vocabulary and complex sentence structures. The ability to express and justify complex ideas and arguments clearly and effectively is crucial.\n\nResource Availability:\n•\tEasy: There are abundant study materials, sample essays, and practice prompts available. It's relatively easy to find model essays and guidelines for these common topics.\n•\tMedium: A fair amount of practice materials and examples are available but might require more analytical skills. Candidates may need to seek specific examples or more detailed study guides.\n•\tHard: There are fewer ready-made resources and sample essays at this level. Extensive reading and research might be needed to effectively tackle these topics.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string integratedCriteria = "You will be given a TOEFL integrated writing topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\nFamiliarity:\n•\tEasy: Topics are very common and frequently encountered in everyday life. These subjects require minimal specialized knowledge and are broadly relatable. Information presented in both the reading and the listening is straightforward and clear.\n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential. Information may have more depth compared to the easy level, requiring attentive reading, and listening.\n•\tHard: Topics are specialized or abstract, demanding in-depth knowledge or a deep understanding. Both the reading and listening passages contain dense and intricate information.\n\nSimplicity:\n•\tEasy: The relationship between the reading and listening materials is relatively clear and direct. Easier to identify the main points and how they either contrast with or support each other.\n•\tMedium: The connections between the reading and listening materials might be less direct, with more subtle points of comparison or contrast. Requires more critical thinking to identify and articulate the key relationships.\n•\tHard: Relationships between the reading and listening materials are complex, often involving nuanced arguments or detailed analysis. High level of skill in organizing, integrating, and presenting information coherently and concisely is needed.\n\nLanguage Demand:\n•\tEasy: Requires basic vocabulary and simple sentence structures for summarizing and comparing information. Focus is more on accuracy in conveying information than on using complex language.\n•\tMedium: Requires a balance of basic and more advanced vocabulary, along with varied sentence structures. Ability to express relationships between more complex ideas and details is important.\n•\tHard: High proficiency in language use is required, with a wide range of vocabulary and complex sentence structures. The ability to synthesize and analyze intricate details and viewpoints is crucial.\n\nResource Availability:\n•\tEasy: Plenty of practice materials and sample responses are available, including texts and lectures on familiar topics. Easy to find resources that demonstrate how to integrate and summarize key points.\n•\tMedium: A fair amount of practice materials are available but may require more analytical skills to dissect. Might need to seek specific examples or more detailed guides on notetaking and synthesis.\n•\tHard: Fewer ready-made resources and model responses are available at this higher level of complexity. Requires extensive research and practice with advanced materials to develop proficiency.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string criteria = task2Criteria;

            var questions = await _unitOfWork.Questions.GetAllActiveQuestions();

            foreach(Questions question in questions)
            {
                QuestionParts questionContent = await _unitOfWork.QuestionParts.GetQuestionContentById(question.Id);
                if(questionContent != null)
                {
                    string content = ""; // StripHTML(questionContent.Content);
                    Tasks questionTask = await _unitOfWork.Questions.GetTaksById(question.TaskId);
                    string task = questionTask.Name;

                    if (task == "Independent Writing")
                    {
                        criteria = independentCriteria;
                        content = "Classify the difficulty level of the following TOEFL independent writing topic: " + StripHTML(questionContent.Content) + "";
                    }
                    else if (task == "Integrated Writing")
                    {
                        criteria = integratedCriteria;
                        string reading = "";
                        QuestionParts readingPart = await _unitOfWork.QuestionParts.GetReadingByQuestionId(question.Id);
                        if (readingPart != null)
                            reading = StripHTML(readingPart.Content);

                        string transcript = "";
                        QuestionParts transcriptPart = await _unitOfWork.QuestionParts.GetTranscriptByQuestionId(question.Id);
                        if (transcriptPart != null)
                            transcript = StripHTML(transcriptPart.Content);

                        content = "Classify the difficulty level of the following TOEFL integrated writing topic: \nQuesiton: " + StripHTML(questionContent.Content) + "\nReading: " + reading + "\nListening Transcript: " + transcript + "";

                    }
                    else if (task == "Academic Writing Task 1")
                    {
                        criteria = task1Criteria;
                        content = "Classify the difficulty level of the following IELTS academic writing task 1 topic: " + StripHTML(questionContent.Content) + "";
                    }
                    else
                    {
                        criteria = task2Criteria;
                        content = "Classify the difficulty level of the following IELTS academic writing task 2 topic: " + StripHTML(questionContent.Content) + "";
                    }
                    string difficulty = "Medium";
                    ChatMessage prerequisite = new ChatMessage(ChatMessageRole.User, criteria);
                    ChatMessage request = new ChatMessage(ChatMessageRole.User, content);
                    List<ChatMessage> messages = new List<ChatMessage>();
                    messages.Add(prerequisite);
                    messages.Add(request);

                    var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                    {
                        Model = Model.GPT4_Turbo,
                        Temperature = 0.1,
                        MaxTokens = 2000,
                        ResponseFormat = ChatRequest.ResponseFormats.Text,
                        Messages = messages

                    });;

                    difficulty = result.Choices[0].Message.TextContent;
                    question.Difficulty = difficulty;
                    question.LastActivityDate = DateTime.UtcNow;
                    await _unitOfWork.Questions.Update(question);
                }
                
            }
           
        }
        public async Task<TOEFLIndependentFeedbackModel> GetTOEFLIndependentEssayFeedback(string question, string essay, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string independentRubric = "Given the following rubric descriptors for the TOEFL Independent Writing delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Language Use\n1.1. Criteria Description\nThe Language Use criterion for the TOEFL Independent Writing task evaluates your ability to use English accurately and effectively in an academic context. This criterion focuses on your grammatical accuracy, range of vocabulary, and overall fluency and clarity in expressing ideas.\n\n1.2. Band Descriptors\n- Band 0: The essay does not address the topic, is written in a foreign language, is copied, is off-topic, or is blank.\n\n- Band 1: Vocabulary: Shows very limited control of vocabulary. Incorrect word choice and errors in word form are frequent, severely impeding communication; Grammar: Displays fundamental errors in grammatical structures. Errors are so prevalent that they largely prevent understanding of the text; Clarity and Fluency: Writing is generally incoherent, with little to no evidence of ability to organize or express ideas clearly.\n\n- Band 2: Vocabulary: Displays limited vocabulary range, word choice is often basic and sometimes inappropriate, leading to confusion and ambiguity; Grammar: Frequent grammatical errors significantly hinder clarity. Simple grammatical structures may be used correctly, but more complex structures are often misused; Clarity and Fluency: Writing may be difficult to understand due to pervasive errors in vocabulary and grammar. Attempts at complex ideas are poorly executed, leading to unclear or incoherent expression.\n\n- Band 3: Vocabulary: Demonstrates an adequate range of vocabulary for the task, however, misuse of words and noticeable gaps in vocabulary may be evident; Grammar: Shows a mix of accurate and inaccurate use of grammatical structures. Errors are frequent enough to make some sentences unclear; Clarity and Fluency: Writing is generally clear, but problems with fluency and word choice may obscure meaning in some instances.\n\n- Band 4: Vocabulary: Uses a range of vocabulary effectively, though may display some lack of precision. Idiomatic expressions are generally used correctly; Grammar: Exhibits control over grammatical structures, though some errors may occur. These errors rarely reduce clarity; Clarity and Fluency: Overall, the writing is coherent and can be understood without effort, but it may lack the polish and smoothness of a higher-scoring essay.\n\n- Band 5: Vocabulary: Demonstrates a strong command of vocabulary and idiomatic expressions. Rare minor errors do not detract from the overall communication; Grammar: Shows effective use of varied grammatical structures. Any grammatical errors are minor and infrequent, not interfering with comprehension; Clarity and Fluency: The writing is clear and fluid. Complex ideas are expressed elegantly and are easily understood by the reader.\n\n2. Organization\n2.1. Criteria Description\nThe Organization criterion for the TOEFL Independent Writing task assesses how well you can structure and present your ideas in a clear, logical manner. This involves the overall structure of your essay, including the introduction, body paragraphs, and conclusion, as well as the coherence and transition between ideas within and across paragraphs.\n\n2.2. Band Descriptors\n- Band 0: The essay does not address the topic, is written in a foreign language, is copied, is off-topic, or is blank.\n\n- Band 1: Overall Structure: The essay lacks a coherent structure, with no clear distinction between introduction, body, and conclusion. The organization is so poor that it significantly impedes understanding; Coherence and Cohesion: There is little to no use of transitional phrases or sentences, leading to a very disjointed and incoherent flow of ideas. Paragraphs, if present, are poorly formed and lack cohesion; Unity: The essay fails to maintain focus, with most of the content irrelevant to the thesis or main topic.\n\n- Band 2: Overall Structure: The essay’s structure is unclear or inconsistent, making it difficult to identify the introduction, body, and conclusion. The organization is poor, making it hard to follow the progression of ideas; Coherence and Cohesion: Transitions between ideas are minimal or ineffective, leading to a disjointed or confusing arrangement of ideas. Paragraphs may not be well-defined, with ideas blending into one another without clear separation; Unity: Many paragraphs may lack a clear main idea or stray significantly from the thesis. The essay may contain much irrelevant information.\n\n- Band 3: Overall Structure: The essay has an identifiable structure, but the organization may be flawed or simplistic. The introduction, body paragraphs, and conclusion are present but may not be fully developed or clear; Coherence and Cohesion: Attempts to use transitions are evident, but they may be misused or repetitive, leading to some confusion or disjointedness in the flow of ideas; Unity: Some paragraphs may lack clear focus or deviate from supporting the thesis. The essay may include irrelevant information that detracts from the overall argument.\n\n- Band 4: Overall Structure: The essay is generally well-organized with a clear introduction, body, and conclusion. The structure may be less innovative or slightly unclear at times, but it does not significantly hinder comprehension; Coherence and Cohesion: Uses transitional phrases and sentences effectively, though some transitions may be mechanical or less varied. There may be minor issues with flow or clarity, but they do not significantly disrupt the reading experience; Unity: Paragraphs are generally focused, but one or two may contain some extraneous information or not be as well-developed.\n\n- Band 5: Overall Structure: The essay has a clear, logical structure that is easy to follow. The introduction effectively sets up the topic and thesis statement, body paragraphs are well-developed and focused on separate ideas that support the thesis, and the conclusion effectively summarizes the essay or restates its main points; Coherence and Cohesion: Uses effective transitional phrases and sentences to link ideas within paragraphs and between them, ensuring smooth flow of ideas. Paragraphs are clearly delineated, and each serves a distinct purpose in the argument or narrative; Unity: Each paragraph has a clear main idea that supports the thesis, with no irrelevant or off-topic information.\n\n3. Development and Support\n3.1. Criteria Description\nThe Development and Support criterion for the TOEFL Independent Writing task evaluates how well you can develop your ideas and support them with details and examples. This criterion assesses the effectiveness of your argumentation or explanation, the relevance and persuasiveness of your supporting details, and how well you integrate these elements to make a coherent argument or narrative.\n\n3.2. Band Descriptors\n- Band 0: The essay does not address the topic, is written in a foreign language, is copied, is off-topic, or is blank.\n\n- Band 1: Idea Development: Ideas are poorly developed or barely addressed. There is a significant lack of supporting detail, making arguments or narratives difficult to understand or follow; Supporting Details: Lacks relevant or coherent supporting examples and details. Any attempt to support ideas is vague, incorrect, or irrelevant; Complexity and Depth: Demonstrates a lack of thought and understanding of the topic. There is no complexity, with ideas presented in a disjointed or incoherent manner.\n\n- Band 2: Idea Development: Ideas are underdeveloped and lack detailed support. Arguments or explanations are incomplete or superficial, making them unconvincing; Supporting Details: Provides few details or examples, which are often irrelevant or overly simplistic. Struggles to connect supporting details effectively to main ideas; Complexity and Depth: Shows minimal complexity or depth of thought. The essay tends to be simplistic and one-dimensional, with no consideration of counterarguments or alternative perspectives.\n\n- Band 3: Idea Development: Ideas are somewhat developed but may not be fully elaborated. Support for arguments or explanations is present but not always convincing or thoroughly explained; Supporting Details: Uses examples and reasons to support ideas, but these may be too general, simplistic, or partially relevant. The connection between support and the main ideas may not always be clear; Complexity and Depth: Demonstrates basic thought and a straightforward approach to the topic. Lacks significant complexity, with little to no acknowledgement of counterarguments or alternative perspectives.\n\n- Band 4: Idea Development: Ideas are generally well-developed and supported. Arguments or explanations are clear and make sense but may lack the depth or insight of the highest-scoring essays; Supporting Details: Provides clear and relevant examples and reasons to support main ideas. The integration of these details is mostly effective, though some may be more generic or less fully explored; Complexity and Depth: Shows a good level of thought and complexity. Counterarguments or alternative perspectives may be mentioned but are not explored in depth.\n\n- Band 5: Idea Development: Ideas are fully developed and thoroughly supported. Arguments or narratives are detailed, insightful, and demonstrate a deep understanding of the topic; Supporting Details: Uses specific, relevant examples and reasons to support ideas. These details are integrated seamlessly into the argument or explanation, enhancing the persuasive or explanatory power of the essay; Complexity and Depth: Demonstrates sophisticated thought and complexity in argumentation or narrative. Counterarguments or alternative perspectives may be acknowledged and addressed, adding depth to the essay.\n</rubric>\n";
            string prompt = "For the following TOEFL Independent Writing topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\nGiven the following response essay delimited by <essay> and </essay> tags:\n\n<essay>\n" + essay + "\n</essay>\n\nReturn a JSON object that contains 4 objects and a list. The 4 objects are: languageUse, organization, developmentSupport, and overallFeedback. The name of the list is errors.\n\nThe languageUse object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Language Use criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Language Use criteria based on the band descriptors.\n\nThe organization object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Organization criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Organization criteria based on the band descriptors.\n\nThe developmentSupport object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Development and Support criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Development and Support criteria based on the band descriptors.\n\nThe overallFeedback object has 2 properties which are: comment and score. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement. The score property contains the overall band score given for the essay.\n\nThe errors list contains 5 objects. Each object has 3 properties which are: issue, type, and fix. The issue property captures a word, a phrase, or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of the error. The fix property is the fix for that issue. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version. The feedback must be written in Vietnamese, except for the list of errors.\n";
            if (feedbackLanguage != "vn")
                prompt = "For the following TOEFL Independent Writing topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\nGiven the following response essay delimited by <essay> and </essay> tags:\n\n<essay>\n" + essay + "\n</essay>\n\nReturn a JSON object that contains 4 objects and a list. The 4 objects are: languageUse, organization, developmentSupport, and overallFeedback. The name of the list is errors.\n\nThe languageUse object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Language Use criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Language Use criteria based on the band descriptors.\n\nThe organization object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Organization criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Organization criteria based on the band descriptors.\n\nThe developmentSupport object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Development and Support criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Development and Support criteria based on the band descriptors.\n\nThe overallFeedback object has 2 properties which are: comment and score. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement. The score property contains the overall band score given for the essay.\n\nThe errors list contains 5 objects. Each object has 3 properties which are: issue, type, and fix. The issue property captures a word, a phrase, or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of the error. The fix property is the fix for that issue. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version.\n";

            var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
            {
                Model = Model.GPT4_Turbo,
                Temperature = 0.1,
                MaxTokens = 2000,
                ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, independentRubric),
                    new ChatMessage(ChatMessageRole.User, prompt)
                }
            });
            //Console.WriteLine(result.Choices[0].Message.TextContent);
            TOEFLIndependentFeedbackModel feedback = JsonConvert.DeserializeObject<TOEFLIndependentFeedbackModel>(result.Choices[0].Message.TextContent);
            return feedback;
        }
        public async Task<TOEFLIntegratedFeedbackModel> GetTOEFLIntegratedEssayFeedback(string question, string essay, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string integratedRubric = "Given the following rubric descriptors for the TOEFL Integrated Writing delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Language Use\n1.1. Criteria Description\nThe Language Use criterion for the TOEFL Integrated Writing task assesses your ability to effectively use English to summarize and synthesize information from reading and listening materials. This involves evaluating your grammar, vocabulary, and overall ability to express ideas clearly and cohesively in writing.\n\n1.2. Band Descriptors\n- Band 0: The response is off-topic, written in a language other than English, merely copies large portions of the text without synthesizing, or is left blank.\n\n- Band 1: Vocabulary: Shows very limited vocabulary. Frequent errors in word choice and form severely impede communication. Lacks academic language and appropriate idiomatic expressions; Grammar: Shows very little or no control over grammatical structures. Errors are pervasive and greatly hinder comprehension; Cohesion and Coherence: Lacks coherent and cohesive writing. Ideas are disjointed, and the summary is extremely difficult to follow due to the poor use of language and lack of logical connection between ideas.\n\n- Band 2: Vocabulary: Exhibits limited vocabulary range, with frequent inappropriate word choices and errors that often hinder comprehension. Struggles to use academic language effectively; Grammar: Limited control over grammatical structures, with pervasive errors that frequently obscure meaning. Reliance on overly simple sentence structures; Cohesion and Coherence: Demonstrates limited ability to connect ideas cohesively. Poor use of cohesive devices and unclear expression of ideas make the summary difficult to follow.\n\n- Band 3: Vocabulary: Demonstrates an adequate range of vocabulary for summarizing content, but misuse of vocabulary and noticeable gaps in lexical resources may occasionally hinder comprehension. Limited use of academic language and idiomatic expressions; Grammar: Displays fair grammatical control. Simple and some complex sentence structures are used, but with frequent errors that may sometimes impede understanding; Cohesion and Coherence: Uses some cohesive devices, but their misuse or overuse may lead to some lack of clarity. Ideas are expressed with some coherence, though the summary may be harder to follow in places.\n\n- Band 4: Vocabulary: Uses a range of vocabulary effectively but may have minor errors or less precision in word choice that do not significantly hinder communication. Good use of academic language and some idiomatic expressions; Grammar: Shows good grammatical control. Uses a variety of sentence structures with some errors, but these errors do not significantly obscure meaning; Cohesion and Coherence: The response is cohesive and demonstrates effective use of cohesive devices. Ideas are generally expressed clearly, though there may be occasional lapses in coherence that do not majorly affect readability.\n\n- Band 5: Vocabulary: Demonstrates a strong command of vocabulary and the ability to use precise and appropriate language to convey ideas effectively. Utilizes a wide range of academic vocabulary and idiomatic expressions correctly; Grammar: Exhibits excellent grammatical control. Varieties of sentence structures are used effectively and flexibly. Grammatical mistakes are rare and do not impede understanding; Cohesion and Coherence: The response is highly cohesive and demonstrates skillful use of cohesive devices (e.g., conjunctions, reference words, transitions). Ideas are expressed clearly and coherently, making the summary easy to follow.\n\n2. Organization\n2.1. Criteria Description\nThe Organization criterion for the TOEFL Integrated Writing task evaluates how effectively you organize and present information from the reading and listening materials in your written response. This criterion focuses on the overall structure of your response, the clarity of your summarization, and how well you link ideas from both sources.\n\n2.2. Band Descriptors\n- Band 0: The response does not address the task, is off-topic, written in a language other than English, merely copies large portions of the text without organization, or is left blank.\n\n- Band 1: Overall Structure: Lacks coherent structure, with no clear distinction between the summary of the reading and listening materials. The organization is poor, significantly impeding the reader’s understanding; Clarity of Summarization: Provides a very poor summary of the points, with significant inaccuracies and omissions. The reader is left to guess the main points and their sources; Linking Ideas: Demonstrates very little or no effective linking of ideas. The response is extremely difficult to follow, with ideas presented in a random or incoherent manner.\n\n- Band 2: Overall Structure: The response’s structure is unclear or inconsistent, making it difficult to distinguish the main points and their sources. The organization does not effectively convey the relationship between the reading and listening materials; Clarity of Summarization: Struggles to summarize the main points accurately or clearly. Information may be presented in a confused manner, making it hard for the reader to understand the relationship between the sources; Linking Ideas: Limited or ineffective use of transitional phrases. The response may lack logical connections between ideas, leading to a disjointed presentation.\n\n- Band 3: Overall Structure: The response has an identifiable structure, but the organization may be simplistic or flawed in some areas. It attempts to organize the main points from the reading and listening, but the relationship between them may not always be clear; Clarity of Summarization: Attempts to summarize the main points, but may include inaccuracies, be incomplete, or somewhat unclear, requiring the reader to infer some relationships between points; Linking Ideas: Uses some transitional phrases and attempts to link ideas, but these may be misused or insufficient, leading to a somewhat disjointed or confusing presentation.\n\n- Band 4: Overall Structure: The response is well-organized with a clear structure that mostly effectively compares or contrasts the reading and listening points. The introduction, body, and possible conclusion are present and facilitate understanding; Clarity of Summarization: Summarizes the main points from the sources accurately, though there may be minor omissions or inaccuracies that do not significantly affect clarity; Linking Ideas: Generally uses transitions and organizational phrases effectively, though some connections between ideas may be less smooth or obvious.\n\n- Band 5: Overall Structure: The response has a clear, logical structure that effectively organizes information from both the reading and listening materials. An introduction sets up the topic, followed by body paragraphs that cohesively compare or contrast the points from the reading and listening, and a conclusion may summarize the key points; Clarity of Summarization: Summarizes information accurately and clearly, making it easy for the reader to identify the main points and how they relate to each other; Linking Ideas: Uses effective transitional phrases and sentences to link ideas within and between paragraphs, ensuring a smooth flow of information. Demonstrates a clear relationship between the reading and listening points.\n\n3. Content\n3.1. Criteria Description\nThe Content criterion for the TOEFL Integrated Writing task assesses your ability to convey information accurately and effectively from the reading and listening materials in your written response. This involves evaluating how well you summarize the key points and details from both sources and how effectively you integrate these points to present a coherent analysis or comparison.\n\n3.2. Band Descriptors\n- Band 0: The response does not address the task, is off-topic, written in a language other than English, merely copies large portions of the text without synthesizing, or is left blank.\n\n- Band 1: Accuracy: Contains numerous inaccuracies or misrepresentations of the reading and listening materials. Key points are either missing or inaccurately portrayed, significantly misleading the reader; Integration: Shows very poor or no integration of information from the reading and listening materials. Fails to establish a coherent relationship between the sources, making the response difficult to follow; Completeness: The response fails to adequately address the task, missing most of the required information and providing an incomplete or incorrect understanding of the topic.\n\n- Band 2: Accuracy: Struggles to accurately convey key points and details from the sources. Includes inaccuracies or omissions that significantly affect the reader's understanding of the topic; Integration: Demonstrates limited ability to integrate information from the reading and listening materials. Connections between the two sources are weak or unclear, leading to a fragmented or incomplete comparison or contrast; Completeness: The response partially addresses the task but omits significant information, leading to an incomplete or skewed understanding of the topic.\n\n- Band 3: Accuracy: Conveys some key points and details from the reading and listening materials but may include inaccuracies or omit important information. These issues may occasionally confuse or mislead the reader; Integration: Attempts to integrate information from both sources but may not always make clear or accurate connections. The relationship between the reading and listening materials is somewhat evident but not fully developed; Completeness: The response addresses the task but may leave out key aspects or details necessary for a full understanding of the topic.\n\n- Band 4: Accuracy: Accurately conveys most of the key points and important details from both sources. There may be minor inaccuracies or omissions, but these do not significantly impact the overall comprehension of the material; Integration: Effectively integrates information from both sources, making clear connections between the reading and listening materials. The comparison or contrast is clear but may lack some of the depth or insight of the highest-scoring essays; Completeness: The response covers most of the necessary information required by the task. Minor omissions do not significantly detract from the overall understanding of the topic.\n\n- Band 5: Accuracy: The response accurately conveys all the critical points and important details from both the reading and listening materials. Any minor inaccuracies do not change the overall understanding of the information; Integration: Demonstrates exceptional ability to synthesize and integrate information from the reading and listening materials. The relationship between the two sources is clear and well-explained, providing a thorough comparison or contrast as required; Completeness: The response is comprehensive, covering all necessary aspects of the task. It provides a full understanding of the topic without omitting significant information.\n</rubric>\n";
            string prompt = "For the following TOEFL Integrated Writing topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\nGiven the following response essay delimited by <essay> and </essay> tags:\n\n<essay>\n" + essay + "\n</essay>\n\nReturn a JSON object that contains 4 objects and a list. The 4 objects are: languageUse, organization, content, and overallFeedback. The name of the list is errors.\n\nThe languageUse object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Language Use criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Language Use criteria based on the band descriptors.\n\nThe organization object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Organization criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Organization criteria based on the band descriptors.\n\nThe content object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Content criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Content criteria based on the band descriptors.\n\nThe overallFeedback object has 2 properties which are: comment and score. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement. The score property contains the overall band score given for the essay.\n\nThe errors list contains 5 objects. Each object has 3 properties which are: issue, type, and fix. The issue property captures a word, a phrase, or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of the error. The fix property is the fix for that issue. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version. The feedback must be written in Vietnamese, except for the list of errors.\n";
            if (feedbackLanguage != "vn")
                prompt = "For the following TOEFL Integrated Writing topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\nGiven the following response essay delimited by <essay> and </essay> tags:\n\n<essay>\n" + essay + "\n</essay>\n\nReturn a JSON object that contains 4 objects and a list. The 4 objects are: languageUse, organization, content, and overallFeedback. The name of the list is errors.\n\nThe languageUse object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Language Use criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Language Use criteria based on the band descriptors.\n\nThe organization object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Organization criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Organization criteria based on the band descriptors.\n\nThe content object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Content criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Content criteria based on the band descriptors.\n\nThe overallFeedback object has 2 properties which are: comment and score. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement. The score property contains the overall band score given for the essay.\n\nThe errors list contains 5 objects. Each object has 3 properties which are: issue, type, and fix. The issue property captures a word, a phrase, or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of the error. The fix property is the fix for that issue. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version.\n";

            var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
            {
                Model = Model.GPT4_Turbo,
                Temperature = 0.1,
                MaxTokens = 2000,
                ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, integratedRubric),
                    new ChatMessage(ChatMessageRole.User, prompt)
                }
            });
            //Console.WriteLine(result.Choices[0].Message.TextContent);
            TOEFLIntegratedFeedbackModel feedback = JsonConvert.DeserializeObject<TOEFLIntegratedFeedbackModel>(result.Choices[0].Message.TextContent);
            return feedback;
        }
        public async Task<IELTSTask1FeedbackModel> GetIELTSTask1EssayFeedback(string question, string essay, string filePath, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string task1Rubric = "Given the following rubric descriptors for the IELTS Academic Writing Task 1 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Achievement\n1.1. Criteria Description\nThe Task Achievement criterion in IELTS Academic Writing Task 1 evaluates how well you summarize key trends, compare data, cover all task requirements, and report features accurately from visuals like graphs or charts, focusing on your ability to identify and convey the most important information.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the task. Any copied rubric must be discounted.\n\n- Band 2: The content barely relates to the task.\n\n- Band 3: The response does not address the requirements of the task (possibly because of misunderstanding of the data/diagram/situation). Key features/bullet points which are presented may be largely irrelevant. Limited information is presented, and this may be used repetitively.\n\n- Band 4: The response is an attempt to address the task. Few key features have been selected. be confused. The tone may be inappropriate. The format may be inappropriate. Key features/bullet points which are presented may be irrelevant, repetitive, inaccurate, or inappropriate.\n\n- Band 5: The response generally addresses the requirements of the task. The format may be inappropriate in places. Key features which are selected are not adequately covered. The recounting of detail is mainly mechanical. There may be no data to support the description. There may be a tendency to focus on details (without referring to the bigger picture). The inclusion of irrelevant, inappropriate or inaccurate material in key areas detracts from the task achievement. There is limited detail when extending and illustrating the main points.\n\n- Band 6: The response focuses on the requirements of the task and an appropriate format is used. Key features which are selected are covered and adequately highlighted. A relevant overview is attempted. Information is appropriately selected and supported using figures/data. Some irrelevant, inappropriate or inaccurate information may occur in areas of detail or when illustrating or extending the main points. Some details may be missing (or excessive) and further extension or illustration may be needed.\n\n- Band 7: The response covers the requirements of the task. The content is relevant and accurate. There may be a few omissions or lapses. The format is appropriate. Key features which are selected are covered and clearly highlighted but could be more fully or more appropriately illustrated or extended. It presents a clear overview, the data are appropriately categorized, and main trends or differences are identified.\n\n- Band 8: The response covers all the requirements of the task appropriately, relevantly and sufficiently. Key features are skillfully selected, and clearly presented, highlighted and illustrated. There may be occasional omissions or lapses in content.\n\n- Band 9: All the requirements of the task are fully and appropriately satisfied. There may be extremely rare lapses in content.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion assesses your ability to organize and link information clearly and logically in IELTS Academic Writing Task 1. It focuses on effective paragraphing, logical sequencing of ideas, and the use of cohesive devices (like linking words and pronouns) to help the reader understand the relationships between ideas.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. Minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing.\n\n- Band 4: Information and ideas are evident but not arranged coherently, and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error.\n\n- Band 7: Information and ideas are logically organized and there is a clear progression throughout the response. A few lapses may occur. A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence or cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion evaluates your range of vocabulary, accuracy in word choice, and ability to use words appropriately to express precise meanings in IELTS Academic Writing Task 1. It focuses on your ability to use a variety of vocabulary to describe data, trends, and processes clearly and accurately.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice, and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation, and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings within the scope of the task. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are evident within the scope of the task. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion assesses your use of sentence structures and grammatical accuracy in IELTS Academic Writing Task 1. It focuses on your ability to construct a range of sentence types correctly and use grammar precisely to convey information and ideas effectively.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorized phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through.  Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures within the scope of the task is flexibly and accurately used. The majority of sentences are error free, and punctuation is well managed. Occasional, nonsystematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures within the scope of the task is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n</rubric>\n";
            string prompt = "For the following Academic Writing Task 1 topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\nGiven the following response essay delimited by <essay> and </essay> tags:\n\n<essay>\n" + essay + "\n</essay>\n\nReturn a JSON object that contains 5 objects and a list. The 5 objects are: taskAchievement, coherence, lexicalResource, grammar, overallFeedback. The name of the list is errors.\n\nThe taskAchievement object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Task Achievement criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Task Achievement criteria based on the band descriptors.\n\nThe coherence object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Coherence & Cohesion criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Coherence & Cohesion criteria based on the band descriptors.\n\nThe lexicalResource object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Lexical Resource criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Lexical Resource criteria based on the band descriptors.\n\nThe grammar object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Grammatical Range & Accuracy criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Grammatical Range & Accuracy criteria based on the band descriptors.\n\nThe overallFeedback object has 2 properties which are: comment and score. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement. The score property contains the overall band score given for the essay.\n\nThe errors list contains 5 objects. Each object has 3 properties which are: issue, type, and fix. The issue property captures a word, a phrase, or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of the error. The fix property is the fix for that issue. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version. The feedback must be written in Vietnamese, except for the list of errors.\n";
            if (feedbackLanguage != "vn")
                prompt = "For the following Academic Writing Task 1 topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\nGiven the following response essay delimited by <essay> and </essay> tags:\n\n<essay>\n" + essay + "\n</essay>\n\nReturn a JSON object that contains 5 objects and a list. The 5 objects are: taskAchievement, coherence, lexicalResource, grammar, overallFeedback. The name of the list is errors.\n\nThe taskAchievement object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Task Achievement criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Task Achievement criteria based on the band descriptors.\n\nThe coherence object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Coherence & Cohesion criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Coherence & Cohesion criteria based on the band descriptors.\n\nThe lexicalResource object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Lexical Resource criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Lexical Resource criteria based on the band descriptors.\n\nThe grammar object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Grammatical Range & Accuracy criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Grammatical Range & Accuracy criteria based on the band descriptors.\n\nThe overallFeedback object has 2 properties which are: comment and score. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement. The score property contains the overall band score given for the essay.\n\nThe errors list contains 5 objects. Each object has 3 properties which are: issue, type, and fix. The issue property captures a word, a phrase, or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of the error. The fix property is the fix for that issue. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version.\n";

            if (!String.IsNullOrEmpty(filePath))
            {
                ChatMessage message = new ChatMessage();
                message.Role = ChatMessageRole.User;
                message.TextContent = prompt;
                // Add the chart to the message 
                message.Images = new List<ChatMessage.ImageInput>();
                message.Images.Add(ChatMessage.ImageInput.FromFile(filePath));

                var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Vision,
                    Temperature = 0.1,
                    MaxTokens = 2000,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                        new ChatMessage(ChatMessageRole.Assistant, task1Rubric),
                        message
                    }
                });

                var jsonResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 2000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                        new ChatMessage(ChatMessageRole.User, "Convert the following content into json format:\n" + result.Choices[0].Message.TextContent)
                    }
                });

                IELTSTask1FeedbackModel feedback = JsonConvert.DeserializeObject<IELTSTask1FeedbackModel>(jsonResult.Choices[0].Message.TextContent);

                return feedback;
            }
            else
            {
                var jsonResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 2000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                        new ChatMessage(ChatMessageRole.Assistant, task1Rubric),
                        new ChatMessage(ChatMessageRole.User, prompt)
                    }
                });

                IELTSTask1FeedbackModel feedback = JsonConvert.DeserializeObject<IELTSTask1FeedbackModel>(jsonResult.Choices[0].Message.TextContent);

                return feedback; ;
            }
        }
        public async Task<IELTSTask2FeedbackModel> GetIELTSTask2EssayFeedback(string question, string essay, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            //string task2Rubric = "Given the following rubric descriptors for the IELTS Academic Writing Task 2 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Response\n1.1. Criteria Description\nThe Task Response criterion in IELTS Academic Writing Task 2 assesses how well you develop and support your ideas in response to the question. It focuses on your ability to present a clear, relevant position, fully extend and support your main ideas, and answer all parts of the task prompt comprehensively.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the prompt. Any copied rubric must be discounted.\n\n- Band 2: The content is barely related to the prompt. No position can be identified. There may be glimpses of one or two ideas without development.\n\n- Band 3: No part of the prompt is adequately addressed, or the prompt has been misunderstood. No relevant position can be identified, and/or there is little direct response to the question/s. There are few ideas, and these may be irrelevant or insufficiently developed.\n\n- Band 4: The prompt is tackled in a minimal way, or the answer is tangential, possibly due to some misunderstanding of the prompt. The format may be inappropriate. A position is discernible, but the reader has to read carefully to find it. Main ideas are difficult to identify and such ideas that are identifiable may lack relevance, clarity and/or support. Large parts of the response may be repetitive.\n\n- Band 5: The main parts of the prompt are incompletely addressed. The format may be inappropriate in places. The writer expresses a position, but the development is not always clear. Some main ideas are put forward, but they are limited and are not sufficiently developed and/or there may be irrelevant detail. There may be some repetition.\n\n- Band 6: The main parts of the prompt are addressed (though some may be more fully covered than others). An appropriate format is used. A position is presented that is directly relevant to the prompt, although the conclusions drawn may be unclear, unjustified or repetitive. Main ideas are relevant, but some may be insufficiently developed or may lack clarity, while some supporting arguments and evidence may be less relevant or inadequate.\n\n- Band 7: The main parts of the prompt are appropriately addressed. A clear and developed position is presented. Main ideas are extended and supported but there may be a tendency to over generalize or there may be a lack of focus and precision in supporting ideas/material.\n\n- Band 8: The prompt is appropriately and sufficiently addressed. A clear and well-developed position is presented in response to the question/s. Ideas are relevant, well extended and supported. There may be occasional omissions or lapses in content.\n\n- Band 9: The prompt is appropriately addressed and explored in depth. A clear and fully developed position is presented which directly answers the question/s. Ideas are relevant, fully extended and well supported. Any lapses in content or support are extremely rare.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion in IELTS Academic Writing Task 2 evaluates your ability to organize ideas logically and connect them smoothly. It focuses on clear overall structure, logical sequencing of paragraphs and ideas, and the effective use of cohesive devices (such as linking words and pronouns) to guide the reader through your argument or narrative seamlessly.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. There is minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing. Any attempts at paragraphing are unhelpful.\n\n- Band 4: Information and ideas are evident but not arranged coherently and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing. There may be no paragraphing and/or no clear main topic within paragraphs.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution. Paragraphing may be inadequate or missing.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error. Paragraphing may not always be logical and/or the central topic may not always be clear.\n\n- Band 7: Information and ideas are logically organized, and there is a clear progression throughout the response. (A few lapses may occur, but these are minor). A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use. Paragraphing is generally used effectively to support overall coherence, and the sequencing of ideas within a paragraph is generally logical.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence and cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion in IELTS Academic Writing Task 2 measures your range of vocabulary, the precision of your word choices, and your ability to use words appropriately for various contexts. It assesses your skill in using vocabulary flexibly and accurately to express ideas and opinions, including the effective use of synonyms and collocations, without errors that hinder communication.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: - Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over-dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e.g. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk-taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are widely evident. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion in IELTS Academic Writing Task 2 evaluates your ability to use a wide range of grammar structures accurately. It focuses on your capacity to construct complex sentences effectively, use punctuation correctly, and apply grammatical forms with flexibility to clearly express detailed reasoning and arguments without making errors that obscure meaning.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorised phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through. Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication.\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error-free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures is flexibly and accurately used. The majority of sentences are error-free, and punctuation is well managed. Occasional, non-systematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n\n</rubric>\n";

            //string prompt = "For the following Academic Writing Task 2 topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\nGiven the following response essay delimited by <essay> and </essay> tags:\n\n<essay>\n" + essay + "\n</essay>\n\nReturn a JSON object that contains 5 objects and a list. The 5 objects are: taskResponse, coherence, lexicalResource, grammar, overallFeedback. The name of the list is errors.\n\nThe taskResponse object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Task Response criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Task Response criteria based on the band descriptors.\n\nThe coherence object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Coherence & Cohesion criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Coherence & Cohesion criteria based on the band descriptors.\n\nThe lexicalResource object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Lexical Resource criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Lexical Resource criteria based on the band descriptors.\n\nThe grammar object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Grammatical Range & Accuracy criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Grammatical Range & Accuracy criteria based on the band descriptors.\n\nThe overallFeedback object has 2 properties which are: comment and score. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement. The score property contains the overall band score given for the essay.\n\nThe errors list contains 5 objects. Each object has 3 properties which are: issue, type, and fix. The issue property captures a word, a phrase, or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of the error. The fix property is the fix for that issue. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version. The feedback must be written in Vietnamese, except for the list of errors.\n";
            //if (feedbackLanguage != "vn")
            //    prompt = "For the following Academic Writing Task 2 topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\nGiven the following response essay delimited by <essay> and </essay> tags:\n\n<essay>\n" + essay + "\n</essay>\n\nReturn a JSON object that contains 5 objects and a list. The 5 objects are: taskResponse, coherence, lexicalResource, grammar, overallFeedback. The name of the list is errors.\n\nThe taskResponse object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Task Response criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Task Response criteria based on the band descriptors.\n\nThe coherence object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Coherence & Cohesion criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Coherence & Cohesion criteria based on the band descriptors.\n\nThe lexicalResource object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Lexical Resource criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Lexical Resource criteria based on the band descriptors.\n\nThe grammar object has 2 properties which are: comment and score. The comment property contains the feedback for the essay for the Grammatical Range & Accuracy criteria. It must include what the essay did well, areas for improvement, and actionable steps for improvement. The score property contains the score given for the essay for the Grammatical Range & Accuracy criteria based on the band descriptors.\n\nThe overallFeedback object has 2 properties which are: comment and score. The comment property contains the overall feedback for the essay. It must include a summary of the performance, most significant strengths, most important areas for improvement, final thoughts, and encouragement. The score property contains the overall band score given for the essay.\n\nThe errors list contains 5 objects. Each object has 3 properties which are: issue, type, and fix. The issue property captures a word, a phrase, or a sentence in the essay that has grammar, spelling, punctuation, or word choice error. The type property is the type of the error. The fix property is the fix for that issue. The errors list contains at most 5 objects.\n\nTry not to exceed 10000 characters and do not include an explanation of the criteria or a revised version.\n";
            string topic = "Given the following Academic Writing Task 2 topic delimited by <topic> and </topic> tags:\r\n\r\n<topic>" + question + "\r\n\r\n</topic>\r\n";
            string response = "Given the following writing response for the topic delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + essay + "\r\n</response>\r\n";
            string task = "Cung cấp phản hồi cho bài luận cho tiêu chí Task Response sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Response dựa theo ban descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Response. Phản hồi cần đưa ra những điểm mạnh và phải liệt kê ra các ví dụ cụ thể tương ứng ở trong bài viết\r\n- Thuộc tính weaknesses: chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Response. Phản hồi cần liệt kê ra những điểm này và đưa ra khuyến nghị cụ thể cho từng điểm.\r\n- Thuộc tính recommendations: cung cấp hướng dẫn để học viên có thể cải thiện bài viết của mình cho tiêu chí Task Response. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ 1 cách hiệu quả nhất.\r\n";
            var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
            {
                Model = Model.GPT4_Turbo,
                Temperature = 0.1,
                MaxTokens = 2000,
                ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    //new ChatMessage(ChatMessageRole.Assistant, task2Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, task)
                }
            });
            Console.Write(result.Choices[0].Message.TextContent);

            AutomatedFeedbackModel taskResponse  = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(result.Choices[0].Message.TextContent);

            return null;
        }
    }
}

