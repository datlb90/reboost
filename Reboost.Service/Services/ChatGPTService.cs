using Microsoft.Extensions.Configuration;
using Reboost.DataAccess;
using Reboost.DataAccess.Entities;
using Reboost.DataAccess.Models;
using Reboost.Shared;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Reboost.Shared.Extensions;
using Stripe;
using System.Net.Http;
using OpenAI_API.Completions;
using OpenAI_API;
using OpenAI_API.Chat;
using OpenAI_API.Models;
using Newtonsoft.Json;
using System.Text.RegularExpressions;
using PayPal.Api;
using SendGrid;
using OpenAI_API.Moderation;
using static System.Net.Mime.MediaTypeNames;
using Org.BouncyCastle.Asn1.Ocsp;

namespace Reboost.Service.Services
{
    public interface IChatGPTService
    {
        Task<ErrorsInText> getErrorsInTextV2(CriteriaFeedbackModel model);
        Task<string> getExperimentAIFeedback(ExperimentFeedbackModel model);
        Task<ErrorsInText> getVocabularyErrorsInText(CriteriaFeedbackModel model);
        Task<ErrorsInText> getGrammarErrorsInText(CriteriaFeedbackModel model);
        Task<ErrorsInText> getErrorsInText(CriteriaFeedbackModel model);
        // Version 1.4
        Task<string> getAIFeedbackForCriteriaV4(CriteriaFeedbackModel model);
        // Version 1.2
        Task<string> getAIFeedbackForCriteriaV2(CriteriaFeedbackModel model);
        // Version 1.1
        Task<AutomatedFeedbackModel> getAIFeedbackForCriteria(CriteriaFeedbackModel model);
        Task<EssayScoreModel> getEssayScore(CriteriaFeedbackModel model);
        // Version 1.3
        Task<string> getCriteriaFeedback(CriteriaFeedbackModel model);
        Task<string> getFeedbackForErrors(ErrorFeedbackModel model);
       
        Task<ImageToTopicAndEssayModel> getWritingTextFromImage(byte[] imageData);
        Task<string> getChartDescription(string filePath);
        
        Task GetDifficultyLevelForAllQuestions();
        Task<TOEFLIndependentFeedbackModel> GetTOEFLIndependentEssayFeedback(string question, string essay, string feedbackLanguage);
        Task<TOEFLIntegratedFeedbackModel> GetTOEFLIntegratedEssayFeedback(string question, string essay, string feedbackLanguage);
        Task<IELTSTask1FeedbackModel> GetIELTSTask1EssayFeedback(string question, string essay, string filePath, string feedbackLanguage);
        Task<IELTSTask2FeedbackModel> GetIELTSTask2EssayFeedback(string question, string essay, string feedbackLanguage);
    }

    public class ChatGPTService : BaseService, IChatGPTService
    {
        private string OPENAI_API_KEY = "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"; // "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";
        IConfiguration configuration;
        public ChatGPTService(IUnitOfWork unitOfWork,
            IConfiguration _configuration) : base(unitOfWork)
        {
           
            configuration = _configuration;
        }

        public async Task<ErrorsInText> getErrorsInTextV2(CriteriaFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string response = "Given the following writing essay:\r\n\r\n" + model.essay + "\r\n\r\n";

                string request = "Provide a JSON object called errors that contains a list of objects with the following properties:\r\n- error: word or phrase in the essay with vocabulary or grammar mistake. \r\n- type: The type of the error. This can be “grammar” or “vocabulary”.\r\n- category: The category of the error. \r\n- comment: Explain the issue in Vietnamese.\r\n- fix: The English replacement for the word or phrase.\r\n";
                if (model.feedbackLanguage != "vn")
                    request = "Provide a JSON object called errors that contains a list of objects with the following properties:\r\n- error: word or phrase in the essay with vocabulary or grammar mistake. \r\n- type: The type of the error. This can be “grammar” or “vocabulary”.\r\n- category: The category of the error. \r\n- comment: Explain the issue.\r\n- fix: The replacement for the word or phrase.\r\n";
                ErrorsInText result = new ErrorsInText();
                List<ErrorInText> errors = new List<ErrorInText>();

                // Get vocabulary error first
                var errorResponse = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.ChatGPTTurbo,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Temperature = 0.1,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.Assistant, response),
                        new ChatMessage(ChatMessageRole.User, request)
                    }
                });

                ErrorsInText errorResult = JsonConvert.DeserializeObject<ErrorsInText>(errorResponse.Choices[0].Message.TextContent);

                if (errorResult != null)
                {
                    foreach (ErrorInText error in errorResult.errors)
                    {
                        if (!errors.Any(e => e.error == error.error))
                        {
                            if (!error.comment.Contains(error.fix))
                            {
                                if (error.comment.EndsWith('.'))
                                {
                                    if (model.feedbackLanguage != "vn")
                                        error.comment += " Replace with: '" + error.fix + "'";
                                    else
                                        error.comment += " Thay thế bằng: '" + error.fix + "'";
                                }
                                else
                                {
                                    if (model.feedbackLanguage != "vn")
                                        error.comment += ". Replace with: '" + error.fix + "'";
                                    else
                                        error.comment += ". Thay thế bằng: '" + error.fix + "'";
                                }
                            }
                            errors.Add(error);
                        }
                    }
                }

                result.errors = errors;
                return result;
            }
            catch (Exception e)
            {
                return null;
            }
        }


        public async Task<string> getExperimentAIFeedback(ExperimentFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string topic = "";
                string response = "";
                if (model.topic == "The writing topic is not provided")
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        response = "Given the following IELTS Academic Writing Task 1 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic = "Given the following chart information for the IELTS Academic Writing Task 1: \r\n\r\n" + model.chartDescription + "\r\n\r\n";
                        }
                    }
                    else // Academic Writing Task 2
                    {
                        response = "Given the following IELTS Academic Writing Task 2 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }
                else
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        topic = "Given the following IELTS Academic Writing Task 1 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic += model.chartDescription;
                        }
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                    else // Academic Writing Task 2
                    {
                        topic = "Given the following IELTS Academic Writing Task 2 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }

                //string request = "";
                //switch (model.criteriaName)
                //{
                //    case "Improved Version":
                //        request = "Provide an improved version of the essay while keeping all ideas, author point of view, arguments, examples, and analysis.";
                //        break;
                //    case "Vocabulary":
                //        request = "Cung cấp 10 từ vừng hữu dụng nhất cho chủ đề này nhưng không xuất hiện trong bài luận. Mỗi từ vựng bao gồm các thông tin sau:\r\n- Từ vựng đó viết bằng tiếng anh\r\n- Nghĩa của từ đó bằng tiếng việt\r\n- Định nghĩa của từ đó bằng tiếng anh\r\n- Ví dụ trong 1 câu văn bằng tiếng Anh liên quan tới chủ đề. Thêm dấu __ vào đầu và cuối của từ vựng đó trong câu ví dụ để dễ nhận biết.\r\n";
                //        break;
                //    case "Critical Errors":
                //        request = "Cung cấp 10 từ hoặc cụm từ có thể cải thiện trong bài viết kèm theo lựa chọn thay thế và giải thích bằng tiếng Việt tại sao phiên bản thay thế lại tốt hơn trong ngữ cảnh được cho.";
                //        // "Cung cấp 10 từ hoặc cụm từ có thể cải thiện trong bài viết kèm theo lựa chọn thay thế và giải thích ngắn gọn bằng tiếng Việt tại sao phiên bản thay thế lại tốt hơn. ";

                //        if (model.feedbackLanguage != "vn")
                //            request = "Provide 10 words or phrases that can be improved in the essay. For each word or phrases, provide an alternative and explain why the alternative is better in the given context.";
                //        break;
                //    case "Arguments Assessment":
                //        request = "Liệt kê các phần của bài luận từ mở bài, các ý chính của thân bài, cho tới kết luận. Cho mỗi phần, cung cấp các thông tin sau:\r\n\r\n- Đối với mở bài, cung cấp 2 phần là đánh giá và phiên bản cải thiện. Phần đánh giá bao gồm đánh giá về mức độ hiệu quả và những điểm cần cải thiện của mở bài. Phần phiên bản cải thiện bao gồm một phiên bản cải thiện của mở bài viết bằng tiếng Anh.\r\n\r\n- Cho mỗi ý chính của thân bài, viết lại ý chính đó như xuất hiện trong bài luận bằng tiếng anh; cung cấp đánh giá về điểm mạnh và điểm yếu của các lập luận trong ý chính đó dựa vào tính logic, sự rõ ràng, tính chặt chẽ, và sức nặng của các dẫn chứng; và cung cấp 1 phiên bản cải thiện của ý chính đó viết bằng tiếng Anh.\r\n\r\n- Đối với kết luận, cung cấp 2 phần là đánh giá và phiên bản cải thiện. Phần đánh giá bao gồm đánh giá về mức độ hiệu quả và những điểm cần cải thiện của kết luận. Phần phiên bản cải thiện bao gồm một phiên bản cải thiện của kết luận viết bằng tiếng Anh.\r\n";

                //        if (model.feedbackLanguage != "vn")
                //            request = "List the parts of the essay from the introduction, through the main points of the body, to the conclusion. For each part, provide the following information:\r\n\r\n- For the introduction, supply two parts: an evaluation and an improved version. The evaluation should include an assessment of the introduction's effectiveness and areas needing improvement. The improved version should include a revised version of the introduction.\r\n\r\n- For each main point in the body, rewrite that main point as it appears in the essay; evaluate the strengths and weaknesses of the arguments in that main point based on their logic, clarity, rigor, and the strength of the evidence; and provide an improved version of that main point,\r\n\r\n- For the conclusion, provide two parts: an evaluation and an improved version. The evaluation should assess the effectiveness and areas needing improvement in the conclusion. The improved version should include a revised version of the conclusion.\r\n";
                //        break;
                //    case "Task Achievement":
                //        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Task Achievement. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Task Achievement.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Task Achievement.\r\n\r\n- Nếu có thông tin hay yếu tố nào của đề bài bị thiếu hoặc bỏ sót, chỉ ra những thông tin này này và đề xuất cách để bao gồm chúng ở trong bài luận.\r\n- Nếu bài luận không nhắc tới các xu hướng hoặc các phần quan trọng nhất trong thông tin được cung cấp, chỉ ra những thiếu sót này và đề xuất cách tích hợp vào bài luận.\r\n- Nếu bài luận thiếu sự so sánh giữa các điểm dữ liệu, đề xuất các so sánh cụ thể có thể làm giàu thêm phân tích của bài luận.\r\n- Nếu bài luận không lựa chọn dữ liệu từ thông tin được cung cấp một cách phù hợp, cung cấp gợi ý về các dữ liệu phù hợp nhất.\r\n";
                //        if (model.feedbackLanguage != "vn")
                //            request = "Provide feedback for the essay based on the Task Achievement criterion. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two points where the essay performed well regarding the Task Achievement criterion.\r\n\r\n2. Areas for improvement: Identify the aspects that the essay needs to improve for the Task Achievement criterion.\r\n\r\n- If any information or elements from the prompt are missing or overlooked, highlight them and suggest ways to include them in the essay.\r\n- If the essay fails to mention significant trends or features from the provided information, highlight these omissions and suggest ways to integrate them into the essay.\r\n- If the essay lacks comparisons between data points, propose specific comparisons that could enrich the analysis of the essay.\r\n- If the essay does not appropriately select data from the provided information, provide suggestions on the most relevant data to include.\r\n";
                //        break;
                //    case "Task Response":
                //        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Task Response. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Task Response.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Task Response.\r\n- Nếu bài luận không trả lời đầy đủ mọi khía cạnh của đề bài, chỉ ra những khía cạnh bị thiếu sót và gợi ý cách bổ sung chúng vào bài luận.\r\n- Nếu quan điểm của tác giả không được trình bày một cách rõ ràng và nhất quán, giải thích và đề xuất gợi ý cải thiện.\r\n- Nếu các ý tưởng không được mở rộng để hỗ trợ các luận điểm chính, chỉ ra các ý tưởng thiếu chiều sâu này và đề xuất cách thức để mở rộng và phát triển chúng.\r\n- Nếu các ý tưởng không được hỗ trợ bởi lý lẽ logic, bằng chứng, hoặc ví dụ cụ thể, chỉ ra các dẫn chứng có trong bài viết và gợi ý cách hỗ trợ những ý tưởng đó.\r\n";
                //        if (model.feedbackLanguage != "vn")
                //            request = "Provide feedback for the essay based on the Task Response criterion. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two points where the essay performed well regarding the Task Response criterion.\r\n\r\n2. Areas for improvement: Identify the aspects that the essay needs to improve for the Task Response criterion.\r\n- If the essay does not fully address all aspects of the prompt, point out these missing aspects and suggest ways to incorporate them into the essay.\r\n- If the author's viewpoint is not clearly and consistently presented throughout the essay, provide detailed explanation and recommend strategies for improvement.\r\n- If the ideas are not expanded to support the main arguments, point out these shallow ideas and propose ways to expand and develop them.\r\n- If the ideas are not supported by logical reasoning, evidence, or specific examples, point out the evidence in the text and suggest how to support these ideas.\r\n";
                //        break;
                //    case "Coherence & Cohesion":
                //        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Coherence and Cohesion. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Coherence and Cohesion.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Coherence and Cohesion.\r\n- Nếu cấu trúc của bài luận không rõ ràng và hợp lý, gây cản trở dòng chảy logic, đưa ra ví dụ cụ thể trong bài viết và gợi ý cách sắp xếp lại cấu trúc bài luận.\r\n- Nếu các đoạn văn thiếu sự tập trung, thiếu câu chủ đề, hoặc bao gồm nhiều ý tưởng, đưa ra ví dụ cụ thể trong bài viết và khuyến nghị phương án sửa đổi.\r\n- Nếu các thiết bị liên kết (như liên từ, đại từ, và cụm từ nối) được sử dụng một cách không thích hợp, đưa ra ví dụ cụ thể trong bài viết và cung cấp các phương án thay thế thích hợp hơn.\r\n";
                //        if (model.feedbackLanguage != "vn")
                //            request = "Provide feedback for the essay based on the Coherence and Cohesion criterion. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two strengths that the essay demonstrated regarding the Coherence and Cohesion criterion.\r\n\r\n2. Areas for improvement: Point out the aspects that the essay needs to improve for the Coherence and Cohesion criterion.\r\n\r\n- If the structure of the essay is not clear and logical, hindering the logical flow, provide specific evidence from the text and suggest ways to improve the essay’s structure to ensure a logical organization.\r\n- If paragraphs lack focus, lack a topic sentence, or include multiple ideas, provide specific examples from the text and recommend revision strategies.\r\n- If linking devices (such as conjunctions, pronouns, and linking phrases) are used inappropriately, provide specific examples from the text and offer more appropriate alternative options.\r\n";
                //        break;
                //    case "Lexical Resource":
                //        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Lexical Resource. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Lexical Resource.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Lexical Resource.\r\n- Nếu có bất kỳ từ hay cụm từ nào trong bài luận được sử dụng quá mức hoặc lặp lại không cần thiết, chỉ ra những từ hay cụm từ đó và cung cấp cách thay thế.\r\n- Nếu có bất kỳ sự không chính xác nào trong việc lựa chọn từ hoặc sử dụng từ, chỉ ra các dẫn chứng cụ thể trong bài viết, giải thích tại sao chúng không chính xác hoặc không phù hợp, và cung cấp các lựa chọn thay thế chính xác hơn.\r\n- Nếu ngôn ngữ được sử dụng không phù hợp hoặc thiếu sự trang trọng với một bài luận học thuật, chỉ ra các dẫn chứng cụ thể trong bài viết và đề xuất các lựa chọn thay thế.\r\n";
                //        if (model.feedbackLanguage != "vn")
                //            request = "Provide feedback for the essay based on the Lexical Resource criterion. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two points where the essay performed well regarding the Lexical Resource criterion.\r\n\r\n2. Areas for improvement: Identify the aspects that the essay needs to improve for the Lexical Resource criterion.\r\n- If any words or phrases are overused or unnecessarily repeated in the essay, point out these words or phrases and provide alternatives.\r\n- If there are any inaccuracies in word choice or usage, point out specific evidence in the text, explain why they are incorrect or inappropriate, and provide more accurate alternatives.\r\n- If the language used is not appropriate or lacks the formality required for an academic essay, highlight specific evidence in the text and suggest alternative choices.\r\n";
                //        break;
                //    case "Grammatical Range & Accuracy":
                //        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Grammatical Range & Accuracy. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Grammatical Range & Accuracy.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Grammatical Range & Accuracy.\r\n- Nếu bài luận phụ thuộc quá mức vào chỉ một hay hai loại cấu trúc ngữ pháp, đưa ra ví dụ cụ thể và gợi ý những cấu trúc mới.\r\n- Nếu có phẩn nào của bài luận mà các loại câu phức tạp bao gồm câu ghép và câu phức có thể sử dụng thay thế để tăng cường sự rõ ràng và hấp dẫn, gợi ý những thay đổi cụ thể đó.\r\n- Nếu có bất kỳ lỗi ngữ pháp nào trong bài luận, chỉ ra ví dụ cụ thể, giải thích, và cung cấp cách sửa.\r\n";
                //        if (model.feedbackLanguage != "vn")
                //            request = "Provide feedback for the essay based on the Grammatical Range & Accuracy. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two strengths that the essay demonstrated regarding the Grammatical Range & Accuracy criterion.\r\n\r\n2. Areas for improvement: Point out the aspects that the essay needs to improve for the Grammatical Range & Accuracy criterion.\r\n\r\n- If the essay relies too much on just one or two types of grammatical structures, provide specific examples and suggest new structures to use.\r\n- If there are parts of the essay where complex sentence types, including compound and complex sentences, could be used to enhance clarity and engagement, suggest those specific changes.\r\n- If there are any grammatical errors in the essay, point out specific examples, explain, and provide corrections.\r\n";
                //        break;
                //    case "Overall Score & Feedback":
                //        if (model.task == "Academic Writing Task 1")
                //        {
                //            request = "Cung cấp phản hồi tổng quát bằng tiếng Việt cho bài. Phản hồi gồm 2 phần sau:\r\n\r\n- Đánh giá tổng quan: cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Achievement, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy\r\n\r\n- Khuyễn nghị cho học viên: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số cho bài viết của mình.\r\n";

                //            if (model.feedbackLanguage != "vn")
                //                request = "Provide overall feedback for the essay. The feedback contains the following 2 parts:\r\n\r\n- Overall performance: provide a comprehensive overview about the quality of the essay, covering all four criteria: Task Achievement, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n\r\n- How to improve: provide general guidance for the student to improve.\r\n";
                //        }
                //        else
                //        {
                //            request = "Cung cấp phản hồi tổng quát bằng tiếng Việt cho bài. Phản hồi gồm 2 phần sau:\r\n\r\n- Đánh giá tổng quan: cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Achievement, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy\r\n\r\n- Khuyễn nghị cho học viên: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số cho bài viết của mình.\r\n";

                //            if (model.feedbackLanguage != "vn")
                //                request = "Provide overall feedback for the essay. The feedback contains the following 2 parts:\r\n\r\n- Overall performance: provide a comprehensive overview about the quality of the essay, covering all four criteria: Task Achievement, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n\r\n- How to improve: provide general guidance for the student to improve.\r\n";
                //        }

                //        break;
                //    default:
                //        break;
                //}

                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = (model.feedbackLanguage != "vn" || model.criteriaName == "Improved Version" || model.criteriaName == "Vocabulary")
                           ? Model.ChatGPTTurbo : Model.ChatGPTTurbo_16k,
                    Temperature = 0.1,
                    Messages = new ChatMessage[] {
                            new ChatMessage(ChatMessageRole.Assistant, topic),
                             new ChatMessage(ChatMessageRole.Assistant, response),
                            new ChatMessage(ChatMessageRole.User, model.prompt)
                        }
                });

                return taskResponseResult.Choices[0].Message.TextContent;

            }
            catch (Exception e)
            {
                return "Hệ thống không thể cung cấp phản hồi.";
            }
        }

        public async Task<ErrorsInText> getErrorsInText(CriteriaFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string response = "Given the following writing essay:\r\n\r\n" + model.essay + "\r\n\r\n";

                string request = "Provide a JSON object called errors that contains a list of objects with the following properties:\r\n- error: word or phrase in the essay with vocabulary or grammar mistake. \r\n- type: The type of the error. This can be “grammar” or “vocabulary”.\r\n- category: The category of the error. \r\n- comment: Explain the issue in Vietnamese.\r\n- fix: The English replacement for the word or phrase.\r\n";
                if (model.feedbackLanguage != "vn")
                    request = "Provide a JSON object called errors that contains a list of objects with the following properties:\r\n- error: word or phrase in the essay with vocabulary or grammar mistake. \r\n- type: The type of the error. This can be “grammar” or “vocabulary”.\r\n- category: The category of the error. \r\n- comment: Explain the issue.\r\n- fix: The replacement for the word or phrase.\r\n";
                ErrorsInText result = new ErrorsInText();
                List<ErrorInText> errors = new List<ErrorInText>();

                // Get vocabulary error first
                var errorResponse = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Temperature = 0.1,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.Assistant, response),
                        new ChatMessage(ChatMessageRole.User, request)
                    }
                });

                ErrorsInText errorResult = JsonConvert.DeserializeObject<ErrorsInText>(errorResponse.Choices[0].Message.TextContent);
                
                if (errorResult != null)
                {
                    foreach (ErrorInText error in errorResult.errors)
                    {
                        if (!errors.Any(e => e.error == error.error))
                        {
                            if (!error.comment.Contains(error.fix))
                            {
                                if (error.comment.EndsWith('.'))
                                {
                                    if (model.feedbackLanguage != "vn")
                                        error.comment += " Replace with: '" + error.fix + "'";
                                    else
                                        error.comment += " Thay thế bằng: '" + error.fix + "'";
                                }
                                else
                                {
                                    if (model.feedbackLanguage != "vn")
                                        error.comment += ". Replace with: '" + error.fix + "'";
                                    else
                                        error.comment += ". Thay thế bằng: '" + error.fix + "'";
                                }
                            }
                            errors.Add(error);
                        }
                    }
                }

                result.errors = errors;
                return result;
            }
            catch (Exception e)
            {
                return null;
            }
        }

        public async Task<ErrorsInText> getGrammarErrorsInText(CriteriaFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string response = "Given the following writing essay:\r\n\r\n" + model.essay + "\r\n\r\n";

                string grammarRequest = "Provide a JSON object called errors that contains a list of objects with the following properties:\r\n- error: word or phrase in the essay with grammar mistake.\r\n- category: The category of the error. This can be: “verb tense mistake”, “subject-verb agreement”, “sentence structure”, “article errors”, “preposition mistake”, or “punctuation misuse”. \r\n- comment: Explain the issue in Vietnamese.\r\n- fix: The replacement for the word or phrase.\r\n";

                if (model.feedbackLanguage != "vn")
                    grammarRequest = "Provide a JSON object called errors that contains a list of objects with the following properties:\r\n- error: word or phrase in the essay with grammar mistake.\r\n- category: The category of the error. This can be: “verb tense mistake”, “subject-verb agreement”, “sentence structure”, “article errors”, “preposition mistake”, or “punctuation misuse”. \r\n- comment: Explain the issue. \r\n- fix: The replacement for the word or phrase.\r\n";

                var grammarResponse = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    // Use GPT-4 for essay with grammar score > 7
                    Model = Model.GPT4_Turbo, // model.grammarScore <= 7 ? Model.ChatGPTTurbo : Model.GPT4_Turbo,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Temperature = 0.1,
                    Messages = new ChatMessage[] {
                             new ChatMessage(ChatMessageRole.Assistant, response),
                            new ChatMessage(ChatMessageRole.User, grammarRequest)
                        }
                });

                ErrorsInText grammarResult = JsonConvert.DeserializeObject<ErrorsInText>(grammarResponse.Choices[0].Message.TextContent);
                List<ErrorInText> errors = new List<ErrorInText>();
                if (grammarResult != null)
                {
                    foreach (ErrorInText error in grammarResult.errors)
                    {
                        if (!errors.Any(e => e.error == error.error))
                        {
                            error.type = "grammar";
                            if (!error.comment.Contains(error.fix))
                            {
                                if (error.comment.EndsWith('.'))
                                {
                                    if (model.feedbackLanguage != "vn")
                                        error.comment += " Replace with: '" + error.fix + "'";
                                    else
                                        error.comment += " Thay thế bằng: '" + error.fix + "'";
                                }
                                else
                                {
                                    if (model.feedbackLanguage != "vn")
                                        error.comment += ". Replace with: '" + error.fix + "'";
                                    else
                                        error.comment += ". Thay thế bằng: '" + error.fix + "'";
                                }
                            }
                            errors.Add(error);
                        }
                    }
                    grammarResult.errors = errors;
                }
                return grammarResult;
            }
            catch (Exception e)
            {
                return null;
            }
        }

        public async Task<ErrorsInText> getVocabularyErrorsInText(CriteriaFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string response = "Given the following writing essay:\r\n\r\n" + model.essay + "\r\n\r\n";

                string request = "Provide a JSON object called errors that contains a list of objects with the following properties:\r\n- error: word or phrase in the essay with vocabulary mistake. \r\n- category: The category of the error. This can be: “limited range”, “word choice”, “collocation”, “vague term”, or “misuse of idioms or phrases”.\r\n- comment: Explain the issue in Vietnamese.\r\n- fix: The replacement for the word or phrase.\r\n";

                if (model.feedbackLanguage != "vn")
                    request = "Provide a JSON object called errors that contains a list of objects with the following properties:\r\n- error: word or phrase in the essay with vocabulary mistake.\r\n- category: The category of the error. This can be: “limited range”, “word choice”, “collocation”, “vague term”, or “misuse of idioms or phrases”.\r\n- comment: Explain the issue.\r\n- fix: The replacement for the word or phrase.\r\n";

                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    ResponseFormat  = ChatRequest.ResponseFormats.JsonObject,
                    Temperature = 0.1,
                    Messages = new ChatMessage[] {
                             new ChatMessage(ChatMessageRole.Assistant, response),
                            new ChatMessage(ChatMessageRole.User, request)
                        }
                });

                ErrorsInText result = JsonConvert.DeserializeObject<ErrorsInText>(taskResponseResult.Choices[0].Message.TextContent);
                List<ErrorInText> errors = new List<ErrorInText>();
                if (result != null)
                {
                    foreach (ErrorInText error in result.errors)
                    {
                        if(!errors.Any(e => e.error == error.error))
                        {
                            error.type = "vocabulary";
                            if (!error.comment.Contains(error.fix))
                            {
                                if (error.comment.EndsWith('.'))
                                {
                                    if (model.feedbackLanguage != "vn")
                                        error.comment += " Replace with: '" + error.fix + "'";
                                    else
                                        error.comment += " Thay thế bằng: '" + error.fix + "'";

                                }
                                else
                                {
                                    if (model.feedbackLanguage != "vn")
                                        error.comment += ". Replace with: '" + error.fix + "'";
                                    else
                                        error.comment += ". Thay thế bằng: '" + error.fix + "'";
                                }
                            }
                            errors.Add(error);
                        }
                    }
                    result.errors = errors;
                }
                return result;
            }
            catch (Exception e)
            {
                 return null;
            }
        }

        public async Task<string> getAIFeedbackForCriteriaV4(CriteriaFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string topic = "";
                string response = "";
                if (model.topic == "The writing topic is not provided")
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        response = "Given the following IELTS Academic Writing Task 1 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic = "Given the following chart information for the IELTS Academic Writing Task 1: \r\n\r\n" + model.chartDescription + "\r\n\r\n";
                        }
                    }
                    else // Academic Writing Task 2
                    {
                        response = "Given the following IELTS Academic Writing Task 2 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }
                else
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        topic = "Given the following IELTS Academic Writing Task 1 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic += model.chartDescription;
                        }
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";

                    }
                    else // Academic Writing Task 2
                    {
                        topic = "Given the following IELTS Academic Writing Task 2 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }

                string request = "";
                switch (model.criteriaName)
                {
                    case "Improved Version":
                        request = "Provide an improved version of the essay while keeping all ideas, author point of view, arguments, examples, and analysis.";
                        break;
                    case "Vocabulary":
                        request = "Cung cấp 10 từ vừng hữu dụng nhất cho chủ đề này nhưng không xuất hiện trong bài luận. Mỗi từ vựng bao gồm các thông tin sau:\r\n- Từ vựng đó viết bằng tiếng anh\r\n- Nghĩa của từ đó bằng tiếng việt\r\n- Định nghĩa của từ đó bằng tiếng anh\r\n- Ví dụ trong 1 câu văn bằng tiếng Anh liên quan tới chủ đề. Thêm dấu __ vào đầu và cuối của từ vựng đó trong câu ví dụ để dễ nhận biết.\r\n";
                        break;
                    case "Critical Errors":
                        request = "Cung cấp 10 từ hoặc cụm từ có thể cải thiện trong bài viết kèm theo lựa chọn thay thế và giải thích bằng tiếng Việt tại sao phiên bản thay thế lại tốt hơn trong ngữ cảnh được cho.";
                        // "Cung cấp 10 từ hoặc cụm từ có thể cải thiện trong bài viết kèm theo lựa chọn thay thế và giải thích ngắn gọn bằng tiếng Việt tại sao phiên bản thay thế lại tốt hơn. ";

                        if (model.feedbackLanguage != "vn")
                            request = "Provide 10 words or phrases that can be improved in the essay. For each word or phrases, provide an alternative and explain why the alternative is better in the given context.";
                        break;
                    case "Arguments Assessment":
                        request = "Liệt kê các phần của bài luận từ mở bài, các ý chính của thân bài, cho tới kết luận. Cho mỗi phần, cung cấp các thông tin sau:\r\n\r\n- Đối với mở bài, cung cấp 2 phần là đánh giá và phiên bản cải thiện. Phần đánh giá bao gồm đánh giá về mức độ hiệu quả và những điểm cần cải thiện của mở bài. Phần phiên bản cải thiện bao gồm một phiên bản cải thiện của mở bài viết bằng tiếng Anh.\r\n\r\n- Cho mỗi ý chính của thân bài, viết lại ý chính đó như xuất hiện trong bài luận bằng tiếng anh; cung cấp đánh giá về điểm mạnh và điểm yếu của các lập luận trong ý chính đó dựa vào tính logic, sự rõ ràng, tính chặt chẽ, và sức nặng của các dẫn chứng; và cung cấp 1 phiên bản cải thiện của ý chính đó viết bằng tiếng Anh.\r\n\r\n- Đối với kết luận, cung cấp 2 phần là đánh giá và phiên bản cải thiện. Phần đánh giá bao gồm đánh giá về mức độ hiệu quả và những điểm cần cải thiện của kết luận. Phần phiên bản cải thiện bao gồm một phiên bản cải thiện của kết luận viết bằng tiếng Anh.\r\n";

                        //"Xác định lập luận chính cho mỗi đoạn văn trong bài viết. Cho mỗi lập luận, cung cấp các thông tin sau:\r\n- Lập luận: viết lại chính xác từng câu từng chữ lập luận đó như xuất hiện trong bài viết bằng tiếng anh.\r\n- Đánh giá: đánh giá điểm mạnh và điểm yếu của luận điểm xét về các khía cạnh như tính rõ ràng, tính chặt chẽ, sự mạch lạc và sức nặng của bằng chứng.\r\n- Phiên bản cải thiện: cung cấp một phiên bản đã được cải thiện của lập luận đó bằng tiếng anh. \r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "List the parts of the essay from the introduction, through the main points of the body, to the conclusion. For each part, provide the following information:\r\n\r\n- For the introduction, supply two parts: an evaluation and an improved version. The evaluation should include an assessment of the introduction's effectiveness and areas needing improvement. The improved version should include a revised version of the introduction.\r\n\r\n- For each main point in the body, rewrite that main point as it appears in the essay; evaluate the strengths and weaknesses of the arguments in that main point based on their logic, clarity, rigor, and the strength of the evidence; and provide an improved version of that main point,\r\n\r\n- For the conclusion, provide two parts: an evaluation and an improved version. The evaluation should assess the effectiveness and areas needing improvement in the conclusion. The improved version should include a revised version of the conclusion.\r\n";
                            //"Identify the main argument of each paragraph in the writing essay. For each argument, provide the following information:\r\n- Argument: write the argument exactly like how it appears in the writing\r\n- Assessment: provide feedback for the argument in term of strengths and weaknesses.\r\non clarity, relevance, coherence, and strength of evidence.\r\n- Improved version: provide an improved version of the argument\r\n";
                        break;
                    case "Task Achievement":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Task Achievement. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Task Achievement.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Task Achievement.\r\n\r\n- Nếu có thông tin hay yếu tố nào của đề bài bị thiếu hoặc bỏ sót, chỉ ra những thông tin này này và đề xuất cách để bao gồm chúng ở trong bài luận.\r\n- Nếu bài luận không nhắc tới các xu hướng hoặc các phần quan trọng nhất trong thông tin được cung cấp, chỉ ra những thiếu sót này và đề xuất cách tích hợp vào bài luận.\r\n- Nếu bài luận thiếu sự so sánh giữa các điểm dữ liệu, đề xuất các so sánh cụ thể có thể làm giàu thêm phân tích của bài luận.\r\n- Nếu bài luận không lựa chọn dữ liệu từ thông tin được cung cấp một cách phù hợp, cung cấp gợi ý về các dữ liệu phù hợp nhất.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay based on the Task Achievement criterion. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two points where the essay performed well regarding the Task Achievement criterion.\r\n\r\n2. Areas for improvement: Identify the aspects that the essay needs to improve for the Task Achievement criterion.\r\n\r\n- If any information or elements from the prompt are missing or overlooked, highlight them and suggest ways to include them in the essay.\r\n- If the essay fails to mention significant trends or features from the provided information, highlight these omissions and suggest ways to integrate them into the essay.\r\n- If the essay lacks comparisons between data points, propose specific comparisons that could enrich the analysis of the essay.\r\n- If the essay does not appropriately select data from the provided information, provide suggestions on the most relevant data to include.\r\n";
                        break;
                    case "Task Response":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Task Response. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Task Response.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Task Response.\r\n- Nếu bài luận không trả lời đầy đủ mọi khía cạnh của đề bài, chỉ ra những khía cạnh bị thiếu sót và gợi ý cách bổ sung chúng vào bài luận.\r\n- Nếu quan điểm của tác giả không được trình bày một cách rõ ràng và nhất quán, giải thích và đề xuất gợi ý cải thiện.\r\n- Nếu các ý tưởng không được mở rộng để hỗ trợ các luận điểm chính, chỉ ra các ý tưởng thiếu chiều sâu này và đề xuất cách thức để mở rộng và phát triển chúng.\r\n- Nếu các ý tưởng không được hỗ trợ bởi lý lẽ logic, bằng chứng, hoặc ví dụ cụ thể, chỉ ra các dẫn chứng có trong bài viết và gợi ý cách hỗ trợ những ý tưởng đó.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay based on the Task Response criterion. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two points where the essay performed well regarding the Task Response criterion.\r\n\r\n2. Areas for improvement: Identify the aspects that the essay needs to improve for the Task Response criterion.\r\n- If the essay does not fully address all aspects of the prompt, point out these missing aspects and suggest ways to incorporate them into the essay.\r\n- If the author's viewpoint is not clearly and consistently presented throughout the essay, provide detailed explanation and recommend strategies for improvement.\r\n- If the ideas are not expanded to support the main arguments, point out these shallow ideas and propose ways to expand and develop them.\r\n- If the ideas are not supported by logical reasoning, evidence, or specific examples, point out the evidence in the text and suggest how to support these ideas.\r\n";
                        break;
                    case "Coherence & Cohesion":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Coherence and Cohesion. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Coherence and Cohesion.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Coherence and Cohesion.\r\n- Nếu cấu trúc của bài luận không rõ ràng và hợp lý, gây cản trở dòng chảy logic, đưa ra ví dụ cụ thể trong bài viết và gợi ý cách sắp xếp lại cấu trúc bài luận.\r\n- Nếu các đoạn văn thiếu sự tập trung, thiếu câu chủ đề, hoặc bao gồm nhiều ý tưởng, đưa ra ví dụ cụ thể trong bài viết và khuyến nghị phương án sửa đổi.\r\n- Nếu các thiết bị liên kết (như liên từ, đại từ, và cụm từ nối) được sử dụng một cách không thích hợp, đưa ra ví dụ cụ thể trong bài viết và cung cấp các phương án thay thế thích hợp hơn.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay based on the Coherence and Cohesion criterion. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two strengths that the essay demonstrated regarding the Coherence and Cohesion criterion.\r\n\r\n2. Areas for improvement: Point out the aspects that the essay needs to improve for the Coherence and Cohesion criterion.\r\n\r\n- If the structure of the essay is not clear and logical, hindering the logical flow, provide specific evidence from the text and suggest ways to improve the essay’s structure to ensure a logical organization.\r\n- If paragraphs lack focus, lack a topic sentence, or include multiple ideas, provide specific examples from the text and recommend revision strategies.\r\n- If linking devices (such as conjunctions, pronouns, and linking phrases) are used inappropriately, provide specific examples from the text and offer more appropriate alternative options.\r\n";
                        break;
                    case "Lexical Resource":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Lexical Resource. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Lexical Resource.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Lexical Resource.\r\n- Nếu có bất kỳ từ hay cụm từ nào trong bài luận được sử dụng quá mức hoặc lặp lại không cần thiết, chỉ ra những từ hay cụm từ đó và cung cấp cách thay thế.\r\n- Nếu có bất kỳ sự không chính xác nào trong việc lựa chọn từ hoặc sử dụng từ, chỉ ra các dẫn chứng cụ thể trong bài viết, giải thích tại sao chúng không chính xác hoặc không phù hợp, và cung cấp các lựa chọn thay thế chính xác hơn.\r\n- Nếu ngôn ngữ được sử dụng không phù hợp hoặc thiếu sự trang trọng với một bài luận học thuật, chỉ ra các dẫn chứng cụ thể trong bài viết và đề xuất các lựa chọn thay thế.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay based on the Lexical Resource criterion. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two points where the essay performed well regarding the Lexical Resource criterion.\r\n\r\n2. Areas for improvement: Identify the aspects that the essay needs to improve for the Lexical Resource criterion.\r\n- If any words or phrases are overused or unnecessarily repeated in the essay, point out these words or phrases and provide alternatives.\r\n- If there are any inaccuracies in word choice or usage, point out specific evidence in the text, explain why they are incorrect or inappropriate, and provide more accurate alternatives.\r\n- If the language used is not appropriate or lacks the formality required for an academic essay, highlight specific evidence in the text and suggest alternative choices.\r\n";
                        break;
                    case "Grammatical Range & Accuracy":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Grammatical Range & Accuracy. Phản hồi gồm 2 phần sau:\r\n\r\n1. Điểm mạnh: chỉ ra 2 điểm mà bài luận đã làm tốt cho tiêu chí Grammatical Range & Accuracy.\r\n\r\n2. Điểm cần cải thiện: chỉ ra những điểm mà bài luận cần cải thiện cho tiêu chí Grammatical Range & Accuracy.\r\n- Nếu bài luận phụ thuộc quá mức vào chỉ một hay hai loại cấu trúc ngữ pháp, đưa ra ví dụ cụ thể và gợi ý những cấu trúc mới.\r\n- Nếu có phẩn nào của bài luận mà các loại câu phức tạp bao gồm câu ghép và câu phức có thể sử dụng thay thế để tăng cường sự rõ ràng và hấp dẫn, gợi ý những thay đổi cụ thể đó.\r\n- Nếu có bất kỳ lỗi ngữ pháp nào trong bài luận, chỉ ra ví dụ cụ thể, giải thích, và cung cấp cách sửa.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay based on the Grammatical Range & Accuracy. The feedback includes the following two parts:\r\n\r\n1. Strengths: Identify two strengths that the essay demonstrated regarding the Grammatical Range & Accuracy criterion.\r\n\r\n2. Areas for improvement: Point out the aspects that the essay needs to improve for the Grammatical Range & Accuracy criterion.\r\n\r\n- If the essay relies too much on just one or two types of grammatical structures, provide specific examples and suggest new structures to use.\r\n- If there are parts of the essay where complex sentence types, including compound and complex sentences, could be used to enhance clarity and engagement, suggest those specific changes.\r\n- If there are any grammatical errors in the essay, point out specific examples, explain, and provide corrections.\r\n";
                        break;
                    case "Overall Score & Feedback":
                        if (model.task == "Academic Writing Task 1")
                        {
                            request = "Cung cấp phản hồi tổng quát bằng tiếng Việt cho bài. Phản hồi gồm 2 phần sau:\r\n\r\n- Đánh giá tổng quan: cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Achievement, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy\r\n\r\n- Khuyễn nghị cho học viên: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số cho bài viết của mình.\r\n";

                            if (model.feedbackLanguage != "vn")
                                request = "Provide overall feedback for the essay. The feedback contains the following 2 parts:\r\n\r\n- Overall performance: provide a comprehensive overview about the quality of the essay, covering all four criteria: Task Achievement, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n\r\n- How to improve: provide general guidance for the student to improve.\r\n";
                        }
                        else
                        {
                            request = "Cung cấp phản hồi tổng quát bằng tiếng Việt cho bài. Phản hồi gồm 2 phần sau:\r\n\r\n- Đánh giá tổng quan: cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Achievement, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy\r\n\r\n- Khuyễn nghị cho học viên: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số cho bài viết của mình.\r\n";

                            if (model.feedbackLanguage != "vn")
                                request = "Provide overall feedback for the essay. The feedback contains the following 2 parts:\r\n\r\n- Overall performance: provide a comprehensive overview about the quality of the essay, covering all four criteria: Task Achievement, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n\r\n- How to improve: provide general guidance for the student to improve.\r\n";
                        }

                        break;
                    default:
                        break;
                }

                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = (model.feedbackLanguage != "vn" || model.criteriaName == "Improved Version" || model.criteriaName == "Vocabulary")
                           ? Model.ChatGPTTurbo : Model.ChatGPTTurbo_16k,
                    Temperature = 0.1,
                    Messages = new ChatMessage[] {
                            new ChatMessage(ChatMessageRole.Assistant, topic),
                             new ChatMessage(ChatMessageRole.Assistant, response),
                            new ChatMessage(ChatMessageRole.User, request)
                        }
                });

                return taskResponseResult.Choices[0].Message.TextContent;

            }
            catch (Exception e)
            {
                return "Hệ thống không thể cung cấp phản hồi.";
            }
        }


        public async Task<EssayScoreModel> getEssayScore(CriteriaFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string rubric = "";
                string topic = "";
                string response = "";
                if (model.topic == "The writing topic is not provided")
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        rubric = "Given the following band descriptors for the IELTS Academic Writing Task 1 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Achievement\n1.1. Criteria Description\nThe Task Achievement criterion in IELTS Academic Writing Task 1 evaluates how well you summarize key trends, compare data, cover all task requirements, and report features accurately from visuals like graphs or charts, focusing on your ability to identify and convey the most important information.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the task. Any copied rubric must be discounted.\n\n- Band 2: The content barely relates to the task.\n\n- Band 3: The response does not address the requirements of the task (possibly because of misunderstanding of the data/diagram/situation). Key features/bullet points which are presented may be largely irrelevant. Limited information is presented, and this may be used repetitively.\n\n- Band 4: The response is an attempt to address the task. Few key features have been selected. be confused. The tone may be inappropriate. The format may be inappropriate. Key features/bullet points which are presented may be irrelevant, repetitive, inaccurate, or inappropriate.\n\n- Band 5: The response generally addresses the requirements of the task. The format may be inappropriate in places. Key features which are selected are not adequately covered. The recounting of detail is mainly mechanical. There may be no data to support the description. There may be a tendency to focus on details (without referring to the bigger picture). The inclusion of irrelevant, inappropriate or inaccurate material in key areas detracts from the task achievement. There is limited detail when extending and illustrating the main points.\n\n- Band 6: The response focuses on the requirements of the task and an appropriate format is used. Key features which are selected are covered and adequately highlighted. A relevant overview is attempted. Information is appropriately selected and supported using figures/data. Some irrelevant, inappropriate or inaccurate information may occur in areas of detail or when illustrating or extending the main points. Some details may be missing (or excessive) and further extension or illustration may be needed.\n\n- Band 7: The response covers the requirements of the task. The content is relevant and accurate. There may be a few omissions or lapses. The format is appropriate. Key features which are selected are covered and clearly highlighted but could be more fully or more appropriately illustrated or extended. It presents a clear overview, the data are appropriately categorized, and main trends or differences are identified.\n\n- Band 8: The response covers all the requirements of the task appropriately, relevantly and sufficiently. Key features are skillfully selected, and clearly presented, highlighted and illustrated. There may be occasional omissions or lapses in content.\n\n- Band 9: All the requirements of the task are fully and appropriately satisfied. There may be extremely rare lapses in content.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion assesses your ability to organize and link information clearly and logically in IELTS Academic Writing Task 1. It focuses on effective paragraphing, logical sequencing of ideas, and the use of cohesive devices (like linking words and pronouns) to help the reader understand the relationships between ideas.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. Minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing.\n\n- Band 4: Information and ideas are evident but not arranged coherently, and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error.\n\n- Band 7: Information and ideas are logically organized and there is a clear progression throughout the response. A few lapses may occur. A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence or cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion evaluates your range of vocabulary, accuracy in word choice, and ability to use words appropriately to express precise meanings in IELTS Academic Writing Task 1. It focuses on your ability to use a variety of vocabulary to describe data, trends, and processes clearly and accurately.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice, and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation, and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings within the scope of the task. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are evident within the scope of the task. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion assesses your use of sentence structures and grammatical accuracy in IELTS Academic Writing Task 1. It focuses on your ability to construct a range of sentence types correctly and use grammar precisely to convey information and ideas effectively.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorized phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through.  Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures within the scope of the task is flexibly and accurately used. The majority of sentences are error free, and punctuation is well managed. Occasional, nonsystematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures within the scope of the task is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n</rubric>\n";
                        response = "Given the following IELTS Academic Writing Task 1 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic = "Given the following chart information for the IELTS Academic Writing Task 1: \r\n\r\n" + model.chartDescription + "\r\n\r\n";
                        }
                    }
                    else // Academic Writing Task 2
                    {
                        rubric = "Given the following band descriptors for the IELTS Academic Writing Task 2 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Response\n1.1. Criteria Description\nThe Task Response criterion in IELTS Academic Writing Task 2 assesses how well you develop and support your ideas in response to the question. It focuses on your ability to present a clear, relevant position, fully extend and support your main ideas, and answer all parts of the task prompt comprehensively.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the prompt. Any copied rubric must be discounted.\n\n- Band 2: The content is barely related to the prompt. No position can be identified. There may be glimpses of one or two ideas without development.\n\n- Band 3: No part of the prompt is adequately addressed, or the prompt has been misunderstood. No relevant position can be identified, and/or there is little direct response to the question/s. There are few ideas, and these may be irrelevant or insufficiently developed.\n\n- Band 4: The prompt is tackled in a minimal way, or the answer is tangential, possibly due to some misunderstanding of the prompt. The format may be inappropriate. A position is discernible, but the reader has to read carefully to find it. Main ideas are difficult to identify and such ideas that are identifiable may lack relevance, clarity and/or support. Large parts of the response may be repetitive.\n\n- Band 5: The main parts of the prompt are incompletely addressed. The format may be inappropriate in places. The writer expresses a position, but the development is not always clear. Some main ideas are put forward, but they are limited and are not sufficiently developed and/or there may be irrelevant detail. There may be some repetition.\n\n- Band 6: The main parts of the prompt are addressed (though some may be more fully covered than others). An appropriate format is used. A position is presented that is directly relevant to the prompt, although the conclusions drawn may be unclear, unjustified or repetitive. Main ideas are relevant, but some may be insufficiently developed or may lack clarity, while some supporting arguments and evidence may be less relevant or inadequate.\n\n- Band 7: The main parts of the prompt are appropriately addressed. A clear and developed position is presented. Main ideas are extended and supported but there may be a tendency to over generalize or there may be a lack of focus and precision in supporting ideas/material.\n\n- Band 8: The prompt is appropriately and sufficiently addressed. A clear and well-developed position is presented in response to the question/s. Ideas are relevant, well extended and supported. There may be occasional omissions or lapses in content.\n\n- Band 9: The prompt is appropriately addressed and explored in depth. A clear and fully developed position is presented which directly answers the question/s. Ideas are relevant, fully extended and well supported. Any lapses in content or support are extremely rare.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion in IELTS Academic Writing Task 2 evaluates your ability to organize ideas logically and connect them smoothly. It focuses on clear overall structure, logical sequencing of paragraphs and ideas, and the effective use of cohesive devices (such as linking words and pronouns) to guide the reader through your argument or narrative seamlessly.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. There is minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing. Any attempts at paragraphing are unhelpful.\n\n- Band 4: Information and ideas are evident but not arranged coherently and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing. There may be no paragraphing and/or no clear main topic within paragraphs.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution. Paragraphing may be inadequate or missing.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error. Paragraphing may not always be logical and/or the central topic may not always be clear.\n\n- Band 7: Information and ideas are logically organized, and there is a clear progression throughout the response. (A few lapses may occur, but these are minor). A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use. Paragraphing is generally used effectively to support overall coherence, and the sequencing of ideas within a paragraph is generally logical.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence and cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion in IELTS Academic Writing Task 2 measures your range of vocabulary, the precision of your word choices, and your ability to use words appropriately for various contexts. It assesses your skill in using vocabulary flexibly and accurately to express ideas and opinions, including the effective use of synonyms and collocations, without errors that hinder communication.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: - Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over-dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e.g. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk-taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are widely evident. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion in IELTS Academic Writing Task 2 evaluates your ability to use a wide range of grammar structures accurately. It focuses on your capacity to construct complex sentences effectively, use punctuation correctly, and apply grammatical forms with flexibility to clearly express detailed reasoning and arguments without making errors that obscure meaning.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorised phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through. Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication.\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error-free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures is flexibly and accurately used. The majority of sentences are error-free, and punctuation is well managed. Occasional, non-systematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n\n</rubric>\n";
                        response = "Given the following IELTS Academic Writing Task 2 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }
                else
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        rubric = "Given the following band descriptors for the IELTS Academic Writing Task 1 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Achievement\n1.1. Criteria Description\nThe Task Achievement criterion in IELTS Academic Writing Task 1 evaluates how well you summarize key trends, compare data, cover all task requirements, and report features accurately from visuals like graphs or charts, focusing on your ability to identify and convey the most important information.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the task. Any copied rubric must be discounted.\n\n- Band 2: The content barely relates to the task.\n\n- Band 3: The response does not address the requirements of the task (possibly because of misunderstanding of the data/diagram/situation). Key features/bullet points which are presented may be largely irrelevant. Limited information is presented, and this may be used repetitively.\n\n- Band 4: The response is an attempt to address the task. Few key features have been selected. be confused. The tone may be inappropriate. The format may be inappropriate. Key features/bullet points which are presented may be irrelevant, repetitive, inaccurate, or inappropriate.\n\n- Band 5: The response generally addresses the requirements of the task. The format may be inappropriate in places. Key features which are selected are not adequately covered. The recounting of detail is mainly mechanical. There may be no data to support the description. There may be a tendency to focus on details (without referring to the bigger picture). The inclusion of irrelevant, inappropriate or inaccurate material in key areas detracts from the task achievement. There is limited detail when extending and illustrating the main points.\n\n- Band 6: The response focuses on the requirements of the task and an appropriate format is used. Key features which are selected are covered and adequately highlighted. A relevant overview is attempted. Information is appropriately selected and supported using figures/data. Some irrelevant, inappropriate or inaccurate information may occur in areas of detail or when illustrating or extending the main points. Some details may be missing (or excessive) and further extension or illustration may be needed.\n\n- Band 7: The response covers the requirements of the task. The content is relevant and accurate. There may be a few omissions or lapses. The format is appropriate. Key features which are selected are covered and clearly highlighted but could be more fully or more appropriately illustrated or extended. It presents a clear overview, the data are appropriately categorized, and main trends or differences are identified.\n\n- Band 8: The response covers all the requirements of the task appropriately, relevantly and sufficiently. Key features are skillfully selected, and clearly presented, highlighted and illustrated. There may be occasional omissions or lapses in content.\n\n- Band 9: All the requirements of the task are fully and appropriately satisfied. There may be extremely rare lapses in content.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion assesses your ability to organize and link information clearly and logically in IELTS Academic Writing Task 1. It focuses on effective paragraphing, logical sequencing of ideas, and the use of cohesive devices (like linking words and pronouns) to help the reader understand the relationships between ideas.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. Minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing.\n\n- Band 4: Information and ideas are evident but not arranged coherently, and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error.\n\n- Band 7: Information and ideas are logically organized and there is a clear progression throughout the response. A few lapses may occur. A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence or cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion evaluates your range of vocabulary, accuracy in word choice, and ability to use words appropriately to express precise meanings in IELTS Academic Writing Task 1. It focuses on your ability to use a variety of vocabulary to describe data, trends, and processes clearly and accurately.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice, and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation, and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings within the scope of the task. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are evident within the scope of the task. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion assesses your use of sentence structures and grammatical accuracy in IELTS Academic Writing Task 1. It focuses on your ability to construct a range of sentence types correctly and use grammar precisely to convey information and ideas effectively.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorized phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through.  Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures within the scope of the task is flexibly and accurately used. The majority of sentences are error free, and punctuation is well managed. Occasional, nonsystematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures within the scope of the task is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n</rubric>\n";
                        topic = "Given the following IELTS Academic Writing Task 1 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic += model.chartDescription;
                        }
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";

                    }
                    else // Academic Writing Task 2
                    {
                        rubric = "Given the following band descriptors for the IELTS Academic Writing Task 2 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Response\n1.1. Criteria Description\nThe Task Response criterion in IELTS Academic Writing Task 2 assesses how well you develop and support your ideas in response to the question. It focuses on your ability to present a clear, relevant position, fully extend and support your main ideas, and answer all parts of the task prompt comprehensively.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the prompt. Any copied rubric must be discounted.\n\n- Band 2: The content is barely related to the prompt. No position can be identified. There may be glimpses of one or two ideas without development.\n\n- Band 3: No part of the prompt is adequately addressed, or the prompt has been misunderstood. No relevant position can be identified, and/or there is little direct response to the question/s. There are few ideas, and these may be irrelevant or insufficiently developed.\n\n- Band 4: The prompt is tackled in a minimal way, or the answer is tangential, possibly due to some misunderstanding of the prompt. The format may be inappropriate. A position is discernible, but the reader has to read carefully to find it. Main ideas are difficult to identify and such ideas that are identifiable may lack relevance, clarity and/or support. Large parts of the response may be repetitive.\n\n- Band 5: The main parts of the prompt are incompletely addressed. The format may be inappropriate in places. The writer expresses a position, but the development is not always clear. Some main ideas are put forward, but they are limited and are not sufficiently developed and/or there may be irrelevant detail. There may be some repetition.\n\n- Band 6: The main parts of the prompt are addressed (though some may be more fully covered than others). An appropriate format is used. A position is presented that is directly relevant to the prompt, although the conclusions drawn may be unclear, unjustified or repetitive. Main ideas are relevant, but some may be insufficiently developed or may lack clarity, while some supporting arguments and evidence may be less relevant or inadequate.\n\n- Band 7: The main parts of the prompt are appropriately addressed. A clear and developed position is presented. Main ideas are extended and supported but there may be a tendency to over generalize or there may be a lack of focus and precision in supporting ideas/material.\n\n- Band 8: The prompt is appropriately and sufficiently addressed. A clear and well-developed position is presented in response to the question/s. Ideas are relevant, well extended and supported. There may be occasional omissions or lapses in content.\n\n- Band 9: The prompt is appropriately addressed and explored in depth. A clear and fully developed position is presented which directly answers the question/s. Ideas are relevant, fully extended and well supported. Any lapses in content or support are extremely rare.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion in IELTS Academic Writing Task 2 evaluates your ability to organize ideas logically and connect them smoothly. It focuses on clear overall structure, logical sequencing of paragraphs and ideas, and the effective use of cohesive devices (such as linking words and pronouns) to guide the reader through your argument or narrative seamlessly.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. There is minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing. Any attempts at paragraphing are unhelpful.\n\n- Band 4: Information and ideas are evident but not arranged coherently and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing. There may be no paragraphing and/or no clear main topic within paragraphs.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution. Paragraphing may be inadequate or missing.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error. Paragraphing may not always be logical and/or the central topic may not always be clear.\n\n- Band 7: Information and ideas are logically organized, and there is a clear progression throughout the response. (A few lapses may occur, but these are minor). A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use. Paragraphing is generally used effectively to support overall coherence, and the sequencing of ideas within a paragraph is generally logical.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence and cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion in IELTS Academic Writing Task 2 measures your range of vocabulary, the precision of your word choices, and your ability to use words appropriately for various contexts. It assesses your skill in using vocabulary flexibly and accurately to express ideas and opinions, including the effective use of synonyms and collocations, without errors that hinder communication.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: - Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over-dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e.g. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk-taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are widely evident. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion in IELTS Academic Writing Task 2 evaluates your ability to use a wide range of grammar structures accurately. It focuses on your capacity to construct complex sentences effectively, use punctuation correctly, and apply grammatical forms with flexibility to clearly express detailed reasoning and arguments without making errors that obscure meaning.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorised phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through. Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication.\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error-free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures is flexibly and accurately used. The majority of sentences are error-free, and punctuation is well managed. Occasional, non-systematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n\n</rubric>\n";
                        topic = "Given the following IELTS Academic Writing Task 2 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }

                string request = "Provide the score for the essay using JSON format. The JSON object has the following 4 properties:\r\n- taskResponseScore: the score of the essay for the Task Response criteria based on the provided band descriptors.\r\n- coherenceScore: the score of the essay for the Coherence & Cohesion criteria based on the provided band descriptors.\r\n- lexicalResourceScore: the essay for the Lexical Resource criteria based on the provided band descriptors.\r\n- grammarScore: the score of the essay for the Grammatical Range & Accuracy criteria based on the provided band descriptors.";
                if(model.task == "Academic Writing Task 1")
                {
                    request = "Provide the score for the essay using JSON format. The JSON object has the following 4 properties:\r\n- taskAchievementScore: the score of the essay for the Task Achievement criteria based on the provided band descriptors.\r\n- coherenceScore: the score of the essay for the Coherence & Cohesion criteria based on the provided band descriptors.\r\n- lexicalResourceScore: the score of the essay for the Lexical Resource criteria based on the provided band descriptors.\r\n- grammarScore: the score of the essay for the Grammatical Range & Accuracy criteria based on the provided band descriptors.";
                }
                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.ChatGPTTurbo,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Temperature = 0.1,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                            new ChatMessage(ChatMessageRole.Assistant, rubric),
                            new ChatMessage(ChatMessageRole.Assistant, topic),
                            new ChatMessage(ChatMessageRole.Assistant, response),
                            new ChatMessage(ChatMessageRole.User, request)
                        }
                });

                var result = JsonConvert.DeserializeObject<EssayScoreModel>(taskResponseResult.Choices[0].Message.TextContent);

                if(result != null)
                {
                    result.overallScore = 0; //(decimal)(Math.Round(result.overallScore * 2, MidpointRounding.AwayFromZero) / 2);
                    result.taskResponseScore = (decimal)Math.Floor(result.taskResponseScore);
                    result.coherenceScore = (decimal)Math.Floor(result.coherenceScore);
                    result.lexicalResourceScore = (decimal)Math.Floor(result.lexicalResourceScore);
                    result.grammarScore = (decimal)Math.Floor(result.grammarScore + 1);
                }

                return result;
            }
            catch (Exception e)
            {
                return null;
            }
        }

        public async Task<string> getCriteriaFeedback(CriteriaFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string topic = "";
                string response = "";
                if (model.topic == "The writing topic is not provided")
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        response = "Given the following IELTS Academic Writing Task 1 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic = "Given the following chart information for the IELTS Academic Writing Task 1: \r\n\r\n" + model.chartDescription + "\r\n\r\n";
                        }
                    }
                    else // Academic Writing Task 2
                    {
                        response = "Given the following IELTS Academic Writing Task 2 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }
                else
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        topic = "Given the following IELTS Academic Writing Task 1 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic += model.chartDescription;
                        }
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";

                    }
                    else // Academic Writing Task 2
                    {
                        topic = "Given the following IELTS Academic Writing Task 2 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }


                string request = "";
                switch (model.criteriaName)
                {
                    case "Addressing All Parts":
                        request = "Addressing All Parts of the Question is a writing criterion ensuring that the response fully covers every aspect of the prompt, including the main question, sub-questions and specific tasks.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Addressing All Parts of the Question cho bài luận. Đánh giá gồm 2 phần sau:\r\n\r\n- Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";

                        if (model.feedbackLanguage != "vn")
                            request = "Addressing All Parts of the Question is a writing criterion ensuring that the response fully covers every aspect of the prompt, including the main question, sub-questions and specific tasks.\r\n\r\nProvide feedback for the essay on the Addressing All Parts of the Question criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;

                    case "Clarity of Position":
                        request = "Clarity of Position is a writing criterion that requires the author's viewpoint or thesis to be clear and consistent throughout the essay.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Clarity of Position cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";

                        if (model.feedbackLanguage != "vn")
                            request = "Clarity of Position is a writing criterion that requires the author's viewpoint or thesis to be clear and consistent throughout the essay.\r\n\r\nProvide feedback for the essay on the Clarity of Position criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";

                        break;
                    case "Development of Ideas":
                        request = "Development of Ideas is a writing criterion that ensures the ideas in the essay are thoroughly elaborated with explanations, examples, and details that reinforce the main argument.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Development of Ideas cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Development of Ideas is a writing criterion that ensures the ideas in the essay are thoroughly elaborated with explanations, examples, and details that reinforce the main argument.\r\n\r\nProvide feedback for the essay on the Development of Ideas criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";

                        break;
                    case "Logical Organization":
                        request = "Logical Organization is a writing criterion ensuring that the essay is structured clearly and logically, facilitating the reader's understanding of the argument or narrative. This typically involves having an introduction, body paragraphs, and a conclusion.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Logical Organization cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Logical Organization is a writing criterion ensuring that the essay is structured clearly and logically, facilitating the reader's understanding of the argument or narrative. This typically involves having an introduction, body paragraphs, and a conclusion.\r\n\r\nProvide feedback for the essay on the Logical Organization criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Paragraphing":
                        request = "Paragraphing is a writing criterion that requires each paragraph to concentrate on a single main idea, which should be introduced by a topic sentence. The following sentences should elaborate on or support this idea.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Paragraphing cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Paragraphing is a writing criterion that requires each paragraph to concentrate on a single main idea, which should be introduced by a topic sentence. The following sentences should elaborate on or support this idea.\r\n\r\nProvide feedback for the essay on the Paragraphing criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Use of Cohesive Devices":
                        request = "Use of Cohesive Devices is a writing criterion ensuring that cohesive devices, such as conjunctions, pronouns, and linking phrases, are used appropriately to connect ideas within and across sentences and paragraphs.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Use of Cohesive Devices cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";

                        if (model.feedbackLanguage != "vn")
                            request = "Use of Cohesive Devices is a writing criterion ensuring that cohesive devices, such as conjunctions, pronouns, and linking phrases, are used appropriately to connect ideas within and across sentences and paragraphs.\r\n\r\nProvide feedback for the essay on the Use of Cohesive Devices criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Range of Vocabulary":
                        request = "Range of Vocabulary is a writing criterion that assesses the ability to use a diverse vocabulary appropriate for the task, which includes less common and topic-specific words.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Range of Vocabulary cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Range of Vocabulary is a writing criterion that assesses the ability to use a diverse vocabulary appropriate for the task, which includes less common and topic-specific words.\r\n\r\nProvide feedback for the essay on the Range of Vocabulary criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Accuracy of Word Choice":
                        request = "Accuracy of Word Choice is a writing criterion assessing the extent to which the words used are appropriate within their context, including correct collocations and idiomatic language.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Accuracy of Word Choice cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Accuracy of Word Choice is a writing criterion assessing the extent to which the words used are appropriate within their context, including correct collocations and idiomatic language.\r\n\r\nProvide feedback for the essay on the Accuracy of Word Choice criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Spelling and Word Formation":
                        request = "Spelling and Word Formation is a writing criterion that assesses correct spelling and the use of words in their appropriate forms, including the proper use of verbs, nouns, adjectives, and adverbs.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Spelling and Word Formation cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Spelling and Word Formation is a writing criterion that assesses correct spelling and the use of words in their appropriate forms, including the proper use of verbs, nouns, adjectives, and adverbs.\r\n\r\nProvide feedback for the essay on the Spelling and Word Formation criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Range of Grammatical Structures":
                        request = "Range of Grammatical Structures is a writing criterion assessing the ability to appropriately use a variety of complex and simple grammatical constructions within the essay.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Range of Grammatical Structures cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Range of Grammatical Structures is a writing criterion assessing the ability to appropriately use a variety of complex and simple grammatical constructions within the essay.\r\n\r\nProvide feedback for the essay on the Range of Grammatical Structures criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Sentence Complexity":
                        request = "Sentence Complexity is a writing criterion that evaluates the ability to construct sentences varying in complexity, incorporating both compound and complex structures, to articulate nuanced ideas.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Sentence Complexity cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";

                        if (model.feedbackLanguage != "vn")
                            request = "Sentence Complexity is a writing criterion that evaluates the ability to construct sentences varying in complexity, incorporating both compound and complex structures, to articulate nuanced ideas.\r\n\r\nProvide feedback for the essay on the Sentence Complexity criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Accuracy in Grammatical Forms":
                        request = "Accuracy in Grammatical Forms is a writing criterion assessing the correctness of the grammatical structures used, allowing for minimal errors that do not hinder communication.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Accuracy in Grammatical Forms cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Accuracy in Grammatical Forms is a writing criterion assessing the correctness of the grammatical structures used, allowing for minimal errors that do not hinder communication.\r\n\r\nProvide feedback for the essay on the Accuracy in Grammatical Forms criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Fulfilling the Prompt Requirements":
                        request = "Fulfilling the Prompt Requirements is a writing criterion that involves comprehending and addressing all aspects of the task prompt, ensuring the response encompasses all necessary information.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Fulfilling the Prompt Requirements cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";

                        if (model.feedbackLanguage != "vn")
                            request = "Fulfilling the Prompt Requirements is a writing criterion that involves comprehending and addressing all aspects of the task prompt, ensuring the response encompasses all necessary information.\r\n\r\nProvide feedback for the essay on the Fulfilling the Prompt Requirements criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Highlighting Key Features":
                        request = "Highlighting Key Features is a writing criterion that assesses the ability to identify and describe the most significant data points, trends, or features in the provided information.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Highlighting Key Features cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Highlighting Key Features is a writing criterion that assesses the ability to identify and describe the most significant data points, trends, or features in the provided information.\r\n\r\nProvide feedback for the essay on the Highlighting Key Features criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Comparing and Contrasting Data":
                        request = "Comparing and Contrasting Data is a writing criterion ensuring that, where relevant, the response compares and contrasts different data points to draw meaningful insights.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Comparing and Contrasting Data cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Comparing and Contrasting Data is a writing criterion ensuring that, where relevant, the response compares and contrasts different data points to draw meaningful insights.\r\n\r\nProvide feedback for the essay on the Comparing and Contrasting Data criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    case "Data Selection and Relevance":
                        request = "Data Selection and Relevance is a writing criterion that assesses the ability to select relevant data for inclusion in the summary, avoiding the inclusion of every detail from the graphic.\r\n\r\nCung cấp đánh giá bằng tiếng Việt cho tiêu chí Data Selection and Relevance cho bài luận. Đánh giá gồm 2 phần sau:\r\n - Đánh giá chi tiết: Cung cấp đánh giá chi tiết cho bài luận cho tiêu chí này. Đưa ra dẫn chứng và ví dụ cụ thể trong bài luận.\r\n- Hướng dẫn cải thiện: Cung cấp gợi ý để cải thiện bài luận cho tiêu chí này.\r\n\r\nTrả lời bằng tiếng Việt và không được thêm bất kỳ bình luận, hay gợi ý nào khác.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Data Selection and Relevance is a writing criterion that assesses the ability to select relevant data for inclusion in the summary, avoiding the inclusion of every detail from the graphic.\r\n\r\nProvide feedback for the essay on the Data Selection and Relevance criterion. The feedback includes the following two parts:\r\n- Detailed assessment: Provide a detailed assessment for the essay on this criterion\r\n- How to improve: Provide a suggestion on how to improve the essay for this criterion.\r\n";
                        break;
                    default:
                        break;
                }

                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    //Model = Model.ChatGPTTurbo_16k,
                    //MaxTokens = 4096,
                    Model = Model.ChatGPTTurbo,
                    //MaxTokens = 4096,
                    Temperature = 0.1,
                    Messages = new ChatMessage[] {
                            new ChatMessage(ChatMessageRole.Assistant, topic),
                            new ChatMessage(ChatMessageRole.Assistant, response),
                            new ChatMessage(ChatMessageRole.User, request)
                        }
                });

                return taskResponseResult.Choices[0].Message.TextContent;


            }
            catch (Exception e)
            {
                return "Hệ thống không thể cung cấp phản hồi.";
            }
        }

        public async Task<string> getFeedbackForErrors(ErrorFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string essay = "Cho đoạn văn sau:\r\n\r\n" + model.essay + "\r\n\r\n";
                if (model.feedbackLanguage != "vn")
                    essay = "Given the following paragraph:\r\n\r\n" + model.essay + "\r\n\r\n";

                string request = "Liệt kê các từ hoặc cụm từ được sử dụng không chính xác hoặc cần cải thiện trong đoạn văn. Trả lời theo định dạng sau:\r\n\r\n- <a>: <b> \r\n\r\nTrong đó, <a> là từ hoặc cụm từ được sử dụng không chính xác hoặc có thể cải thiện. <b> là miêu tả về vấn đề và cách cải thiện. \r\n";

                if (model.feedbackLanguage != "vn")
                    request = "Point out words or phrases that are used inaccurately or need improvement in the paragraph. Respond in the following format:\r\n\r\n- <a>: <b>\r\n\r\nWhere <a> is the word or phrase that is inaccurately used or could be improved. <b> is the description of the issue and how to improve it.\"\r\n";

                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.ChatGPTTurbo_16k,
                    Temperature = 0.1,
                    MaxTokens = 2000,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.Assistant, essay),
                        new ChatMessage(ChatMessageRole.User, request)
                    }
                });

                return taskResponseResult.Choices[0].Message.TextContent;


            }
            catch (Exception e)
            {
                if (model.feedbackLanguage != "vn")
                    return "- No error found.";
                else
                    return "- Không tìm thấy lỗi nào.";
            }
        }

        public async Task<string> getAIFeedbackForCriteriaV2(CriteriaFeedbackModel model)
        {
            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string topic = "";
                string response = "";
                if (model.topic == "The writing topic is not provided")
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        response = "Given the following IELTS Academic Writing Task 1 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic = "Given the following chart information for the IELTS Academic Writing Task 1: \r\n\r\n" + model.chartDescription + "\r\n\r\n";
                        }
                    }
                    else // Academic Writing Task 2
                    {
                        response = "Given the following IELTS Academic Writing Task 2 essay:\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }
                else
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        topic = "Given the following IELTS Academic Writing Task 1 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        if (!String.IsNullOrEmpty(model.chartDescription))
                        {
                            topic += model.chartDescription;
                        }
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";

                    }
                    else // Academic Writing Task 2
                    {
                        topic = "Given the following IELTS Academic Writing Task 2 topic:\r\n\r\n" + model.topic + "\r\n\r\n";
                        response = "Given the following writing essay for the topic :\r\n\r\n" + model.essay + "\r\n\r\n";
                    }
                }


                string request = "";
                switch (model.criteriaName)
                {
                    case "Critical Errors":
                        request = "Xác định những lỗi về từ vựng và ngữ pháp trong bài luận. Với mỗi lỗi, đề xuất một bản chỉnh sửa và giải thích bằng tiếng Việt tại sao nó phù hợp hơn với ngữ cảnh được cho.";
                        if (model.feedbackLanguage != "vn")
                            request = "Identify words or phrases in the writing essay where vocabulary or grammar are not correctly used. For each word or phrase, offer a suggested revision and explain why it is more appropriate in the given context.";
                        break;
                    case "Arguments Assessment":
                        request = "Xác định lập luận chính cho mỗi đoạn văn trong bài viết. Cho mỗi lập luận, cung cấp các thông tin sau:\r\n- Lập luận: viết lại chính xác từng câu từng chữ lập luận đó như xuất hiện trong bài viết bằng tiếng anh.\r\n- Đánh giá: đánh giá điểm mạnh và điểm yếu của luận điểm xét về các khía cạnh như tính rõ ràng, tính chặt chẽ, sự mạch lạc và sức nặng của bằng chứng.\r\n- Phiên bản cải thiện: cung cấp một phiên bản đã được cải thiện của lập luận đó bằng tiếng anh. \r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Identify the main argument of each paragraph in the writing essay. For each argument, provide the following information:\r\n- Argument: write the argument exactly like how it appears in the writing\r\n- Assessment: provide feedback for the argument in term of strengths and weaknesses.\r\non clarity, relevance, coherence, and strength of evidence.\r\n- Improved version: provide an improved version of the argument\r\n";
                        break;
                    case "Task Achievement":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Task Achievement. Phản hồi gồm 4 phần sau:\r\n\r\n- Điểm số: là 1 số từ 0 tới 9.0 tương ứng với điểm của bài luận cho tiêu chí Task Achievement.\r\n\r\n- Điểm mạnh: liệt kê những điểm mà bài luận đã làm tốt cho tiêu chí Task Achievement. Cho mỗi điểm mạnh, giải thích tại sao đó là điểm mạnh và liệt kê các ví dụ cụ thể trong bài viết.\r\n\r\n- Điểm cần cải thiện: liệt kê những điểm mà bài luận chưa làm tốt cho tiêu chí Task Achievement. Cho mỗi điểm, giải thích tại sao điểm đó lại chưa tốt, liệt kê những ví dụ cụ thể trong bài viết, và đưa ra khuyến nghị cụ thể.\r\n\r\n- Hướng dẫn cải thiện: liệt kê các bước học viên cần làm để cải thiện điểm số của mình cho tiêu chí Task Achievement. Hướng dẫn cần bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể liên quan đến chủ đề viết.\r\n";

                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Task Achievement criterion. The feedback contains the following 4 parts:\r\n\r\n- Score: a number ranging from 0 to 9.0 associated with the score of the essay for the Task Achievement critierion.\r\n \r\n- Strengths: list the strengths of the essay for the Task Achievement criterion. For each strength, explain why it is a strength and provide specific examples from the essay.\r\n\r\n- Areas of improvement: list the areas of improvement for the essay for the Task Achievement criterion. For each area, the feedback should explain why it need improvement, provide specific examples from the essay, and offer specific recommendations.\r\n\r\n- How to improve: provide the step-by-step guidance on how the learner can improve the score for the Task Achievement criterion. The guidance should include both general advice and specific instructions for the writing topic. \r\n";

                        break;
                    case "Task Response":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Task Response. Phản hồi gồm 4 phần sau:\r\n\r\n- Điểm số: là 1 số từ 0 tới 9.0 tương ứng với điểm của bài luận cho tiêu chí Task Response.\r\n\r\n- Điểm mạnh: liệt kê những điểm mà bài luận đã làm tốt cho tiêu chí Task Response. Cho mỗi điểm mạnh, giải thích tại sao đó là điểm mạnh và liệt kê các ví dụ cụ thể trong bài viết.\r\n\r\n- Điểm cần cải thiện: liệt kê những điểm mà bài luận chưa làm tốt cho tiêu chí Task Response. Cho mỗi điểm, giải thích tại sao điểm đó lại chưa tốt, liệt kê những ví dụ cụ thể trong bài viết, và đưa ra khuyến nghị cụ thể.\r\n\r\n- Hướng dẫn cải thiện: liệt kê các bước học viên cần làm để cải thiện điểm số của mình cho tiêu chí Task Response. Hướng dẫn cần bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể liên quan đến chủ đề viết.\r\n";

                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Task Response criterion. The feedback contains the following 4 parts:\r\n\r\n- Score: a number ranging from 0 to 9.0 associated with the score of the essay for the Task Response critierion.\r\n \r\n- Strengths: list the strengths of the essay for the Task Response criterion. For each strength, explain why it is a strength and provide specific examples from the essay.\r\n\r\n- Areas of improvement: list the areas of improvement for the essay for the Task Response criterion. For each area, the feedback should explain why it need improvement, provide specific examples from the essay, and offer specific recommendations.\r\n\r\n- How to improve: provide the step-by-step guidance on how the learner can improve the score for the Task Response criterion. The guidance should include both general advice and specific instructions for the writing topic.\r\n";

                        break;
                    case "Coherence & Cohesion":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Coherence & Cohesion. Phản hồi gồm 4 phần sau:\r\n\r\n- Điểm số: là 1 số từ 0 tới 9.0 tương ứng với điểm của bài luận cho tiêu chí Coherence & Cohesion.\r\n\r\n- Điểm mạnh: liệt kê những điểm mà bài luận đã làm tốt cho tiêu chí Coherence & Cohesion. Cho mỗi điểm mạnh, giải thích tại sao đó là điểm mạnh và liệt kê các ví dụ cụ thể trong bài viết.\r\n\r\n- Điểm cần cải thiện: liệt kê những điểm mà bài luận chưa làm tốt cho tiêu chí Coherence & Cohesion. Cho mỗi điểm, giải thích tại sao điểm đó lại chưa tốt, liệt kê những ví dụ cụ thể trong bài viết, và đưa ra khuyến nghị cụ thể.\r\n\r\n- Hướng dẫn cải thiện: liệt kê các bước học viên cần làm để cải thiện điểm số của mình cho tiêu chí Coherence & Cohesion. Hướng dẫn cần bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể liên quan đến chủ đề viết.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Coherence & Cohesion criterion. The feedback contains the following 4 parts:\r\n\r\n- Score: a number ranging from 0 to 9.0 associated with the score of the essay for the Coherence & Cohesion critierion.\r\n \r\n- Strengths: list the strengths of the essay for the Coherence & Cohesion criterion. For each strength, explain why it is a strength and provide specific examples from the essay.\r\n\r\n- Areas of improvement: list the areas of improvement for the essay for the Coherence & Cohesion criterion. For each area, the feedback should explain why it need improvement, provide specific examples from the essay, and offer specific recommendations.\r\n\r\n- How to improve: provide the step-by-step guidance on how the learner can improve the score for the Coherence & Cohesion criterion. The guidance should include both general advice and specific instructions for the writing topic. \r\n";

                        break;
                    case "Lexical Resource":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Lexical Resource. Phản hồi gồm 4 phần sau:\r\n\r\n- Điểm số: là 1 số từ 0 tới 9.0 tương ứng với điểm của bài luận cho tiêu chí Lexical Resource.\r\n\r\n- Điểm mạnh: liệt kê những điểm mà bài luận đã làm tốt cho tiêu chí Lexical Resource. Cho mỗi điểm mạnh, giải thích tại sao đó là điểm mạnh và liệt kê các ví dụ cụ thể trong bài viết.\r\n\r\n- Điểm cần cải thiện: liệt kê những điểm mà bài luận chưa làm tốt cho tiêu chí Lexical Resource. Cho mỗi điểm, giải thích tại sao điểm đó lại chưa tốt, liệt kê những ví dụ cụ thể trong bài viết, và đưa ra khuyến nghị cụ thể.\r\n\r\n- Hướng dẫn cải thiện: liệt kê các bước học viên cần làm để cải thiện điểm số của mình cho tiêu chí Lexical Resource. Hướng dẫn cần bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể liên quan đến chủ đề viết.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Lexical Resource criterion. The feedback contains the following 4 parts:\r\n\r\n- Score: a number ranging from 0 to 9.0 associated with the score of the essay for the Lexical Resource critierion.\r\n \r\n- Strengths: list the strengths of the essay for the Lexical Resource criterion. For each strength, explain why it is a strength and provide specific examples from the essay.\r\n\r\n- Areas of improvement: list the areas of improvement for the essay for the Lexical Resource criterion. For each area, the feedback should explain why it need improvement, provide specific examples from the essay, and offer specific recommendations.\r\n\r\n- How to improve: provide the step-by-step guidance on how the learner can improve the score for the Lexical Resource criterion. The guidance should include both general advice and specific instructions for the writing topic. \r\n";

                        break;
                    case "Grammatical Range & Accuracy":
                        request = "Cung cấp phản hồi bằng tiếng Việt cho bài luận cho tiêu chí Grammatical Range & Accuracy. Phản hồi gồm 4 phần sau:\r\n\r\n- Điểm số: là 1 số từ 0 tới 9.0 tương ứng với điểm của bài luận cho tiêu chí Grammatical Range & Accuracy.\r\n\r\n- Điểm mạnh: liệt kê những điểm mà bài luận đã làm tốt cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm mạnh, giải thích tại sao đó là điểm mạnh và liệt kê các ví dụ cụ thể trong bài viết.\r\n\r\n- Điểm cần cải thiện: liệt kê những điểm mà bài luận chưa làm tốt cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm, giải thích tại sao điểm đó lại chưa tốt, liệt kê những ví dụ cụ thể trong bài viết, và đưa ra khuyến nghị cụ thể.\r\n\r\n- Hướng dẫn cải thiện: liệt kê các bước học viên cần làm để cải thiện điểm số của mình cho tiêu chí Grammatical Range & Accuracy. Hướng dẫn cần bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể liên quan đến chủ đề viết.\r\n";

                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Grammatical Range & Accuracy criterion. The feedback contains the following 4 parts:\r\n\r\n- Score: a number ranging from 0 to 9.0 associated with the score of the essay for the Grammatical Range & Accuracy critierion.\r\n \r\n- Strengths: list the strengths of the essay for the Grammatical Range & Accuracy criterion. For each strength, explain why it is a strength and provide specific examples from the essay.\r\n\r\n- Areas of improvement: list the areas of improvement for the essay for the Grammatical Range & Accuracy criterion. For each area, the feedback should explain why it need improvement, provide specific examples from the essay, and offer specific recommendations.\r\n\r\n- How to improve: provide the step-by-step guidance on how the learner can improve the score for the Grammatical Range & Accuracy criterion. The guidance should include both general advice and specific instructions for the writing topic.\r\n";

                        break;
                    case "Overall Score & Feedback":
                        if (model.task == "Academic Writing Task 1")
                        {
                            request = "Cung cấp phản hồi tổng quát bằng tiếng Việt cho bài. Phản hồi gồm 4 phần sau:\r\n\r\n- Điểm số: là 1 số từ 0 tới 9.0 tương ứng với điểm tổng quát của bài luận.\r\n\r\n- Đánh giá tổng quan: cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Achievement, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy\r\n\r\n- Những điểm cần cải thiện: Cung cấp phản hồi về những điểm mà bài luận làm chưa tốt. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n\r\n- Khuyễn nghị cho học viên: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số cho bài viết của mình.\r\n";

                            if (model.feedbackLanguage != "vn")
                                request = "Provide overall feedback for the essay. The feedback contains the following 4 parts:\r\n\r\n- Overall band score: a number ranging from 0 to 9.0 associated with the overall band score of the essay.\r\n\r\n- Overall performance: provide a comprehensive overview about the quality of the essay, covering all four criteria: Task Achievement, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n\r\n- Areas of improvements: provide feedback about the aspects the student needs to improve in the essay. The feedback should emphasize the aspects that, if refined, would significantly enhance the quality and score of the writing.\r\n\r\n- How to improve: provide general guidance for the student to improve. \r\n";
                        }
                        else
                        {
                            request = "Cung cấp phản hồi tổng quát bằng tiếng Việt cho bài. Phản hồi gồm 4 phần sau:\r\n\r\n- Điểm số: là 1 số từ 0 tới 9.0 tương ứng với điểm tổng quát của bài luận.\r\n\r\n- Đánh giá tổng quan: cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Achievement, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy\r\n\r\n- Những điểm cần cải thiện: Cung cấp phản hồi về những điểm mà bài luận làm chưa tốt. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n\r\n- Khuyễn nghị cho học viên: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số cho bài viết của mình.\r\n";

                            if (model.feedbackLanguage != "vn")
                                request = "Provide overall feedback for the essay. The feedback contains the following 4 parts:\r\n\r\n- Overall band score: a number ranging from 0 to 9.0 associated with the overall band score of the essay.\r\n\r\n- Overall performance: provide a comprehensive overview about the quality of the essay, covering all four criteria: Task Achievement, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n\r\n- Areas of improvements: provide feedback about the aspects the student needs to improve in the essay. The feedback should emphasize the aspects that, if refined, would significantly enhance the quality and score of the writing.\r\n\r\n- How to improve: provide general guidance for the student to improve. \r\n";
                        }

                        break;
                    default:
                        break;
                }

                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.ChatGPTTurbo,
                    Temperature = 0.1,
                    Messages = new ChatMessage[] {
                            new ChatMessage(ChatMessageRole.Assistant, topic),
                            new ChatMessage(ChatMessageRole.Assistant, response),
                            new ChatMessage(ChatMessageRole.User, request)
                        }
                });

                return taskResponseResult.Choices[0].Message.TextContent;


            }
            catch (Exception e)
            {
                return "Hệ thống không thể cung cấp phản hồi.";
            }
        }

        public async Task<ImageToTopicAndEssayModel> getWritingTextFromImage(byte[] imageData)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));

            ImageToTopicAndEssayModel result = new ImageToTopicAndEssayModel
            {
                essay = "Không thể trích xuất từ ảnh",
                topic = "Không thể trích xuất từ ảnh",
            };

            if (imageData != null && imageData.Length > 0)
            {
                ChatMessage message = new ChatMessage();
                message.Role = ChatMessageRole.User;
                message.TextContent = "Provide me with the full content of the writing topic and the writing essay on the image. If the image contains both the writing topic and the essay, your response must contains 2 parts: topic content and essay content. The topic content must be placed inside <topic> and </topic> tags. The essay content must be placed inside the <essay> and </essays> tags. If the image contains only the writing essay, your response must contains the essay content that is placed inside the <essay> and </essay> tags.";
                // Add the chart to the message 
                message.Images = new List<ChatMessage.ImageInput>();
                message.Images.Add(ChatMessage.ImageInput.FromImageBytes(imageData));

                var chartResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Vision,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    Messages = new ChatMessage[] {
                        message
                    }
                });
                string response = chartResult.Choices[0].Message.TextContent;

                int startTopicIndex = response.IndexOf("<topic>");
                if(startTopicIndex >= 0)
                {
                    startTopicIndex += 7;
                    int endTopicIndex = response.IndexOf("</topic>");
                    int length = endTopicIndex - startTopicIndex;
                    result.topic = response.Substring(startTopicIndex, length);
                }

                int startEssayIndex = response.IndexOf("<essay>");
                if (startEssayIndex >= 0)
                {
                    startEssayIndex += 7;
                    int endEssayIndex = response.IndexOf("</essay>");
                    int length = endEssayIndex - startEssayIndex;
                    result.essay = response.Substring(startEssayIndex, length);
                }
               
            }
            return result;
        }

        public async Task<string> getChartDescription(string filePath)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string chart = "";
            if (!String.IsNullOrEmpty(filePath))
            {
                ChatMessage message = new ChatMessage();
                message.Role = ChatMessageRole.User;
                message.TextContent = "Provide me with the full content of the attached chart.";
                // Add the chart to the message 
                message.Images = new List<ChatMessage.ImageInput>();
                message.Images.Add(ChatMessage.ImageInput.FromFile(filePath));

                var chartResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Vision,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    Messages = new ChatMessage[] {
                        message
                    }
                });

                chart = "\r\n" + chartResult.Choices[0].Message.TextContent + "\r\n";
            }
            return chart;
        }


        public async Task<AutomatedFeedbackModel> getAIFeedbackForCriteria(CriteriaFeedbackModel model)
        {
            AutomatedFeedbackModel result = new AutomatedFeedbackModel();
            result.score = 0;
            result.feedback = new FeedbackModel
            {
                performance = "Hệ thống không thể cung cấp phản hồi cho bài viết.",
                strengths = "Hệ thống không thể cung cấp phản hồi cho bài viết.",
                recommendations = "Hệ thống không thể cung cấp phản hồi cho bài viết",
                weaknesses = "Hệ thống không thể cung cấp phản hồi cho bài viết.",
            };

            try
            {
                OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
                string rubric = "";
                string topic = "";
                string response = "";
                if (model.topic == "The writing topic is not provided")
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        rubric = "Given the following rubric descriptors for the IELTS Academic Writing Task 1 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Achievement\n1.1. Criteria Description\nThe Task Achievement criterion in IELTS Academic Writing Task 1 evaluates how well you summarize key trends, compare data, cover all task requirements, and report features accurately from visuals like graphs or charts, focusing on your ability to identify and convey the most important information.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the task. Any copied rubric must be discounted.\n\n- Band 2: The content barely relates to the task.\n\n- Band 3: The response does not address the requirements of the task (possibly because of misunderstanding of the data/diagram/situation). Key features/bullet points which are presented may be largely irrelevant. Limited information is presented, and this may be used repetitively.\n\n- Band 4: The response is an attempt to address the task. Few key features have been selected. be confused. The tone may be inappropriate. The format may be inappropriate. Key features/bullet points which are presented may be irrelevant, repetitive, inaccurate, or inappropriate.\n\n- Band 5: The response generally addresses the requirements of the task. The format may be inappropriate in places. Key features which are selected are not adequately covered. The recounting of detail is mainly mechanical. There may be no data to support the description. There may be a tendency to focus on details (without referring to the bigger picture). The inclusion of irrelevant, inappropriate or inaccurate material in key areas detracts from the task achievement. There is limited detail when extending and illustrating the main points.\n\n- Band 6: The response focuses on the requirements of the task and an appropriate format is used. Key features which are selected are covered and adequately highlighted. A relevant overview is attempted. Information is appropriately selected and supported using figures/data. Some irrelevant, inappropriate or inaccurate information may occur in areas of detail or when illustrating or extending the main points. Some details may be missing (or excessive) and further extension or illustration may be needed.\n\n- Band 7: The response covers the requirements of the task. The content is relevant and accurate. There may be a few omissions or lapses. The format is appropriate. Key features which are selected are covered and clearly highlighted but could be more fully or more appropriately illustrated or extended. It presents a clear overview, the data are appropriately categorized, and main trends or differences are identified.\n\n- Band 8: The response covers all the requirements of the task appropriately, relevantly and sufficiently. Key features are skillfully selected, and clearly presented, highlighted and illustrated. There may be occasional omissions or lapses in content.\n\n- Band 9: All the requirements of the task are fully and appropriately satisfied. There may be extremely rare lapses in content.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion assesses your ability to organize and link information clearly and logically in IELTS Academic Writing Task 1. It focuses on effective paragraphing, logical sequencing of ideas, and the use of cohesive devices (like linking words and pronouns) to help the reader understand the relationships between ideas.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. Minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing.\n\n- Band 4: Information and ideas are evident but not arranged coherently, and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error.\n\n- Band 7: Information and ideas are logically organized and there is a clear progression throughout the response. A few lapses may occur. A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence or cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion evaluates your range of vocabulary, accuracy in word choice, and ability to use words appropriately to express precise meanings in IELTS Academic Writing Task 1. It focuses on your ability to use a variety of vocabulary to describe data, trends, and processes clearly and accurately.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice, and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation, and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings within the scope of the task. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are evident within the scope of the task. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion assesses your use of sentence structures and grammatical accuracy in IELTS Academic Writing Task 1. It focuses on your ability to construct a range of sentence types correctly and use grammar precisely to convey information and ideas effectively.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorized phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through.  Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures within the scope of the task is flexibly and accurately used. The majority of sentences are error free, and punctuation is well managed. Occasional, nonsystematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures within the scope of the task is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n</rubric>\n";
                        topic = "Given that the Academic Writing Task 1 topic is not provided and has to be inferred from the essay.";
                        topic += model.chartDescription;
                        response = "Given the following IELTS Academic Writing Task 1 essay response delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + model.essay + "\r\n</response>\r\n";

                    }
                    else // Academic Writing Task 1
                    {
                        rubric = "Given the following rubric descriptors for the IELTS Academic Writing Task 2 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Response\n1.1. Criteria Description\nThe Task Response criterion in IELTS Academic Writing Task 2 assesses how well you develop and support your ideas in response to the question. It focuses on your ability to present a clear, relevant position, fully extend and support your main ideas, and answer all parts of the task prompt comprehensively.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the prompt. Any copied rubric must be discounted.\n\n- Band 2: The content is barely related to the prompt. No position can be identified. There may be glimpses of one or two ideas without development.\n\n- Band 3: No part of the prompt is adequately addressed, or the prompt has been misunderstood. No relevant position can be identified, and/or there is little direct response to the question/s. There are few ideas, and these may be irrelevant or insufficiently developed.\n\n- Band 4: The prompt is tackled in a minimal way, or the answer is tangential, possibly due to some misunderstanding of the prompt. The format may be inappropriate. A position is discernible, but the reader has to read carefully to find it. Main ideas are difficult to identify and such ideas that are identifiable may lack relevance, clarity and/or support. Large parts of the response may be repetitive.\n\n- Band 5: The main parts of the prompt are incompletely addressed. The format may be inappropriate in places. The writer expresses a position, but the development is not always clear. Some main ideas are put forward, but they are limited and are not sufficiently developed and/or there may be irrelevant detail. There may be some repetition.\n\n- Band 6: The main parts of the prompt are addressed (though some may be more fully covered than others). An appropriate format is used. A position is presented that is directly relevant to the prompt, although the conclusions drawn may be unclear, unjustified or repetitive. Main ideas are relevant, but some may be insufficiently developed or may lack clarity, while some supporting arguments and evidence may be less relevant or inadequate.\n\n- Band 7: The main parts of the prompt are appropriately addressed. A clear and developed position is presented. Main ideas are extended and supported but there may be a tendency to over generalize or there may be a lack of focus and precision in supporting ideas/material.\n\n- Band 8: The prompt is appropriately and sufficiently addressed. A clear and well-developed position is presented in response to the question/s. Ideas are relevant, well extended and supported. There may be occasional omissions or lapses in content.\n\n- Band 9: The prompt is appropriately addressed and explored in depth. A clear and fully developed position is presented which directly answers the question/s. Ideas are relevant, fully extended and well supported. Any lapses in content or support are extremely rare.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion in IELTS Academic Writing Task 2 evaluates your ability to organize ideas logically and connect them smoothly. It focuses on clear overall structure, logical sequencing of paragraphs and ideas, and the effective use of cohesive devices (such as linking words and pronouns) to guide the reader through your argument or narrative seamlessly.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. There is minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing. Any attempts at paragraphing are unhelpful.\n\n- Band 4: Information and ideas are evident but not arranged coherently and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing. There may be no paragraphing and/or no clear main topic within paragraphs.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution. Paragraphing may be inadequate or missing.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error. Paragraphing may not always be logical and/or the central topic may not always be clear.\n\n- Band 7: Information and ideas are logically organized, and there is a clear progression throughout the response. (A few lapses may occur, but these are minor). A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use. Paragraphing is generally used effectively to support overall coherence, and the sequencing of ideas within a paragraph is generally logical.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence and cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion in IELTS Academic Writing Task 2 measures your range of vocabulary, the precision of your word choices, and your ability to use words appropriately for various contexts. It assesses your skill in using vocabulary flexibly and accurately to express ideas and opinions, including the effective use of synonyms and collocations, without errors that hinder communication.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: - Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over-dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e.g. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk-taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are widely evident. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion in IELTS Academic Writing Task 2 evaluates your ability to use a wide range of grammar structures accurately. It focuses on your capacity to construct complex sentences effectively, use punctuation correctly, and apply grammatical forms with flexibility to clearly express detailed reasoning and arguments without making errors that obscure meaning.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorised phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through. Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication.\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error-free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures is flexibly and accurately used. The majority of sentences are error-free, and punctuation is well managed. Occasional, non-systematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n\n</rubric>\n";
                        topic = "Given that the Academic Writing Task 2 topic is not provided and has to be inferred from the essay.";
                        response = "Given the following IELTS Academic Writing Task 2 essay response delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + model.essay + "\r\n</response>\r\n";
                    }
                }
                else
                {
                    if (model.task == "Academic Writing Task 1")
                    {
                        rubric = "Given the following rubric descriptors for the IELTS Academic Writing Task 1 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Achievement\n1.1. Criteria Description\nThe Task Achievement criterion in IELTS Academic Writing Task 1 evaluates how well you summarize key trends, compare data, cover all task requirements, and report features accurately from visuals like graphs or charts, focusing on your ability to identify and convey the most important information.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the task. Any copied rubric must be discounted.\n\n- Band 2: The content barely relates to the task.\n\n- Band 3: The response does not address the requirements of the task (possibly because of misunderstanding of the data/diagram/situation). Key features/bullet points which are presented may be largely irrelevant. Limited information is presented, and this may be used repetitively.\n\n- Band 4: The response is an attempt to address the task. Few key features have been selected. be confused. The tone may be inappropriate. The format may be inappropriate. Key features/bullet points which are presented may be irrelevant, repetitive, inaccurate, or inappropriate.\n\n- Band 5: The response generally addresses the requirements of the task. The format may be inappropriate in places. Key features which are selected are not adequately covered. The recounting of detail is mainly mechanical. There may be no data to support the description. There may be a tendency to focus on details (without referring to the bigger picture). The inclusion of irrelevant, inappropriate or inaccurate material in key areas detracts from the task achievement. There is limited detail when extending and illustrating the main points.\n\n- Band 6: The response focuses on the requirements of the task and an appropriate format is used. Key features which are selected are covered and adequately highlighted. A relevant overview is attempted. Information is appropriately selected and supported using figures/data. Some irrelevant, inappropriate or inaccurate information may occur in areas of detail or when illustrating or extending the main points. Some details may be missing (or excessive) and further extension or illustration may be needed.\n\n- Band 7: The response covers the requirements of the task. The content is relevant and accurate. There may be a few omissions or lapses. The format is appropriate. Key features which are selected are covered and clearly highlighted but could be more fully or more appropriately illustrated or extended. It presents a clear overview, the data are appropriately categorized, and main trends or differences are identified.\n\n- Band 8: The response covers all the requirements of the task appropriately, relevantly and sufficiently. Key features are skillfully selected, and clearly presented, highlighted and illustrated. There may be occasional omissions or lapses in content.\n\n- Band 9: All the requirements of the task are fully and appropriately satisfied. There may be extremely rare lapses in content.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion assesses your ability to organize and link information clearly and logically in IELTS Academic Writing Task 1. It focuses on effective paragraphing, logical sequencing of ideas, and the use of cohesive devices (like linking words and pronouns) to help the reader understand the relationships between ideas.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. Minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing.\n\n- Band 4: Information and ideas are evident but not arranged coherently, and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error.\n\n- Band 7: Information and ideas are logically organized and there is a clear progression throughout the response. A few lapses may occur. A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence or cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion evaluates your range of vocabulary, accuracy in word choice, and ability to use words appropriately to express precise meanings in IELTS Academic Writing Task 1. It focuses on your ability to use a variety of vocabulary to describe data, trends, and processes clearly and accurately.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice, and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation, and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings within the scope of the task. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are evident within the scope of the task. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion assesses your use of sentence structures and grammatical accuracy in IELTS Academic Writing Task 1. It focuses on your ability to construct a range of sentence types correctly and use grammar precisely to convey information and ideas effectively.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorized phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through.  Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures within the scope of the task is flexibly and accurately used. The majority of sentences are error free, and punctuation is well managed. Occasional, nonsystematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures within the scope of the task is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n</rubric>\n";
                        topic = "Given the following Academic Writing Task 1 topic delimited by <topic> and </topic> tags:\r\n\r\n<topic>" + model.topic + "\r\n\r\n</topic>\r\n";
                        topic += model.chartDescription;
                        response = "Given the following writing response for the topic delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + model.essay + "\r\n</response>\r\n";
                    }
                    else // Academic Writing Task 1
                    {
                        rubric = "Given the following rubric descriptors for the IELTS Academic Writing Task 2 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Response\n1.1. Criteria Description\nThe Task Response criterion in IELTS Academic Writing Task 2 assesses how well you develop and support your ideas in response to the question. It focuses on your ability to present a clear, relevant position, fully extend and support your main ideas, and answer all parts of the task prompt comprehensively.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the prompt. Any copied rubric must be discounted.\n\n- Band 2: The content is barely related to the prompt. No position can be identified. There may be glimpses of one or two ideas without development.\n\n- Band 3: No part of the prompt is adequately addressed, or the prompt has been misunderstood. No relevant position can be identified, and/or there is little direct response to the question/s. There are few ideas, and these may be irrelevant or insufficiently developed.\n\n- Band 4: The prompt is tackled in a minimal way, or the answer is tangential, possibly due to some misunderstanding of the prompt. The format may be inappropriate. A position is discernible, but the reader has to read carefully to find it. Main ideas are difficult to identify and such ideas that are identifiable may lack relevance, clarity and/or support. Large parts of the response may be repetitive.\n\n- Band 5: The main parts of the prompt are incompletely addressed. The format may be inappropriate in places. The writer expresses a position, but the development is not always clear. Some main ideas are put forward, but they are limited and are not sufficiently developed and/or there may be irrelevant detail. There may be some repetition.\n\n- Band 6: The main parts of the prompt are addressed (though some may be more fully covered than others). An appropriate format is used. A position is presented that is directly relevant to the prompt, although the conclusions drawn may be unclear, unjustified or repetitive. Main ideas are relevant, but some may be insufficiently developed or may lack clarity, while some supporting arguments and evidence may be less relevant or inadequate.\n\n- Band 7: The main parts of the prompt are appropriately addressed. A clear and developed position is presented. Main ideas are extended and supported but there may be a tendency to over generalize or there may be a lack of focus and precision in supporting ideas/material.\n\n- Band 8: The prompt is appropriately and sufficiently addressed. A clear and well-developed position is presented in response to the question/s. Ideas are relevant, well extended and supported. There may be occasional omissions or lapses in content.\n\n- Band 9: The prompt is appropriately addressed and explored in depth. A clear and fully developed position is presented which directly answers the question/s. Ideas are relevant, fully extended and well supported. Any lapses in content or support are extremely rare.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion in IELTS Academic Writing Task 2 evaluates your ability to organize ideas logically and connect them smoothly. It focuses on clear overall structure, logical sequencing of paragraphs and ideas, and the effective use of cohesive devices (such as linking words and pronouns) to guide the reader through your argument or narrative seamlessly.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. There is minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing. Any attempts at paragraphing are unhelpful.\n\n- Band 4: Information and ideas are evident but not arranged coherently and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing. There may be no paragraphing and/or no clear main topic within paragraphs.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution. Paragraphing may be inadequate or missing.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error. Paragraphing may not always be logical and/or the central topic may not always be clear.\n\n- Band 7: Information and ideas are logically organized, and there is a clear progression throughout the response. (A few lapses may occur, but these are minor). A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use. Paragraphing is generally used effectively to support overall coherence, and the sequencing of ideas within a paragraph is generally logical.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence and cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion in IELTS Academic Writing Task 2 measures your range of vocabulary, the precision of your word choices, and your ability to use words appropriately for various contexts. It assesses your skill in using vocabulary flexibly and accurately to express ideas and opinions, including the effective use of synonyms and collocations, without errors that hinder communication.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: - Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over-dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e.g. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk-taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are widely evident. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion in IELTS Academic Writing Task 2 evaluates your ability to use a wide range of grammar structures accurately. It focuses on your capacity to construct complex sentences effectively, use punctuation correctly, and apply grammatical forms with flexibility to clearly express detailed reasoning and arguments without making errors that obscure meaning.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorised phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through. Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication.\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error-free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures is flexibly and accurately used. The majority of sentences are error-free, and punctuation is well managed. Occasional, non-systematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n\n</rubric>\n";
                        topic = "Given the following Academic Writing Task 2 topic delimited by <topic> and </topic> tags:\r\n\r\n<topic>" + model.topic + "\r\n\r\n</topic>\r\n";
                        response = "Given the following writing response for the topic delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + model.essay + "\r\n</response>\r\n";
                    }
                }


                //if (model.task == "Academic Writing Task 1")
                //{
                //    rubric = "Given the following rubric descriptors for the IELTS Academic Writing Task 1 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Achievement\n1.1. Criteria Description\nThe Task Achievement criterion in IELTS Academic Writing Task 1 evaluates how well you summarize key trends, compare data, cover all task requirements, and report features accurately from visuals like graphs or charts, focusing on your ability to identify and convey the most important information.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the task. Any copied rubric must be discounted.\n\n- Band 2: The content barely relates to the task.\n\n- Band 3: The response does not address the requirements of the task (possibly because of misunderstanding of the data/diagram/situation). Key features/bullet points which are presented may be largely irrelevant. Limited information is presented, and this may be used repetitively.\n\n- Band 4: The response is an attempt to address the task. Few key features have been selected. be confused. The tone may be inappropriate. The format may be inappropriate. Key features/bullet points which are presented may be irrelevant, repetitive, inaccurate, or inappropriate.\n\n- Band 5: The response generally addresses the requirements of the task. The format may be inappropriate in places. Key features which are selected are not adequately covered. The recounting of detail is mainly mechanical. There may be no data to support the description. There may be a tendency to focus on details (without referring to the bigger picture). The inclusion of irrelevant, inappropriate or inaccurate material in key areas detracts from the task achievement. There is limited detail when extending and illustrating the main points.\n\n- Band 6: The response focuses on the requirements of the task and an appropriate format is used. Key features which are selected are covered and adequately highlighted. A relevant overview is attempted. Information is appropriately selected and supported using figures/data. Some irrelevant, inappropriate or inaccurate information may occur in areas of detail or when illustrating or extending the main points. Some details may be missing (or excessive) and further extension or illustration may be needed.\n\n- Band 7: The response covers the requirements of the task. The content is relevant and accurate. There may be a few omissions or lapses. The format is appropriate. Key features which are selected are covered and clearly highlighted but could be more fully or more appropriately illustrated or extended. It presents a clear overview, the data are appropriately categorized, and main trends or differences are identified.\n\n- Band 8: The response covers all the requirements of the task appropriately, relevantly and sufficiently. Key features are skillfully selected, and clearly presented, highlighted and illustrated. There may be occasional omissions or lapses in content.\n\n- Band 9: All the requirements of the task are fully and appropriately satisfied. There may be extremely rare lapses in content.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion assesses your ability to organize and link information clearly and logically in IELTS Academic Writing Task 1. It focuses on effective paragraphing, logical sequencing of ideas, and the use of cohesive devices (like linking words and pronouns) to help the reader understand the relationships between ideas.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. Minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing.\n\n- Band 4: Information and ideas are evident but not arranged coherently, and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error.\n\n- Band 7: Information and ideas are logically organized and there is a clear progression throughout the response. A few lapses may occur. A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence or cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion evaluates your range of vocabulary, accuracy in word choice, and ability to use words appropriately to express precise meanings in IELTS Academic Writing Task 1. It focuses on your ability to use a variety of vocabulary to describe data, trends, and processes clearly and accurately.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice, and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation, and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings within the scope of the task. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are evident within the scope of the task. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion assesses your use of sentence structures and grammatical accuracy in IELTS Academic Writing Task 1. It focuses on your ability to construct a range of sentence types correctly and use grammar precisely to convey information and ideas effectively.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorized phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through.  Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures within the scope of the task is flexibly and accurately used. The majority of sentences are error free, and punctuation is well managed. Occasional, nonsystematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures within the scope of the task is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n</rubric>\n";
                //    topic += model.chartDescription;
                //}
                //string response = "Given the following writing response for the topic delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + model.essay + "\r\n</response>\r\n";

                string request = "";
                switch (model.criteriaName)
                {
                    case "Critical Errors":
                        request = "Xác định những lỗi về từ vựng và ngữ pháp trong bài luận. Với mỗi lỗi, đề xuất một bản chỉnh sửa và giải thích bằng tiếng Việt tại sao nó phù hợp hơn với ngữ cảnh được cho.";
                        if (model.feedbackLanguage != "vn")
                            request = "Identify words or phrases in the writing essay where vocabulary or grammar are not correctly used. For each word or phrase, offer a suggested revision and explain why it is more appropriate in the given context.";
                        break;
                    case "Arguments Assessment":
                        request = "Xác định các lập luận chính của bài luận. Cho mỗi lập luận, cung cấp các thông tin sau:\r\n- Lập luận: viết lại chính xác từng câu từng chữ lập luận đó như xuất hiện trong bài viết bằng tiếng anh.\r\n- Đánh giá: đánh giá điểm mạnh và điểm yếu của luận điểm xét về các khía cạnh như tính rõ ràng, tính chặt chẽ, sự mạch lạc và sức nặng của bằng chứng.\r\n- Phiên bản cải thiện: cung cấp một phiên bản đã được cải thiện của lập luận đó bằng tiếng anh. \r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Identify the main arguments the writing essay. For each argument, provide the following information:\r\n- Argument: write the argument exactly like how it appears in the writing\r\n- Assessment: provide feedback for the argument in term of strengths and weaknesses.\r\non clarity, relevance, coherence, and strength of evidence.\r\n- Improved version: provide an improved version of the argument\r\n";
                        break;
                    case "Task Achievement":
                        request = "Cung cấp phản hồi cho bài luận cho tiêu chí Task Achievement sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Achievement dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Achievement. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Achievement. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Task Achievement, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Task Achievement criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Task Achievement criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Task Achievement criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Task Achievement criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Task Achievement criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";
                        break;
                    case "Task Response":
                        request = "Cung cấp phản hồi cho bài luận cho tiêu chí Task Response sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Response dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Task Response, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Task Response criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Task Response criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Task Response criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Task Response criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Task Response criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";
                        break;
                    case "Coherence & Cohesion":
                        request = "Cung cấp phản hồi cho bài luận cho tiêu chí Coherence & Cohesion sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Coherence & Cohesion dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence & Cohesion, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Coherence & Cohesion criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Coherence & Cohesion criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Coherence & Cohesion criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Coherence & Cohesion criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Coherence & Cohesion criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";
                        break;
                    case "Lexical Resource":
                        request = "Cung cấp phản hồi cho bài luận cho tiêu chí Lexical Resource sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Lexical Resource dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Lexical Resource, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Lexical Resource criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Lexical Resource criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Lexical Resource criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Lexical Resource criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Lexical Resource criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";
                        break;
                    case "Grammatical Range & Accuracy":
                        request = "Cung cấp phản hồi cho bài luận cho tiêu chí Grammatical Range & Accuracy sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Grammatical Range & Accuracy dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Grammatical Range & Accuracy, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide feedback for the essay on the Grammatical Range & Accuracy criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Grammatical Range & Accuracy criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Grammatical Range & Accuracy criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Grammatical Range & Accuracy criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Grammatical Range & Accuracy criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";
                        break;
                    case "Overall Score & Feedback":
                        request = "Cung cấp phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm tổng quát của bài viết được chấm theo thang điểm từ 0 tới 9.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Achievement, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n";
                        if (model.feedbackLanguage != "vn")
                            request = "Provide overall feedback for the essay using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall score of the essay ranging from 0 to 9.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n\r\n- The performance property: Contains feedback about the overall quality of the writing. The feedback should provide a comprehensive overview of the essay, covering all four criteria: Task Achievement, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n- The strengths property: Contains feedback about the aspects the essay performs best at. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop these aspects.\r\n- The weaknesses property: Contains feedback about the aspects the student needs to improve in the essay. The feedback should point out and describe in detail the areas that require attention and improvement the most. Emphasize the aspects that, if refined, would significantly enhance the quality and score of the writing.\r\n- The recommendations property: Provides general guidance for the student to improve their essay score. This guidance must include constructive advice, encouraging continuous practice and improvement.\r\n";
                        break;
                    default:
                        break;
                }

                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, request)
                }
                });

                Console.Write(taskResponseResult.Choices[0].Message.TextContent);

                result = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(taskResponseResult.Choices[0].Message.TextContent);

                return result;
            }
            catch (Exception e)
            {
                return result;
            }
        }

        public static string StripHTML(string input)
        {
            return Regex.Replace(input, "<.*?>", String.Empty);
        }

        public async Task GetDifficultyLevelForAllQuestions()
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string task1Criteria = "You will be given a IELTS academic writing task 1 topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\n•\tEasy: Topics are common, widely recognized, and relatable to the general public. Specialized knowledge is not required, and test takers can generate ideas just by critical thinking about the topic. \n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential. Data or processes may include some unfamiliar elements but are generally accessible.\n•\tHard: Topics may be quite specialized or technical. Often includes data, or processes that are not commonly encountered in everyday contexts.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string task2Criteria = "You will be given a IELTS academic writing task 2 topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\n•\tEasy: Topics are common, widely recognized, and relatable to the general public. Specialized knowledge is not required, and test takers can readily generate ideas and examples from their personal experiences or common knowledge.\n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential. More critical thinking is needed to develop coherent arguments and counterarguments.\n•\tHard: Topics are specialized or abstract, demanding in-depth knowledge or a deep understanding. These subjects often involve complex concepts, technical details, or nuanced perspectives that go beyond general knowledge.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string independentCriteria = "You will be given a TOEFL independent writing topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\nFamiliarity:\n•\tEasy: Topics are very common and frequently encountered in everyday life. These subjects require minimal specialized knowledge and are broadly relatable.\n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential.\n•\tHard: Topics are specialized or abstract, demanding in-depth knowledge or a deep understanding. These subjects often involve complex concepts, technical details, or nuanced perspectives that go beyond general knowledge.\n\nSimplicity:\n•\tEasy: Questions are straightforward, typically asking for a personal preference or opinion. Easier to organize thoughts and structure the essay into introduction, body paragraphs, and conclusion.\n•\tMedium: Questions may involve a bit more complexity, such as comparing two viewpoints or analyzing a trend. Requires more developed skills in structuring arguments and supporting them with reasons and examples.\n•\tHard: Questions are more complex and might involve abstract thinking or sophisticated arguments. High level of planning, organization, and critical thinking is needed to construct a coherent and persuasive essay.\n\nLanguage Demand:\n•\tEasy: Basic vocabulary and simple grammatical structures are often sufficient. The focus is on clear and coherent expression of personal opinions and experiences.\n•\tMedium: Requires a mix of basic and advanced vocabulary and varied sentence structures. The ability to articulate and support slightly complex ideas is important.\n•\tHard: High proficiency in language use is required, with a wide range of vocabulary and complex sentence structures. The ability to express and justify complex ideas and arguments clearly and effectively is crucial.\n\nResource Availability:\n•\tEasy: There are abundant study materials, sample essays, and practice prompts available. It's relatively easy to find model essays and guidelines for these common topics.\n•\tMedium: A fair amount of practice materials and examples are available but might require more analytical skills. Candidates may need to seek specific examples or more detailed study guides.\n•\tHard: There are fewer ready-made resources and sample essays at this level. Extensive reading and research might be needed to effectively tackle these topics.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string integratedCriteria = "You will be given a TOEFL integrated writing topic, your job is to classify the difficulty level of the topic into easy, medium, and hard based on the following criteria:\n\nFamiliarity:\n•\tEasy: Topics are very common and frequently encountered in everyday life. These subjects require minimal specialized knowledge and are broadly relatable. Information presented in both the reading and the listening is straightforward and clear.\n•\tMedium: Topics are moderately familiar, where having some background knowledge is beneficial but not essential. Information may have more depth compared to the easy level, requiring attentive reading, and listening.\n•\tHard: Topics are specialized or abstract, demanding in-depth knowledge or a deep understanding. Both the reading and listening passages contain dense and intricate information.\n\nSimplicity:\n•\tEasy: The relationship between the reading and listening materials is relatively clear and direct. Easier to identify the main points and how they either contrast with or support each other.\n•\tMedium: The connections between the reading and listening materials might be less direct, with more subtle points of comparison or contrast. Requires more critical thinking to identify and articulate the key relationships.\n•\tHard: Relationships between the reading and listening materials are complex, often involving nuanced arguments or detailed analysis. High level of skill in organizing, integrating, and presenting information coherently and concisely is needed.\n\nLanguage Demand:\n•\tEasy: Requires basic vocabulary and simple sentence structures for summarizing and comparing information. Focus is more on accuracy in conveying information than on using complex language.\n•\tMedium: Requires a balance of basic and more advanced vocabulary, along with varied sentence structures. Ability to express relationships between more complex ideas and details is important.\n•\tHard: High proficiency in language use is required, with a wide range of vocabulary and complex sentence structures. The ability to synthesize and analyze intricate details and viewpoints is crucial.\n\nResource Availability:\n•\tEasy: Plenty of practice materials and sample responses are available, including texts and lectures on familiar topics. Easy to find resources that demonstrate how to integrate and summarize key points.\n•\tMedium: A fair amount of practice materials are available but may require more analytical skills to dissect. Might need to seek specific examples or more detailed guides on notetaking and synthesis.\n•\tHard: Fewer ready-made resources and model responses are available at this higher level of complexity. Requires extensive research and practice with advanced materials to develop proficiency.\n\nJust response with: ‘Easy’, ‘Medium’, or ‘Hard’.\n";
            string criteria = task2Criteria;

            var questions = await _unitOfWork.Questions.GetAllActiveQuestions();

            foreach(Questions question in questions)
            {
                QuestionParts questionContent = await _unitOfWork.QuestionParts.GetQuestionContentById(question.Id);
                if(questionContent != null)
                {
                    string content = ""; // StripHTML(questionContent.Content);
                    Tasks questionTask = await _unitOfWork.Questions.GetTaksById(question.TaskId);
                    string task = questionTask.Name;

                    if (task == "Independent Writing")
                    {
                        criteria = independentCriteria;
                        content = "Classify the difficulty level of the following TOEFL independent writing topic: " + StripHTML(questionContent.Content) + "";
                    }
                    else if (task == "Integrated Writing")
                    {
                        criteria = integratedCriteria;
                        string reading = "";
                        QuestionParts readingPart = await _unitOfWork.QuestionParts.GetReadingByQuestionId(question.Id);
                        if (readingPart != null)
                            reading = StripHTML(readingPart.Content);

                        string transcript = "";
                        QuestionParts transcriptPart = await _unitOfWork.QuestionParts.GetTranscriptByQuestionId(question.Id);
                        if (transcriptPart != null)
                            transcript = StripHTML(transcriptPart.Content);

                        content = "Classify the difficulty level of the following TOEFL integrated writing topic: \nQuesiton: " + StripHTML(questionContent.Content) + "\nReading: " + reading + "\nListening Transcript: " + transcript + "";

                    }
                    else if (task == "Academic Writing Task 1")
                    {
                        criteria = task1Criteria;
                        content = "Classify the difficulty level of the following IELTS academic writing task 1 topic: " + StripHTML(questionContent.Content) + "";
                    }
                    else
                    {
                        criteria = task2Criteria;
                        content = "Classify the difficulty level of the following IELTS academic writing task 2 topic: " + StripHTML(questionContent.Content) + "";
                    }
                    string difficulty = "Medium";
                    ChatMessage prerequisite = new ChatMessage(ChatMessageRole.User, criteria);
                    ChatMessage request = new ChatMessage(ChatMessageRole.User, content);
                    List<ChatMessage> messages = new List<ChatMessage>();
                    messages.Add(prerequisite);
                    messages.Add(request);

                    var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                    {
                        Model = Model.GPT4_Turbo,
                        Temperature = 0.1,
                        MaxTokens = 2000,
                        ResponseFormat = ChatRequest.ResponseFormats.Text,
                        Messages = messages

                    });;

                    difficulty = result.Choices[0].Message.TextContent;
                    question.Difficulty = difficulty;
                    question.LastActivityDate = DateTime.UtcNow;
                    await _unitOfWork.Questions.Update(question);
                }
                
            }
           
        }
        public async Task<TOEFLIndependentFeedbackModel> GetTOEFLIndependentEssayFeedback(string question, string essay, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string independentRubric = "Given the following rubric descriptors for the TOEFL Independent Writing delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Language Use\n1.1. Criteria Description\nThe Language Use criterion for the TOEFL Independent Writing task evaluates your ability to use English accurately and effectively in an academic context. This criterion focuses on your grammatical accuracy, range of vocabulary, and overall fluency and clarity in expressing ideas.\n\n1.2. Band Descriptors\n- Band 0: The essay does not address the topic, is written in a foreign language, is copied, is off-topic, or is blank.\n\n- Band 1: Vocabulary: Shows very limited control of vocabulary. Incorrect word choice and errors in word form are frequent, severely impeding communication; Grammar: Displays fundamental errors in grammatical structures. Errors are so prevalent that they largely prevent understanding of the text; Clarity and Fluency: Writing is generally incoherent, with little to no evidence of ability to organize or express ideas clearly.\n\n- Band 2: Vocabulary: Displays limited vocabulary range, word choice is often basic and sometimes inappropriate, leading to confusion and ambiguity; Grammar: Frequent grammatical errors significantly hinder clarity. Simple grammatical structures may be used correctly, but more complex structures are often misused; Clarity and Fluency: Writing may be difficult to understand due to pervasive errors in vocabulary and grammar. Attempts at complex ideas are poorly executed, leading to unclear or incoherent expression.\n\n- Band 3: Vocabulary: Demonstrates an adequate range of vocabulary for the task, however, misuse of words and noticeable gaps in vocabulary may be evident; Grammar: Shows a mix of accurate and inaccurate use of grammatical structures. Errors are frequent enough to make some sentences unclear; Clarity and Fluency: Writing is generally clear, but problems with fluency and word choice may obscure meaning in some instances.\n\n- Band 4: Vocabulary: Uses a range of vocabulary effectively, though may display some lack of precision. Idiomatic expressions are generally used correctly; Grammar: Exhibits control over grammatical structures, though some errors may occur. These errors rarely reduce clarity; Clarity and Fluency: Overall, the writing is coherent and can be understood without effort, but it may lack the polish and smoothness of a higher-scoring essay.\n\n- Band 5: Vocabulary: Demonstrates a strong command of vocabulary and idiomatic expressions. Rare minor errors do not detract from the overall communication; Grammar: Shows effective use of varied grammatical structures. Any grammatical errors are minor and infrequent, not interfering with comprehension; Clarity and Fluency: The writing is clear and fluid. Complex ideas are expressed elegantly and are easily understood by the reader.\n\n2. Organization\n2.1. Criteria Description\nThe Organization criterion for the TOEFL Independent Writing task assesses how well you can structure and present your ideas in a clear, logical manner. This involves the overall structure of your essay, including the introduction, body paragraphs, and conclusion, as well as the coherence and transition between ideas within and across paragraphs.\n\n2.2. Band Descriptors\n- Band 0: The essay does not address the topic, is written in a foreign language, is copied, is off-topic, or is blank.\n\n- Band 1: Overall Structure: The essay lacks a coherent structure, with no clear distinction between introduction, body, and conclusion. The organization is so poor that it significantly impedes understanding; Coherence and Cohesion: There is little to no use of transitional phrases or sentences, leading to a very disjointed and incoherent flow of ideas. Paragraphs, if present, are poorly formed and lack cohesion; Unity: The essay fails to maintain focus, with most of the content irrelevant to the thesis or main topic.\n\n- Band 2: Overall Structure: The essay’s structure is unclear or inconsistent, making it difficult to identify the introduction, body, and conclusion. The organization is poor, making it hard to follow the progression of ideas; Coherence and Cohesion: Transitions between ideas are minimal or ineffective, leading to a disjointed or confusing arrangement of ideas. Paragraphs may not be well-defined, with ideas blending into one another without clear separation; Unity: Many paragraphs may lack a clear main idea or stray significantly from the thesis. The essay may contain much irrelevant information.\n\n- Band 3: Overall Structure: The essay has an identifiable structure, but the organization may be flawed or simplistic. The introduction, body paragraphs, and conclusion are present but may not be fully developed or clear; Coherence and Cohesion: Attempts to use transitions are evident, but they may be misused or repetitive, leading to some confusion or disjointedness in the flow of ideas; Unity: Some paragraphs may lack clear focus or deviate from supporting the thesis. The essay may include irrelevant information that detracts from the overall argument.\n\n- Band 4: Overall Structure: The essay is generally well-organized with a clear introduction, body, and conclusion. The structure may be less innovative or slightly unclear at times, but it does not significantly hinder comprehension; Coherence and Cohesion: Uses transitional phrases and sentences effectively, though some transitions may be mechanical or less varied. There may be minor issues with flow or clarity, but they do not significantly disrupt the reading experience; Unity: Paragraphs are generally focused, but one or two may contain some extraneous information or not be as well-developed.\n\n- Band 5: Overall Structure: The essay has a clear, logical structure that is easy to follow. The introduction effectively sets up the topic and thesis statement, body paragraphs are well-developed and focused on separate ideas that support the thesis, and the conclusion effectively summarizes the essay or restates its main points; Coherence and Cohesion: Uses effective transitional phrases and sentences to link ideas within paragraphs and between them, ensuring smooth flow of ideas. Paragraphs are clearly delineated, and each serves a distinct purpose in the argument or narrative; Unity: Each paragraph has a clear main idea that supports the thesis, with no irrelevant or off-topic information.\n\n3. Development and Support\n3.1. Criteria Description\nThe Development and Support criterion for the TOEFL Independent Writing task evaluates how well you can develop your ideas and support them with details and examples. This criterion assesses the effectiveness of your argumentation or explanation, the relevance and persuasiveness of your supporting details, and how well you integrate these elements to make a coherent argument or narrative.\n\n3.2. Band Descriptors\n- Band 0: The essay does not address the topic, is written in a foreign language, is copied, is off-topic, or is blank.\n\n- Band 1: Idea Development: Ideas are poorly developed or barely addressed. There is a significant lack of supporting detail, making arguments or narratives difficult to understand or follow; Supporting Details: Lacks relevant or coherent supporting examples and details. Any attempt to support ideas is vague, incorrect, or irrelevant; Complexity and Depth: Demonstrates a lack of thought and understanding of the topic. There is no complexity, with ideas presented in a disjointed or incoherent manner.\n\n- Band 2: Idea Development: Ideas are underdeveloped and lack detailed support. Arguments or explanations are incomplete or superficial, making them unconvincing; Supporting Details: Provides few details or examples, which are often irrelevant or overly simplistic. Struggles to connect supporting details effectively to main ideas; Complexity and Depth: Shows minimal complexity or depth of thought. The essay tends to be simplistic and one-dimensional, with no consideration of counterarguments or alternative perspectives.\n\n- Band 3: Idea Development: Ideas are somewhat developed but may not be fully elaborated. Support for arguments or explanations is present but not always convincing or thoroughly explained; Supporting Details: Uses examples and reasons to support ideas, but these may be too general, simplistic, or partially relevant. The connection between support and the main ideas may not always be clear; Complexity and Depth: Demonstrates basic thought and a straightforward approach to the topic. Lacks significant complexity, with little to no acknowledgement of counterarguments or alternative perspectives.\n\n- Band 4: Idea Development: Ideas are generally well-developed and supported. Arguments or explanations are clear and make sense but may lack the depth or insight of the highest-scoring essays; Supporting Details: Provides clear and relevant examples and reasons to support main ideas. The integration of these details is mostly effective, though some may be more generic or less fully explored; Complexity and Depth: Shows a good level of thought and complexity. Counterarguments or alternative perspectives may be mentioned but are not explored in depth.\n\n- Band 5: Idea Development: Ideas are fully developed and thoroughly supported. Arguments or narratives are detailed, insightful, and demonstrate a deep understanding of the topic; Supporting Details: Uses specific, relevant examples and reasons to support ideas. These details are integrated seamlessly into the argument or explanation, enhancing the persuasive or explanatory power of the essay; Complexity and Depth: Demonstrates sophisticated thought and complexity in argumentation or narrative. Counterarguments or alternative perspectives may be acknowledged and addressed, adding depth to the essay.\n</rubric>\n";
            string topic = "Given the following TOEFL Independent Writing topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\n";

            string response = "Given the following writing response for the topic delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + essay + "\r\n</response>\r\n";

            try
            {
                // If there are issue, try multi-promps approach
                string languageUse = "Cung cấp phản hồi cho bài luận cho tiêu chí Language Use sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Language Use dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Language Use. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Language Use. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Language Use, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    languageUse = "Provide feedback for the essay on the Language Use criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Language Use criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about what the student did well in the essay for the Language Use criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Language Use criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Language Use criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n";

                var languageUseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, independentRubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, languageUse)
                }
                });
                AutomatedFeedbackModel languageUseFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(languageUseResult.Choices[0].Message.TextContent);


                string organization = "Cung cấp phản hồi cho bài luận cho tiêu chí Organization sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Organization dựa theo descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Organization. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    organization = "Provide feedback for the essay on the Organization criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Organization criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Organization criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Organization criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Organization criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n";

                var organizationResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, independentRubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, organization)
                }
                });
                AutomatedFeedbackModel organizationFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(organizationResult.Choices[0].Message.TextContent);

                string devSupport = "Cung cấp phản hồi cho bài luận cho tiêu chí Development and Support sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Development and Support dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Development and Support. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Development and Support. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Development and Support, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    devSupport = "Provide feedback for the essay on the Development and Support criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Development and Support criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Development and Support criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Development and Support criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The Recommendations property: Provides guidance for students to improve their score for the Development and Support criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n";

                var devSupportResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, independentRubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, devSupport)
                }
                });
                AutomatedFeedbackModel devSupportFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(devSupportResult.Choices[0].Message.TextContent);

                string overall = "Cung cấp phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận theo thang điểm từ 0 tới 5.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả ba tiêu chí Language Use, Organization, và Content.\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n";

                if (feedbackLanguage != "vn")
                    overall = "Provide overall feedback for the essay using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall score of the essay ranging from 0 to 5.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n- The performance property: Contains feedback about the overall performance of the essay. The feedback needs to provide an overall picture of the essay's quality spanning all three criteria: Language Use, Organization, and Content.\r\n- The strengths property: Contains feedback about the best aspects of the essay. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay. The feedback needs to pinpoint and detail the points that need attention and improvement the most. Emphasize aspects that, if refined, would significantly enhance the quality and score of the essay.\r\n- The recommendations property: Provides general guidance for students to improve their essay scores. This guidance needs include constructive advice, encouraging practice, and continuous improvement.\r\n";

                var overallResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, independentRubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, overall)
                }
                });
                AutomatedFeedbackModel overallFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(overallResult.Choices[0].Message.TextContent);


                TOEFLIndependentFeedbackModel feedback = new TOEFLIndependentFeedbackModel
                {
                    languageUse = languageUseFeedback,
                    organization = organizationFeedback,
                    developmentSupport = devSupportFeedback,
                    overallFeedback = overallFeedback
                };

                return feedback;
            }
            catch (Exception e)
            {

                // Try one promp approach
                string prompt = "Cung cấp phản hồi cho bài luận sử dụng định dạng JSON. Đối tượng JSON chứa 4 thuộc tính có tên là languageUse, organization, developmentSupport, và overallFeedback. 4 thuộc tính này chứa thôngt in như sau:\r\n\r\n1. Thuộc tính languageUse chứa phản hồi cho bài luận cho tiêu chí Language Use sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Language Use dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Language Use. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Language Use. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Language Use, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n2. Thuộc tính organization chứa phản hồi cho bài luận cho tiêu chí Organization sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Organization dựa theo descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Organization. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n3. Thuộc tính developmentSupport chứa phản hồi cho bài luận cho tiêu chí Development and Support sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Development and Support dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Development and Support. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Development and Support. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Development and Support, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n4. Thuộc tính overallFeedback chứa phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận theo thang điểm từ 0 tới 5.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả ba tiêu chí Language Use, Organization, và Development and Support.\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận là m tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n";

                if (feedbackLanguage != "vn")
                    prompt = "Provide feedback for the essay using the JSON format. The JSON object contains 4 properties named languageUse, organization, developmentSupport, and overallFeedback. These 4 properties contain information as follows:\r\n\r\n1. The languageUse property contains feedback for the essay on the Language Use criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Language Use criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about what the student did well in the essay for the Language Use criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Language Use criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Language Use criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n2. The organization property contains feedback for the essay on the Organization criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Organization criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Organization criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Organization criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Organization criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n3. The developmentSupport property contains feedback for the essay on the Development and Support criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Development and Support criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Development and Support criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Development and Support criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The Recommendations property: Provides guidance for students to improve their score for the Development and Support criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n5. The overallFeedback property contains general feedback for the essay using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall score of the essay ranging from 0 to 5.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n- The performance property: Contains feedback about the overall performance of the essay. The feedback needs to provide an overall picture of the essay's quality spanning all three criteria: Language Use, Organization, and Development and Support.\r\n- The strengths property: Contains feedback about the best aspects of the essay. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay. The feedback needs to pinpoint and detail the points that need attention and improvement the most. Emphasize aspects that, if refined, would significantly enhance the quality and score of the essay.\r\n- The recommendations property: Provides general guidance for students to improve their essay scores. This guidance needs include constructive advice, encouraging practice, and continuous improvement.\r\n";

                var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 4096,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                        new ChatMessage(ChatMessageRole.Assistant, independentRubric),
                        new ChatMessage(ChatMessageRole.Assistant, topic),
                        new ChatMessage(ChatMessageRole.Assistant, response),
                        new ChatMessage(ChatMessageRole.User, prompt)
                    }
                });
                TOEFLIndependentFeedbackModel feedback = JsonConvert.DeserializeObject<TOEFLIndependentFeedbackModel>(result.Choices[0].Message.TextContent);

                return feedback;
            }
        }
        public async Task<TOEFLIntegratedFeedbackModel> GetTOEFLIntegratedEssayFeedback(string question, string essay, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string integratedRubric = "Given the following rubric descriptors for the TOEFL Integrated Writing delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Language Use\n1.1. Criteria Description\nThe Language Use criterion for the TOEFL Integrated Writing task assesses your ability to effectively use English to summarize and synthesize information from reading and listening materials. This involves evaluating your grammar, vocabulary, and overall ability to express ideas clearly and cohesively in writing.\n\n1.2. Band Descriptors\n- Band 0: The response is off-topic, written in a language other than English, merely copies large portions of the text without synthesizing, or is left blank.\n\n- Band 1: Vocabulary: Shows very limited vocabulary. Frequent errors in word choice and form severely impede communication. Lacks academic language and appropriate idiomatic expressions; Grammar: Shows very little or no control over grammatical structures. Errors are pervasive and greatly hinder comprehension; Cohesion and Coherence: Lacks coherent and cohesive writing. Ideas are disjointed, and the summary is extremely difficult to follow due to the poor use of language and lack of logical connection between ideas.\n\n- Band 2: Vocabulary: Exhibits limited vocabulary range, with frequent inappropriate word choices and errors that often hinder comprehension. Struggles to use academic language effectively; Grammar: Limited control over grammatical structures, with pervasive errors that frequently obscure meaning. Reliance on overly simple sentence structures; Cohesion and Coherence: Demonstrates limited ability to connect ideas cohesively. Poor use of cohesive devices and unclear expression of ideas make the summary difficult to follow.\n\n- Band 3: Vocabulary: Demonstrates an adequate range of vocabulary for summarizing content, but misuse of vocabulary and noticeable gaps in lexical resources may occasionally hinder comprehension. Limited use of academic language and idiomatic expressions; Grammar: Displays fair grammatical control. Simple and some complex sentence structures are used, but with frequent errors that may sometimes impede understanding; Cohesion and Coherence: Uses some cohesive devices, but their misuse or overuse may lead to some lack of clarity. Ideas are expressed with some coherence, though the summary may be harder to follow in places.\n\n- Band 4: Vocabulary: Uses a range of vocabulary effectively but may have minor errors or less precision in word choice that do not significantly hinder communication. Good use of academic language and some idiomatic expressions; Grammar: Shows good grammatical control. Uses a variety of sentence structures with some errors, but these errors do not significantly obscure meaning; Cohesion and Coherence: The response is cohesive and demonstrates effective use of cohesive devices. Ideas are generally expressed clearly, though there may be occasional lapses in coherence that do not majorly affect readability.\n\n- Band 5: Vocabulary: Demonstrates a strong command of vocabulary and the ability to use precise and appropriate language to convey ideas effectively. Utilizes a wide range of academic vocabulary and idiomatic expressions correctly; Grammar: Exhibits excellent grammatical control. Varieties of sentence structures are used effectively and flexibly. Grammatical mistakes are rare and do not impede understanding; Cohesion and Coherence: The response is highly cohesive and demonstrates skillful use of cohesive devices (e.g., conjunctions, reference words, transitions). Ideas are expressed clearly and coherently, making the summary easy to follow.\n\n2. Organization\n2.1. Criteria Description\nThe Organization criterion for the TOEFL Integrated Writing task evaluates how effectively you organize and present information from the reading and listening materials in your written response. This criterion focuses on the overall structure of your response, the clarity of your summarization, and how well you link ideas from both sources.\n\n2.2. Band Descriptors\n- Band 0: The response does not address the task, is off-topic, written in a language other than English, merely copies large portions of the text without organization, or is left blank.\n\n- Band 1: Overall Structure: Lacks coherent structure, with no clear distinction between the summary of the reading and listening materials. The organization is poor, significantly impeding the reader’s understanding; Clarity of Summarization: Provides a very poor summary of the points, with significant inaccuracies and omissions. The reader is left to guess the main points and their sources; Linking Ideas: Demonstrates very little or no effective linking of ideas. The response is extremely difficult to follow, with ideas presented in a random or incoherent manner.\n\n- Band 2: Overall Structure: The response’s structure is unclear or inconsistent, making it difficult to distinguish the main points and their sources. The organization does not effectively convey the relationship between the reading and listening materials; Clarity of Summarization: Struggles to summarize the main points accurately or clearly. Information may be presented in a confused manner, making it hard for the reader to understand the relationship between the sources; Linking Ideas: Limited or ineffective use of transitional phrases. The response may lack logical connections between ideas, leading to a disjointed presentation.\n\n- Band 3: Overall Structure: The response has an identifiable structure, but the organization may be simplistic or flawed in some areas. It attempts to organize the main points from the reading and listening, but the relationship between them may not always be clear; Clarity of Summarization: Attempts to summarize the main points, but may include inaccuracies, be incomplete, or somewhat unclear, requiring the reader to infer some relationships between points; Linking Ideas: Uses some transitional phrases and attempts to link ideas, but these may be misused or insufficient, leading to a somewhat disjointed or confusing presentation.\n\n- Band 4: Overall Structure: The response is well-organized with a clear structure that mostly effectively compares or contrasts the reading and listening points. The introduction, body, and possible conclusion are present and facilitate understanding; Clarity of Summarization: Summarizes the main points from the sources accurately, though there may be minor omissions or inaccuracies that do not significantly affect clarity; Linking Ideas: Generally uses transitions and organizational phrases effectively, though some connections between ideas may be less smooth or obvious.\n\n- Band 5: Overall Structure: The response has a clear, logical structure that effectively organizes information from both the reading and listening materials. An introduction sets up the topic, followed by body paragraphs that cohesively compare or contrast the points from the reading and listening, and a conclusion may summarize the key points; Clarity of Summarization: Summarizes information accurately and clearly, making it easy for the reader to identify the main points and how they relate to each other; Linking Ideas: Uses effective transitional phrases and sentences to link ideas within and between paragraphs, ensuring a smooth flow of information. Demonstrates a clear relationship between the reading and listening points.\n\n3. Content\n3.1. Criteria Description\nThe Content criterion for the TOEFL Integrated Writing task assesses your ability to convey information accurately and effectively from the reading and listening materials in your written response. This involves evaluating how well you summarize the key points and details from both sources and how effectively you integrate these points to present a coherent analysis or comparison.\n\n3.2. Band Descriptors\n- Band 0: The response does not address the task, is off-topic, written in a language other than English, merely copies large portions of the text without synthesizing, or is left blank.\n\n- Band 1: Accuracy: Contains numerous inaccuracies or misrepresentations of the reading and listening materials. Key points are either missing or inaccurately portrayed, significantly misleading the reader; Integration: Shows very poor or no integration of information from the reading and listening materials. Fails to establish a coherent relationship between the sources, making the response difficult to follow; Completeness: The response fails to adequately address the task, missing most of the required information and providing an incomplete or incorrect understanding of the topic.\n\n- Band 2: Accuracy: Struggles to accurately convey key points and details from the sources. Includes inaccuracies or omissions that significantly affect the reader's understanding of the topic; Integration: Demonstrates limited ability to integrate information from the reading and listening materials. Connections between the two sources are weak or unclear, leading to a fragmented or incomplete comparison or contrast; Completeness: The response partially addresses the task but omits significant information, leading to an incomplete or skewed understanding of the topic.\n\n- Band 3: Accuracy: Conveys some key points and details from the reading and listening materials but may include inaccuracies or omit important information. These issues may occasionally confuse or mislead the reader; Integration: Attempts to integrate information from both sources but may not always make clear or accurate connections. The relationship between the reading and listening materials is somewhat evident but not fully developed; Completeness: The response addresses the task but may leave out key aspects or details necessary for a full understanding of the topic.\n\n- Band 4: Accuracy: Accurately conveys most of the key points and important details from both sources. There may be minor inaccuracies or omissions, but these do not significantly impact the overall comprehension of the material; Integration: Effectively integrates information from both sources, making clear connections between the reading and listening materials. The comparison or contrast is clear but may lack some of the depth or insight of the highest-scoring essays; Completeness: The response covers most of the necessary information required by the task. Minor omissions do not significantly detract from the overall understanding of the topic.\n\n- Band 5: Accuracy: The response accurately conveys all the critical points and important details from both the reading and listening materials. Any minor inaccuracies do not change the overall understanding of the information; Integration: Demonstrates exceptional ability to synthesize and integrate information from the reading and listening materials. The relationship between the two sources is clear and well-explained, providing a thorough comparison or contrast as required; Completeness: The response is comprehensive, covering all necessary aspects of the task. It provides a full understanding of the topic without omitting significant information.\n</rubric>\n";

            string topic = "Given the following TOEFL Integrated Writing topic delimited by <topic> and </topic> tags:\n\n<topic>\n" + question + "\n</topic>\n\n";

            string response = "Given the following writing response for the topic delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + essay + "\r\n</response>\r\n";

            try
            {
                // If there are issue, try multi-promps approach
                string languageUse = "Cung cấp phản hồi cho bài luận cho tiêu chí Language Use sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Language Use dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Language Use. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Language Use. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Language Use, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    languageUse = "Provide feedback for the essay on the Language Use criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Language Use criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about what the student did well in the essay for the Language Use criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Language Use criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Language Use criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n";

                var languageUseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, integratedRubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, languageUse)
                }
                });
                AutomatedFeedbackModel languageUseFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(languageUseResult.Choices[0].Message.TextContent);


                string organization = "Cung cấp phản hồi cho bài luận cho tiêu chí Organization sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Organization dựa theo descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Organization. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    organization = "Provide feedback for the essay on the Organization criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Organization criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Organization criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Organization criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Organization criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n";

                var organizationResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, integratedRubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, organization)
                }
                });
                AutomatedFeedbackModel organizationFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(organizationResult.Choices[0].Message.TextContent);

                string content = "Cung cấp phản hồi cho bài luận cho tiêu chí Content sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Content dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Content. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Content. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Content, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    content = "Provide feedback for the essay on the Content criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Content criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Content criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Content criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The Recommendations property: Provides guidance for students to improve their score for the Content criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n";

                var contentResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, integratedRubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, content)
                }
                });
                AutomatedFeedbackModel contentFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(contentResult.Choices[0].Message.TextContent);

                string overall = "Cung cấp phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận theo thang điểm từ 0 tới 5.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả ba tiêu chí Language Use, Organization, và Content.\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n";

                if (feedbackLanguage != "vn")
                    overall = "Provide overall feedback for the essay using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall score of the essay ranging from 0 to 5.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n- The performance property: Contains feedback about the overall performance of the essay. The feedback needs to provide an overall picture of the essay's quality spanning all three criteria: Language Use, Organization, and Content.\r\n- The strengths property: Contains feedback about the best aspects of the essay. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay. The feedback needs to pinpoint and detail the points that need attention and improvement the most. Emphasize aspects that, if refined, would significantly enhance the quality and score of the essay.\r\n- The recommendations property: Provides general guidance for students to improve their essay scores. This guidance needs include constructive advice, encouraging practice, and continuous improvement.\r\n";

                var overallResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    //MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, integratedRubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, overall)
                }
                });
                AutomatedFeedbackModel overallFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(overallResult.Choices[0].Message.TextContent);


                TOEFLIntegratedFeedbackModel feedback = new TOEFLIntegratedFeedbackModel
                {
                    languageUse = languageUseFeedback,
                    organization = organizationFeedback,
                    content = contentFeedback,
                    overallFeedback = overallFeedback
                };

                return feedback;
            }
            catch (Exception e)
            {

                // Try one promp approach first to save time
                string prompt = "Cung cấp phản hồi cho bài luận sử dụng định dạng JSON. Đối tượng JSON chứa 4 thuộc tính có tên là languageUse, organization, content, và overallFeedback. 4 thuộc tính này chứa thôngt in như sau:\r\n\r\n1. Thuộc tính languageUse chứa phản hồi cho bài luận cho tiêu chí Language Use sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Language Use dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Language Use. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Language Use. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Language Use, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n2. Thuộc tính organization chứa phản hồi cho bài luận cho tiêu chí Organization sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Organization dựa theo descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Organization. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n3. Thuộc tính content chứa phản hồi cho bài luận cho tiêu chí Content sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Content dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Content. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Content. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Content, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n4. Thuộc tính overallFeedback chứa phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận theo thang điểm từ 0 tới 5.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả ba tiêu chí Language Use, Organization, và Content.\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận là m tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n";

                if (feedbackLanguage != "vn")
                    prompt = "Provide feedback for the essay using the JSON format. The JSON object contains 4 properties named languageUse, organization, developmentSupport, and overallFeedback. These 4 properties contain information as follows:\r\n\r\n1. The languageUse property contains feedback for the essay on the Language Use criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Language Use criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about what the student did well in the essay for the Language Use criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Language Use criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Language Use criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n2. The organization property contains feedback for the essay on the Organization criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Organization criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Organization criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Organization criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Organization criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n3. The developmentSupport property contains feedback for the essay on the Content criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Content criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Content criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Content criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The Recommendations property: Provides guidance for students to improve their score for the Content criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n5. The overallFeedback property contains general feedback for the essay using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall score of the essay ranging from 0 to 5.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n- The performance property: Contains feedback about the overall performance of the essay. The feedback needs to provide an overall picture of the essay's quality spanning all three criteria: Language Use, Organization, and Content.\r\n- The strengths property: Contains feedback about the best aspects of the essay. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay. The feedback needs to pinpoint and detail the points that need attention and improvement the most. Emphasize aspects that, if refined, would significantly enhance the quality and score of the essay.\r\n- The recommendations property: Provides general guidance for students to improve their essay scores. This guidance needs include constructive advice, encouraging practice, and continuous improvement.\r\n";

                var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 4096,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                        new ChatMessage(ChatMessageRole.Assistant, integratedRubric),
                        new ChatMessage(ChatMessageRole.Assistant, topic),
                        new ChatMessage(ChatMessageRole.Assistant, response),
                        new ChatMessage(ChatMessageRole.User, prompt)
                    }
                });
                TOEFLIntegratedFeedbackModel feedback = JsonConvert.DeserializeObject<TOEFLIntegratedFeedbackModel>(result.Choices[0].Message.TextContent);

                return feedback;
            }
        }
        public async Task<IELTSTask1FeedbackModel> GetIELTSTask1EssayFeedback(string question, string essay, string filePath, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string task1Rubric = "Given the following rubric descriptors for the IELTS Academic Writing Task 1 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Achievement\n1.1. Criteria Description\nThe Task Achievement criterion in IELTS Academic Writing Task 1 evaluates how well you summarize key trends, compare data, cover all task requirements, and report features accurately from visuals like graphs or charts, focusing on your ability to identify and convey the most important information.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the task. Any copied rubric must be discounted.\n\n- Band 2: The content barely relates to the task.\n\n- Band 3: The response does not address the requirements of the task (possibly because of misunderstanding of the data/diagram/situation). Key features/bullet points which are presented may be largely irrelevant. Limited information is presented, and this may be used repetitively.\n\n- Band 4: The response is an attempt to address the task. Few key features have been selected. be confused. The tone may be inappropriate. The format may be inappropriate. Key features/bullet points which are presented may be irrelevant, repetitive, inaccurate, or inappropriate.\n\n- Band 5: The response generally addresses the requirements of the task. The format may be inappropriate in places. Key features which are selected are not adequately covered. The recounting of detail is mainly mechanical. There may be no data to support the description. There may be a tendency to focus on details (without referring to the bigger picture). The inclusion of irrelevant, inappropriate or inaccurate material in key areas detracts from the task achievement. There is limited detail when extending and illustrating the main points.\n\n- Band 6: The response focuses on the requirements of the task and an appropriate format is used. Key features which are selected are covered and adequately highlighted. A relevant overview is attempted. Information is appropriately selected and supported using figures/data. Some irrelevant, inappropriate or inaccurate information may occur in areas of detail or when illustrating or extending the main points. Some details may be missing (or excessive) and further extension or illustration may be needed.\n\n- Band 7: The response covers the requirements of the task. The content is relevant and accurate. There may be a few omissions or lapses. The format is appropriate. Key features which are selected are covered and clearly highlighted but could be more fully or more appropriately illustrated or extended. It presents a clear overview, the data are appropriately categorized, and main trends or differences are identified.\n\n- Band 8: The response covers all the requirements of the task appropriately, relevantly and sufficiently. Key features are skillfully selected, and clearly presented, highlighted and illustrated. There may be occasional omissions or lapses in content.\n\n- Band 9: All the requirements of the task are fully and appropriately satisfied. There may be extremely rare lapses in content.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion assesses your ability to organize and link information clearly and logically in IELTS Academic Writing Task 1. It focuses on effective paragraphing, logical sequencing of ideas, and the use of cohesive devices (like linking words and pronouns) to help the reader understand the relationships between ideas.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. Minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing.\n\n- Band 4: Information and ideas are evident but not arranged coherently, and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error.\n\n- Band 7: Information and ideas are logically organized and there is a clear progression throughout the response. A few lapses may occur. A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence or cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion evaluates your range of vocabulary, accuracy in word choice, and ability to use words appropriately to express precise meanings in IELTS Academic Writing Task 1. It focuses on your ability to use a variety of vocabulary to describe data, trends, and processes clearly and accurately.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice, and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation, and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings within the scope of the task. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are evident within the scope of the task. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion assesses your use of sentence structures and grammatical accuracy in IELTS Academic Writing Task 1. It focuses on your ability to construct a range of sentence types correctly and use grammar precisely to convey information and ideas effectively.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorized phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through.  Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures within the scope of the task is flexibly and accurately used. The majority of sentences are error free, and punctuation is well managed. Occasional, nonsystematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures within the scope of the task is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n</rubric>\n";
            string topic = "Given the following Academic Writing Task 1 topic delimited by <topic> and </topic> tags:\r\n\r\n<topic>" + question + "\r\n\r\n</topic>\r\n";
            string chart = "";
            
            if (!String.IsNullOrEmpty(filePath))
            {
                chart = "Given the following chart information associated with the topic delimited by <chart> and </chart> tags:";

                ChatMessage message = new ChatMessage();
                message.Role = ChatMessageRole.User;
                message.TextContent = "Provide me with the full content of the attached chart. Do not miss any information or data.";
                // Add the chart to the message 
                message.Images = new List<ChatMessage.ImageInput>();
                message.Images.Add(ChatMessage.ImageInput.FromFile(filePath));

                var chartResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Vision,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    Messages = new ChatMessage[] {
                        message
                    }
                });

                chart += "\r\n\r\n<chart>" + chartResult.Choices[0].Message.TextContent + "\r\n\r\n</chart>\r\n";
            }

            topic += chart;

            string response = "Given the following writing response for the topic delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + essay + "\r\n</response>\r\n";

            try
            {
                // If there are issue, try multi-promps approach
                string taskResponse = "Cung cấp phản hồi cho bài luận cho tiêu chí Task Achievement sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Achievement dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Achievement. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Achievement. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Task Achievement, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    taskResponse = "Provide feedback for the essay on the Task Achievement criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Task Achievement criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Task Achievement criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Task Achievement criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Task Achievement criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";

                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task1Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, taskResponse)
                }
                });
                AutomatedFeedbackModel taskResponseFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(taskResponseResult.Choices[0].Message.TextContent);


                string coherence = "Cung cấp phản hồi cho bài luận cho tiêu chí Coherence & Cohesion sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Coherence & Cohesion dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence & Cohesion, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    coherence = "Provide feedback for the essay on the Coherence & Cohesion criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Coherence & Cohesion criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Coherence & Cohesion criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Coherence & Cohesion criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Coherence & Cohesion criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";

                var coherenceResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task1Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, coherence)
                }
                });
                AutomatedFeedbackModel coherenceFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(coherenceResult.Choices[0].Message.TextContent);

                string lexicalResource = "Cung cấp phản hồi cho bài luận cho tiêu chí Lexical Resource sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Lexical Resource dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Lexical Resource, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    lexicalResource = "Provide feedback for the essay on the Lexical Resource criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Lexical Resource criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Lexical Resource criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Lexical Resource criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Lexical Resource criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";

                var lexicalResourceResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task1Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, lexicalResource)
                }
                });
                AutomatedFeedbackModel lexicalResourceFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(lexicalResourceResult.Choices[0].Message.TextContent);

                string grammar = "Cung cấp phản hồi cho bài luận cho tiêu chí Grammatical Range & Accuracy sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Grammatical Range & Accuracy dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Grammatical Range & Accuracy, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    grammar = "Provide feedback for the essay on the Grammatical Range & Accuracy criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Grammatical Range & Accuracy criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Grammatical Range & Accuracy criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Grammatical Range & Accuracy criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Grammatical Range & Accuracy criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";

                var grammarResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task1Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, grammar)
                }
                });
                AutomatedFeedbackModel grammarFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(grammarResult.Choices[0].Message.TextContent);
                //string overallScore = "được tính bằng cách tính trung bình điểm số của 4 tiêu chí là: Task Achievement: " + taskResponseFeedback.score.ToString() + ", Coherence & Cohesion: " + coherenceFeedback.score.ToString() + ", Lexical Resource: " + lexicalResourceFeedback.score.ToString() + ", Grammatical Range & Accuracy: " + grammarFeedback.score.ToString();
                //if(feedbackLanguage != "vn")
                //    overallScore = "it's the average of the 4 criterion score which are: Task Achievement: " + taskResponseFeedback.score.ToString() + ", Coherence & Cohesion: " + coherenceFeedback.score.ToString() + ", Lexical Resource: " + lexicalResourceFeedback.score.ToString() + ", Grammatical Range & Accuracy: " + grammarFeedback.score.ToString();

                string overall = "Cung cấp phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm tổng quát của bài viết được chấm theo thang điểm từ 0 tới 9.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Achievement, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n";

                if (feedbackLanguage != "vn")
                    overall = "Provide overall feedback for the essay using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall score of the essay ranging from 0 to 9.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n\r\n- The performance property: Contains feedback about the overall quality of the writing. The feedback should provide a comprehensive overview of the essay, covering all four criteria: Task Achievement, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n- The strengths property: Contains feedback about the aspects the essay performs best at. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop these aspects.\r\n- The weaknesses property: Contains feedback about the aspects the student needs to improve in the essay. The feedback should point out and describe in detail the areas that require attention and improvement the most. Emphasize the aspects that, if refined, would significantly enhance the quality and score of the writing.\r\n- The recommendations property: Provides general guidance for the student to improve their essay score. This guidance must include constructive advice, encouraging continuous practice and improvement.\r\n";

                var overallResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task1Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, overall)
                }
                });
                AutomatedFeedbackModel overallFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(overallResult.Choices[0].Message.TextContent);


                IELTSTask1FeedbackModel model = new IELTSTask1FeedbackModel
                {
                    taskAchievement = taskResponseFeedback,
                    coherence = coherenceFeedback,
                    lexicalResource = lexicalResourceFeedback,
                    grammar = grammarFeedback,
                    overallFeedback = overallFeedback
                };
                return model;
            }
            catch (Exception e)
            {

                // Try one promp approach first to save time
                string prompt = "Cung cấp phản hồi cho bài luận sử dụng định dạng JSON. Đối tượng JSON chứa 5 thuộc tính có tên là taskAchievement, coherence, lexicalResource, grammar và overallFeedback. 5 thuộc tính này chứa thôngt in như sau:\r\n\r\n1. Thuộc tính taskAchievement chứa phản hồi cho bài luận cho tiêu chí Task Achievement sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Achievement dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Achievement. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Achievement. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Task Achievement, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n2. Thuộc tính coherence chứa phản hồi cho bài luận cho tiêu chí Coherence & Cohesion sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Coherence & Cohesion dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence & Cohesion, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n3. Thuộc tính lexicalResource chứa phản hồi cho bài luận cho tiêu chí Lexical Resource sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Lexical Resource dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Lexical Resource, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n4. Thuộc tính grammar chứa phản hồi cho bài luận cho tiêu chí Grammatical Range & Accuracy sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Grammatical Range & Accuracy dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Grammatical Range & Accuracy, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n5. Thuộc tính overallFeedback chứa phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận theo thang điểm từ 0 tới 9.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Achievement, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy.\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n";

                if (feedbackLanguage != "vn")
                    prompt = "Provide feedback for the essay using the JSON format. The JSON object contains 5 properties named taskAchievement, coherence, lexicalResource, grammar, and overallFeedback. These 5 properties contain information as follows:\r\n\r\n1. The taskAchievement property contains feedback for the essay on the Task Achievement criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Task Achievement criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about what the student did well in the essay for the Task Achievement criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Task Achievement criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Task Achievement criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n2. The coherence property contains feedback for the essay on the Coherence & Cohesion criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Coherence & Cohesion criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Coherence & Cohesion criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Coherence & Cohesion criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Coherence & Cohesion criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n3. The lexicalResource property contains feedback for the essay on the Lexical Resource criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Lexical Resource criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Lexical Resource criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Lexical Resource criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The Recommendations property: Provides guidance for students to improve their score for the Lexical Resource criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n4. The grammar property contains feedback for the essay on the Grammatical Range & Accuracy criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Grammatical Range & Accuracy criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\nThe strengths property: Contains feedback about the points that the student did well in the essay for the Grammatical Range & Accuracy criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback in Vietnamese about the points that the student did not do well in the essay for the Grammatical Range & Accuracy criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Grammatical Range & Accuracy criterion, including both general guidance and specific guidance for the provided writing topic. This guidance needs to be written in Vietnamese and must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n5. The overallFeedback property contains general feedback for the essay using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall score of the essay ranging from 0 to 9.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n- The performance property: Contains feedback about the overall performance of the essay. The feedback needs to provide an overall picture of the essay's quality spanning all four criteria: Task Achievement, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n- The strengths property: Contains feedback about the best aspects of the essay. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay. The feedback needs to pinpoint and detail the points that need attention and improvement the most. Emphasize aspects that, if refined, would significantly enhance the quality and score of the essay.\r\n- The recommendations property: Provides general guidance for students to improve their essay scores. This guidance needs include constructive advice, encouraging practice, and continuous improvement.\r\n";

                var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 4096,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                        new ChatMessage(ChatMessageRole.Assistant, task1Rubric),
                        new ChatMessage(ChatMessageRole.Assistant, topic),
                        new ChatMessage(ChatMessageRole.Assistant, response),
                        new ChatMessage(ChatMessageRole.User, prompt)
                    }
                });
                IELTSTask1FeedbackModel feedback = JsonConvert.DeserializeObject<IELTSTask1FeedbackModel>(result.Choices[0].Message.TextContent);

                return feedback;
            }
        }
        public async Task<IELTSTask2FeedbackModel> GetIELTSTask2EssayFeedback(string question, string essay, string feedbackLanguage)
        {
            OpenAIAPI api = new OpenAIAPI(new APIAuthentication(OPENAI_API_KEY));
            string task2Rubric = "Given the following rubric descriptors for the IELTS Academic Writing Task 2 delimited by <rubric> and </rubric> tags:\n\n<rubric>\n1. Task Response\n1.1. Criteria Description\nThe Task Response criterion in IELTS Academic Writing Task 2 assesses how well you develop and support your ideas in response to the question. It focuses on your ability to present a clear, relevant position, fully extend and support your main ideas, and answer all parts of the task prompt comprehensively.\n\n1.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The content is wholly unrelated to the prompt. Any copied rubric must be discounted.\n\n- Band 2: The content is barely related to the prompt. No position can be identified. There may be glimpses of one or two ideas without development.\n\n- Band 3: No part of the prompt is adequately addressed, or the prompt has been misunderstood. No relevant position can be identified, and/or there is little direct response to the question/s. There are few ideas, and these may be irrelevant or insufficiently developed.\n\n- Band 4: The prompt is tackled in a minimal way, or the answer is tangential, possibly due to some misunderstanding of the prompt. The format may be inappropriate. A position is discernible, but the reader has to read carefully to find it. Main ideas are difficult to identify and such ideas that are identifiable may lack relevance, clarity and/or support. Large parts of the response may be repetitive.\n\n- Band 5: The main parts of the prompt are incompletely addressed. The format may be inappropriate in places. The writer expresses a position, but the development is not always clear. Some main ideas are put forward, but they are limited and are not sufficiently developed and/or there may be irrelevant detail. There may be some repetition.\n\n- Band 6: The main parts of the prompt are addressed (though some may be more fully covered than others). An appropriate format is used. A position is presented that is directly relevant to the prompt, although the conclusions drawn may be unclear, unjustified or repetitive. Main ideas are relevant, but some may be insufficiently developed or may lack clarity, while some supporting arguments and evidence may be less relevant or inadequate.\n\n- Band 7: The main parts of the prompt are appropriately addressed. A clear and developed position is presented. Main ideas are extended and supported but there may be a tendency to over generalize or there may be a lack of focus and precision in supporting ideas/material.\n\n- Band 8: The prompt is appropriately and sufficiently addressed. A clear and well-developed position is presented in response to the question/s. Ideas are relevant, well extended and supported. There may be occasional omissions or lapses in content.\n\n- Band 9: The prompt is appropriately addressed and explored in depth. A clear and fully developed position is presented which directly answers the question/s. Ideas are relevant, fully extended and well supported. Any lapses in content or support are extremely rare.\n\n2. Coherence & Cohesion\n2.1. Criteria Description\nThe Coherence & Cohesion criterion in IELTS Academic Writing Task 2 evaluates your ability to organize ideas logically and connect them smoothly. It focuses on clear overall structure, logical sequencing of paragraphs and ideas, and the effective use of cohesive devices (such as linking words and pronouns) to guide the reader through your argument or narrative seamlessly.\n\n2.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. The writing fails to communicate any message and appears to be by a virtual non writer.\n\n- Band 2: There is little relevant message, or the entire response may be off topic. There is little evidence of control of organizational features.\n\n- Band 3: There is no apparent logical organization. Ideas are discernible but difficult to relate to each other. There is minimal use of sequencers or cohesive devices. Those used do not necessarily indicate a logical relationship between ideas. There is difficulty in identifying referencing. Any attempts at paragraphing are unhelpful.\n\n- Band 4: Information and ideas are evident but not arranged coherently and there is no clear progression within the response. Relationships between ideas can be unclear and/or inadequately marked. There is some use of basic cohesive devices, which may be inaccurate or repetitive. There is inaccurate use or a lack of substitution or referencing. There may be no paragraphing and/or no clear main topic within paragraphs.\n\n- Band 5: Organization is evident but is not wholly logical and there may be a lack of overall progression. Nevertheless, there is a sense of underlying coherence to the response. The relationship of ideas can be followed but the sentences are not fluently linked to each other. There may be limited/overuse of cohesive devices with some inaccuracy. The writing may be repetitive due to inadequate and/or inaccurate use of reference and substitution. Paragraphing may be inadequate or missing.\n\n- Band 6: Information and ideas are generally arranged coherently and there is a clear overall progression. Cohesive devices are used to some good effect but cohesion within and/or between sentences may be faulty or mechanical due to misuse, overuse or omission. The use of reference and substitution may lack flexibility or clarity and result in some repetition or error. Paragraphing may not always be logical and/or the central topic may not always be clear.\n\n- Band 7: Information and ideas are logically organized, and there is a clear progression throughout the response. (A few lapses may occur, but these are minor). A range of cohesive devices including reference and substitution is used flexibly but with some inaccuracies or some over/under use. Paragraphing is generally used effectively to support overall coherence, and the sequencing of ideas within a paragraph is generally logical.\n\n- Band 8: The message can be followed with ease. Information and ideas are logically sequenced, and cohesion is well managed. Occasional lapses in coherence and cohesion may occur. Paragraphing is used sufficiently and appropriately.\n\n- Band 9: The message can be followed effortlessly. Cohesion is used in such a way that it very rarely attracts attention. Any lapses in coherence or cohesion are minimal. Paragraphing is skillfully managed.\n\n3. Lexical Resource\n3.1. Criteria Description\nThe Lexical Resource criterion in IELTS Academic Writing Task 2 measures your range of vocabulary, the precision of your word choices, and your ability to use words appropriately for various contexts. It assesses your skill in using vocabulary flexibly and accurately to express ideas and opinions, including the effective use of synonyms and collocations, without errors that hinder communication.\n\n3.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: - Responses of 20 words or fewer are rated at Band 1. No resource is apparent, except for a few isolated words.\n\n- Band 2: The resource is extremely limited with few recognizable strings, apart from memorized phrases. There is no apparent control of word formation and/or spelling.\n\n- Band 3: The resource is inadequate (which may be due to the response being significantly under length). Possible over-dependence on input material or memorized language. Control of word choice and/or spelling is very limited, and errors predominate. These errors may severely impede meaning.\n\n- Band 4: The resource is limited and inadequate for or unrelated to the task. Vocabulary is basic and may be used repetitively. There may be inappropriate use of lexical chunks (e.g. memorized phrases, formulaic language and/or language from the input material). Inappropriate word choice and/or errors in word formation and/or in spelling may impede meaning.\n\n- Band 5: The resource is limited but minimally adequate for the task. Simple vocabulary may be used accurately but the range does not permit much variation in expression. There may be frequent lapses in the appropriacy of word choice and a lack of flexibility is apparent in frequent simplifications and/or repetitions. Errors in spelling and/or word formation may be noticeable and may cause some difficulty for the reader.\n\n- Band 6: The resource is generally adequate and appropriate for the task. The meaning is generally clear in spite of a rather restricted range or a lack of precision in word choice. If the writer is a risk-taker, there will be a wider range of vocabulary used but higher degrees of inaccuracy or inappropriacy. There are some errors in spelling and/or word formation, but these do not impede communication.\n\n- Band 7: The resource is sufficient to allow some flexibility and precision. There is some ability to use less common and/or idiomatic items. An awareness of style and collocation is evident, though inappropriacy occur. There are only a few errors in spelling and/or word formation and they do not detract from overall clarity.\n\n- Band 8: A wide resource is fluently and flexibly used to convey precise meanings. There is skillful use of uncommon and/or idiomatic items when appropriate, despite occasional inaccuracies in word choice and collocation. Occasional errors in spelling and/or word formation may occur but have minimal impact on communication.\n\n- Band 9: Full flexibility and precise use are widely evident. A wide range of vocabulary is used accurately and appropriately with very natural and sophisticated control of lexical features. Minor errors in spelling and word formation are extremely rare and have minimal impact on communication.\n\n4. Grammatical Range & Accuracy\n4.1. Criteria Description\nThe Grammatical Range & Accuracy criterion in IELTS Academic Writing Task 2 evaluates your ability to use a wide range of grammar structures accurately. It focuses on your capacity to construct complex sentences effectively, use punctuation correctly, and apply grammatical forms with flexibility to clearly express detailed reasoning and arguments without making errors that obscure meaning.\n\n4.2. Band Descriptors\n- Band 0: Should only be used where a candidate did not attend or attempt the question in any way, used a language other than English throughout, or where there is proof that a candidate’s answer has been totally memorized.\n\n- Band 1: Responses of 20 words or fewer are rated at Band 1. No rateable language is evident.\n\n- Band 2: There is little or no evidence of sentence forms (except in memorised phrases).\n\n- Band 3: Sentence forms are attempted, but errors in grammar and punctuation predominate (except in memorized phrases or those taken from the input material). This prevents most meaning from coming through. Length may be insufficient to provide evidence of control of sentence forms.\n\n- Band 4: A very limited range of structures is used. Subordinate clauses are rare and simple sentences predominate. Some structures are produced accurately but grammatical errors are frequent and may impede meaning. Punctuation is often faulty or inadequate.\n\n- Band 5: The range of structures is limited and rather repetitive. Although complex sentences are attempted, they tend to be faulty, and the greatest accuracy is achieved on simple sentences. Grammatical errors may be frequent and cause some difficulty for the reader. Punctuation may be faulty.\n\n- Band 6: A mix of simple and complex sentence forms is used but flexibility is limited. Examples of more complex structures are not marked by the same level of accuracy as in simple structures. Errors in grammar and punctuation occur, but rarely impede communication.\n\n- Band 7: A variety of complex structures is used with some flexibility and accuracy. Grammar and punctuation are generally well controlled, and error-free sentences are frequent. A few errors in grammar may persist, but these do not impede communication.\n\n- Band 8: A wide range of structures is flexibly and accurately used. The majority of sentences are error-free, and punctuation is well managed. Occasional, non-systematic errors and inappropriacy occur, but have minimal impact on communication.\n\n- Band 9: A wide range of structures is used with full flexibility and control. Punctuation and grammar are used appropriately throughout. Minor errors are extremely rare and have minimal impact on communication.\n\n</rubric>\n";
            string topic = "Given the following Academic Writing Task 2 topic delimited by <topic> and </topic> tags:\r\n\r\n<topic>" + question + "\r\n\r\n</topic>\r\n";
            string response = "Given the following writing response for the topic delimited by <response> and </response> tags:\r\n\r\n<response>\r\n" + essay + "\r\n</response>\r\n";
            // Try one promp approach first to save time
            // string prompt = "Cung cấp phản hồi cho bài luận sử dụng định dạng JSON. Đối tượng JSON chứa 5 thuộc tính có tên là taskResponse, coherence, lexicalResource, grammar và overallFeedback. 5 thuộc tính này chứa thôngt in như sau:\r\n\r\n1. Thuộc tính taskResponse chứa phản hồi cho bài luận cho tiêu chí Task Response sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Response dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Task Response, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n2. Thuộc tính coherence chứa phản hồi cho bài luận cho tiêu chí Coherence & Cohesion sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Coherence & Cohesion dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence & Cohesion, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n3. Thuộc tính lexicalResource chứa phản hồi cho bài luận cho tiêu chí Lexical Resource sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Lexical Resource dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Lexical Resource, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n4. Thuộc tính grammar chứa phản hồi cho bài luận cho tiêu chí Grammatical Range & Accuracy sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Grammatical Range & Accuracy dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Grammatical Range & Accuracy, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n5. Thuộc tính overallFeedback chứa phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận theo thang điểm từ 0 tới 9.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Response, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy.\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n\r\n";
            //string prompt = "Cung cấp phản hồi cho bài luận sử dụng định dạng JSON. Đối tượng JSON chứa 5 thuộc tính có tên là taskResponse, coherence, lexicalResource, grammar và overallFeedback. 5 thuộc tính này chứa thôngt in như sau:\r\n\r\n1. Thuộc tính taskResponse chứa phản hồi cho bài luận cho tiêu chí Task Response sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Response dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Task Response, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên. Phản hồi chứa ít nhất 50 từ.\r\n\r\n2. Thuộc tính coherence chứa phản hồi cho bài luận cho tiêu chí Coherence & Cohesion sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Coherence & Cohesion dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence & Cohesion, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên. Phản hồi chứa ít nhất 50 từ.\r\n\r\n3. Thuộc tính lexicalResource chứa phản hồi cho bài luận cho tiêu chí Lexical Resource sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Lexical Resource dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Lexical Resource, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên. Phản hồi chứa ít nhất 50 từ.\r\n\r\n4. Thuộc tính grammar chứa phản hồi cho bài luận cho tiêu chí Grammatical Range & Accuracy sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Grammatical Range & Accuracy dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Grammatical Range & Accuracy, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên. Phản hồi chứa ít nhất 50 từ.\r\n\r\n5. Thuộc tính overallFeedback chứa phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận theo thang điểm từ 0 tới 9.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Response, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy.\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục. Phản hồi chứa ít nhất 50 từ.\r\n";

            //if (feedbackLanguage != "vn")
            //    prompt = "Provide feedback for the essay using the JSON format. The JSON object contains 5 properties named taskResponse, coherence, lexicalResource, grammar, and overallFeedback. These 5 properties contain information as follows:\r\n\r\n1. The taskResponse property contains feedback for the essay on the Task Response criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Task Response criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about what the student did well in the essay for the Task Response criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Task Response criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Task Response criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n2. The coherence property contains feedback for the essay on the Coherence & Cohesion criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Coherence & Cohesion criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Coherence & Cohesion criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Coherence & Cohesion criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Coherence & Cohesion criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n3. The lexicalResource property contains feedback for the essay on the Lexical Resource criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Lexical Resource criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Lexical Resource criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Lexical Resource criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The Recommendations property: Provides guidance for students to improve their score for the Lexical Resource criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n4. The grammar property contains feedback for the essay on the Grammatical Range & Accuracy criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Grammatical Range & Accuracy criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\nThe strengths property: Contains feedback about the points that the student did well in the essay for the Grammatical Range & Accuracy criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback in Vietnamese about the points that the student did not do well in the essay for the Grammatical Range & Accuracy criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Grammatical Range & Accuracy criterion, including both general guidance and specific guidance for the provided writing topic. This guidance needs to be written in Vietnamese and must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n5. The overallFeedback property contains general feedback for the essay using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall score of the essay ranging from 0 to 9.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n- The performance property: Contains feedback about the overall performance of the essay. The feedback needs to provide an overall picture of the essay's quality spanning all four criteria: Task Response, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n- The strengths property: Contains feedback about the best aspects of the essay. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay. The feedback needs to pinpoint and detail the points that need attention and improvement the most. Emphasize aspects that, if refined, would significantly enhance the quality and score of the essay.\r\n- The recommendations property: Provides general guidance for students to improve their essay scores. This guidance needs include constructive advice, encouraging practice, and continuous improvement.\r\n";

            //var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
            //{
            //    Model = Model.GPT4_Turbo,
            //    Temperature = 0.1,
            //    MaxTokens = 4096,
            //    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
            //    Messages = new ChatMessage[] {
            //            new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
            //            new ChatMessage(ChatMessageRole.Assistant, task2Rubric),
            //            new ChatMessage(ChatMessageRole.Assistant, topic),
            //            new ChatMessage(ChatMessageRole.Assistant, response),
            //            new ChatMessage(ChatMessageRole.User, prompt)
            //        }
            //});
            //IELTSTask2FeedbackModel feedback = JsonConvert.DeserializeObject<IELTSTask2FeedbackModel>(result.Choices[0].Message.TextContent);

            //return feedback;
            try
            {
                // Try multi-promps approach first
                string taskResponse = "Cung cấp phản hồi cho bài luận cho tiêu chí Task Response sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Response dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Task Response, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    taskResponse = "Provide feedback for the essay on the Task Response criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Task Response criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Task Response criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Task Response criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Task Response criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";

                var taskResponseResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task2Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, taskResponse)
                }
                });
                AutomatedFeedbackModel taskResponseFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(taskResponseResult.Choices[0].Message.TextContent);


                string coherence = "Cung cấp phản hồi cho bài luận cho tiêu chí Coherence & Cohesion sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Coherence & Cohesion dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence & Cohesion, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    coherence = "Provide feedback for the essay on the Coherence & Cohesion criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Coherence & Cohesion criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Coherence & Cohesion criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Coherence & Cohesion criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Coherence & Cohesion criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";

                var coherenceResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task2Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, coherence)
                }
                });
                AutomatedFeedbackModel coherenceFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(coherenceResult.Choices[0].Message.TextContent);

                string lexicalResource = "Cung cấp phản hồi cho bài luận cho tiêu chí Lexical Resource sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Lexical Resource dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Lexical Resource, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    lexicalResource = "Provide feedback for the essay on the Lexical Resource criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Lexical Resource criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Lexical Resource criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Lexical Resource criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Lexical Resource criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";

                var lexicalResourceResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task2Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, lexicalResource)
                }
                });
                AutomatedFeedbackModel lexicalResourceFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(lexicalResourceResult.Choices[0].Message.TextContent);

                string grammar = "Cung cấp phản hồi cho bài luận cho tiêu chí Grammatical Range & Accuracy sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Grammatical Range & Accuracy dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Grammatical Range & Accuracy, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n";

                if (feedbackLanguage != "vn")
                    grammar = "Provide feedback for the essay on the Grammatical Range & Accuracy criterion using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Grammatical Range & Accuracy criterion based on the provided band descriptors. The feedback property is an object that contains 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback as a string about the aspects the student has performed well in the essay for the Grammatical Range & Accuracy criterion. For each strength, the feedback should explain why it is a strength, list specific examples from the essay, and encourage the student to further develop those strengths.\r\n- The weaknesses property: Contains feedback as a string about the aspects the student has not done well in the essay for the Grammatical Range & Accuracy criterion. For each weakness, the feedback should explain why it is a weakness, provide specific examples from the essay, and offer specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance to help students improve their score for the Grammatical Range & Accuracy criterion, including both general advice and specific instructions for the given writing topic. This guidance must provide specific steps to help the student progress in the most effective way based on their current ability and the provided essay.\r\n";

                var grammarResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task2Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, grammar)
                }
                });
                AutomatedFeedbackModel grammarFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(grammarResult.Choices[0].Message.TextContent);
                //string overallScore = "được tính dựa vào điểm của 4 tiêu chí đã được chấm trước như sau: Task Response: " + taskResponseFeedback.score.ToString() + ", Coherence & Cohesion: " + coherenceFeedback.score.ToString() + ", Lexical Resource: " + lexicalResourceFeedback.score.ToString() + ", Grammatical Range & Accuracy: " + grammarFeedback.score.ToString();
                //if (feedbackLanguage != "vn")
                //    overallScore = "given the scores for the 4 criterion are: Task Response: " + taskResponseFeedback.score.ToString() + ", Coherence & Cohesion: " + coherenceFeedback.score.ToString() + ", Lexical Resource: " + lexicalResourceFeedback.score.ToString() + ", Grammatical Range & Accuracy: " + grammarFeedback.score.ToString();

                string overall = "Cung cấp phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm tổng quát của bài viết được chấm theo thang điểm từ 0 tới 9.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Response, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n";

                if (feedbackLanguage != "vn")
                    overall = "Provide overall feedback for the essay using the JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall band score of the essay ranging from 0 to 9.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n\r\n- The performance property: Contains feedback about the overall quality of the writing. The feedback should provide a comprehensive overview of the essay, covering all four criteria: Task Response, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n- The strengths property: Contains feedback about the aspects the essay performs best at. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop these aspects.\r\n- The weaknesses property: Contains feedback about the aspects the student needs to improve in the essay. The feedback should point out and describe in detail the areas that require attention and improvement the most. Emphasize the aspects that, if refined, would significantly enhance the quality and score of the writing.\r\n- The recommendations property: Provides general guidance for the student to improve their essay score. This guidance must include constructive advice, encouraging continuous practice and improvement.\r\n";

                var overallResult = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 1000,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                    new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                    new ChatMessage(ChatMessageRole.Assistant, task2Rubric),
                    new ChatMessage(ChatMessageRole.Assistant, topic),
                    new ChatMessage(ChatMessageRole.Assistant, response),
                    new ChatMessage(ChatMessageRole.User, overall)
                }
                });
                AutomatedFeedbackModel overallFeedback = JsonConvert.DeserializeObject<AutomatedFeedbackModel>(overallResult.Choices[0].Message.TextContent);


                IELTSTask2FeedbackModel feedback = new IELTSTask2FeedbackModel
                {
                    taskResponse = taskResponseFeedback,
                    coherence = coherenceFeedback,
                    lexicalResource = lexicalResourceFeedback,
                    grammar = grammarFeedback,
                    overallFeedback = overallFeedback
                };

                return feedback;
            }
            catch (Exception e)
            {
                // Try one promp approach first to save time
                // string prompt = "Cung cấp phản hồi cho bài luận sử dụng định dạng JSON. Đối tượng JSON chứa 5 thuộc tính có tên là taskResponse, coherence, lexicalResource, grammar và overallFeedback. 5 thuộc tính này chứa thôngt in như sau:\r\n\r\n1. Thuộc tính taskResponse chứa phản hồi cho bài luận cho tiêu chí Task Response sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Response dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Task Response, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n2. Thuộc tính coherence chứa phản hồi cho bài luận cho tiêu chí Coherence & Cohesion sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Coherence & Cohesion dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence & Cohesion, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n3. Thuộc tính lexicalResource chứa phản hồi cho bài luận cho tiêu chí Lexical Resource sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Lexical Resource dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Lexical Resource, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n4. Thuộc tính grammar chứa phản hồi cho bài luận cho tiêu chí Grammatical Range & Accuracy sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Grammatical Range & Accuracy dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Grammatical Range & Accuracy, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên.\r\n\r\n5. Thuộc tính overallFeedback chứa phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận theo thang điểm từ 0 tới 9.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Response, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy.\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục.\r\n\r\n";
                string prompt = "Cung cấp phản hồi cho bài luận sử dụng định dạng JSON. Đối tượng JSON chứa 5 thuộc tính có tên là taskResponse, coherence, lexicalResource, grammar và overallFeedback. 5 thuộc tính này chứa thôngt in như sau:\r\n\r\n1. Thuộc tính taskResponse chứa phản hồi cho bài luận cho tiêu chí Task Response sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Task Response dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Task Response. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Task Response, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên. Phản hồi chứa ít nhất 50 từ.\r\n\r\n2. Thuộc tính coherence chứa phản hồi cho bài luận cho tiêu chí Coherence & Cohesion sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Coherence & Cohesion dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Coherence & Cohesion. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Coherence & Cohesion, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên. Phản hồi chứa ít nhất 50 từ.\r\n\r\n3. Thuộc tính lexicalResource chứa phản hồi cho bài luận cho tiêu chí Lexical Resource sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Lexical Resource dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Lexical Resource. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Lexical Resource, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên. Phản hồi chứa ít nhất 50 từ.\r\n\r\n4. Thuộc tính grammar chứa phản hồi cho bài luận cho tiêu chí Grammatical Range & Accuracy sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận cho tiêu chí Grammatical Range & Accuracy dựa theo band descriptors đã cung cấp. Thuộc tính feedback là 1 đối tượng chứa 3 thuộc tính có tên lần lượt là strengths, weaknesses, và recommendations. Ba thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà học viên đã làm tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm mạnh, phản hồi cần phải giải thích tại sao đó là điểm manh, liệt kê các ví dụ cụ thể tương ứng ở trong bài viết, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận cho tiêu chí Grammatical Range & Accuracy. Cho mỗi điểm chưa làm tốt, phản hồi cần phải giải thích tại sao điểm đó lại chưa tốt, liệt kê ra những ví dụ cụ thể tương ứng trong bài viết, và đưa ra khuyến nghị cụ thể cho từng điểm. Nếu điểm chưa làm tốt là một lỗi viết cụ thể, cung cấp cách sửa lại cho đúng. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn để học viên có thể cải thiện điểm số của mình cho tiêu chí Grammatical Range & Accuracy, bao gồm cả những hướng dẫn chung và những hướng dẫn cụ thể cho chủ đề viết đã được cung cấp. Hướng dẫn này cần được viết bằng tiếng Việt và phải cung cấp các bước cụ thể để giúp học viên tiến bộ một cách hiệu quả nhất dựa vào năng lực hiện tại và bài viết của học viên. Phản hồi chứa ít nhất 50 từ.\r\n\r\n5. Thuộc tính overallFeedback chứa phản hồi tổng quát cho bải luận sử dụng định dạng JSON. Đối tượng JSON chứa 2 thuộc tính có tên là score và feedback. Thuộc tính score là điểm của bài luận theo thang điểm từ 0 tới 9.0. Thuộc tính feedback là 1 đối tượng chứa bốn thuộc tính có tên lần lượt là performance, strengths, weaknesses, và recommendations. Bốn thuộc tính này chứa thông tin như sau:\r\n\r\n- Thuộc tính performance: Chứa phản hồi bằng tiếng việt về tổng quan của bài viết. Phản hồi cần cung cấp một bức tranh toàn cảnh về chất lượng của bài viết dàn chải qua cả bốn tiêu chí Task Response, Coherence & Cohesion, Lexical Resource, và Grammatical Range & Accuracy.\r\n- Thuộc tính strenghs: Chứa phản hồi bằng tiếng việt về những điểm mà bài luận làm tốt nhất. Phản hồi cần xác định, tóm tắt những điểm mạnh nổi bật, và khuyến khích học viên phát triển hơn những điểm đó. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính weaknesses: Chứa phản hồi bằng tiếng việt về những điểm mà học viên làm chưa tốt trong bài luận. Phản hồi cần chỉ ra và mô tả chỉ tiết về những điểm vần được chú ý và cải thiện nhất. Nhấn mạnh những khía cạnh mà nếu được tinh chỉnh, sẽ giúp nâng cao đáng kể chất lượng và điểm số của bài viết. Phản hồi chứa ít nhất 50 từ.\r\n- Thuộc tính recommendations: Cung cấp hướng dẫn chung để học viên có thể cải thiện điểm số cho bài viết của mình. Hướng dẫn này cần được viết bằng tiếng Việt và phải bao gồm những lời khuyên mang tính xây dựng, khuyến khích sự luyện tập và cải thiện liên tục. Phản hồi chứa ít nhất 50 từ.\r\n";

                if (feedbackLanguage != "vn")
                    prompt = "Provide feedback for the essay using the JSON format. The JSON object contains 5 properties named taskResponse, coherence, lexicalResource, grammar, and overallFeedback. These 5 properties contain information as follows:\r\n\r\n1. The taskResponse property contains feedback for the essay on the Task Response criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Task Response criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about what the student did well in the essay for the Task Response criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Task Response criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Task Response criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n2. The coherence property contains feedback for the essay on the Coherence & Cohesion criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Coherence & Cohesion criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Coherence & Cohesion criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Coherence & Cohesion criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Coherence & Cohesion criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n3. The lexicalResource property contains feedback for the essay on the Lexical Resource criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Lexical Resource criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\n\r\n- The strengths property: Contains feedback about the points that the student did well in the essay for the Lexical Resource criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay for the Lexical Resource criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The Recommendations property: Provides guidance for students to improve their score for the Lexical Resource criterion, including both general guidance and specific guidance for the provided writing topic. This guidance must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n4. The grammar property contains feedback for the essay on the Grammatical Range & Accuracy criterion using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the essay's score for the Grammatical Range & Accuracy criterion based on the provided descriptors. The feedback property is an object containing 3 properties named strengths, weaknesses, and recommendations. These three properties contain information as follows:\r\nThe strengths property: Contains feedback about the points that the student did well in the essay for the Grammatical Range & Accuracy criterion. For each strength, the feedback needs to explain why it is a strength, list specific examples corresponding in the essay, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback in Vietnamese about the points that the student did not do well in the essay for the Grammatical Range & Accuracy criterion. For each weakness, the feedback needs to explain why it is a weakness, list specific examples corresponding in the essay, and provide specific recommendations for each point. If the weakness is a specific writing error, provide the correct way to fix it.\r\n- The recommendations property: Provides guidance for students to improve their score for the Grammatical Range & Accuracy criterion, including both general guidance and specific guidance for the provided writing topic. This guidance needs to be written in Vietnamese and must provide specific steps to help the student progress most effectively based on their current abilities and the essay.\r\n\r\n5. The overallFeedback property contains general feedback for the essay using JSON format. The JSON object contains 2 properties named score and feedback. The score property is the overall score of the essay ranging from 0 to 9.0. The feedback property is an object containing four properties named performance, strengths, weaknesses, and recommendations. These four properties contain information as follows:\r\n- The performance property: Contains feedback about the overall performance of the essay. The feedback needs to provide an overall picture of the essay's quality spanning all four criteria: Task Response, Coherence & Cohesion, Lexical Resource, and Grammatical Range & Accuracy.\r\n- The strengths property: Contains feedback about the best aspects of the essay. The feedback needs to identify, summarize the standout strengths, and encourage the student to further develop those points.\r\n- The weaknesses property: Contains feedback about the points that the student did not do well in the essay. The feedback needs to pinpoint and detail the points that need attention and improvement the most. Emphasize aspects that, if refined, would significantly enhance the quality and score of the essay.\r\n- The recommendations property: Provides general guidance for students to improve their essay scores. This guidance needs include constructive advice, encouraging practice, and continuous improvement.\r\n";

                var result = await api.Chat.CreateChatCompletionAsync(new ChatRequest()
                {
                    Model = Model.GPT4_Turbo,
                    Temperature = 0.1,
                    MaxTokens = 4096,
                    ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                    Messages = new ChatMessage[] {
                        new ChatMessage(ChatMessageRole.System, "You are a helpful assistant designed to output JSON."),
                        new ChatMessage(ChatMessageRole.Assistant, task2Rubric),
                        new ChatMessage(ChatMessageRole.Assistant, topic),
                        new ChatMessage(ChatMessageRole.Assistant, response),
                        new ChatMessage(ChatMessageRole.User, prompt)
                    }
                });
                IELTSTask2FeedbackModel feedback = JsonConvert.DeserializeObject<IELTSTask2FeedbackModel>(result.Choices[0].Message.TextContent);

                return feedback;
            }

        }
    }
}

